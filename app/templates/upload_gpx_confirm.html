{# --- CORREZIONE: Estende il template di base, non la homepage --- #}
{% extends "base.html" %}
{% block title %}Conferma Dati GPX - PeakRankStreet{% endblock %}

{% block content %}
<div class="container my-5 pt-5">
    <div class="text-center mb-5">
        <h1 class="display-5 fw-bold"><i class="bi bi-file-earmark-check me-2"></i>Revisiona il tuo Tracciato GPX</h1>
        <p class="lead text-muted">Verifica i dettagli estratti dal tuo file GPX e salvalo come attività o nuovo percorso!</p>
    </div>

    <div class="row justify-content-center">
        <div class="col-md-10 col-lg-8">
            
            <div class="card shadow-lg mb-4 border-primary">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="bi bi-info-circle me-2"></i>Dati Estratti</h4>
                </div>
                <div class="card-body p-4">
                    <form id="saveGpxItemForm"> 
                        <input type="hidden" id="gpxFilename" name="filename" value="{{ filename }}">
                        <input type="hidden" id="gpxPointsJson" name="points_json" value="{{ gpx_points_json }}">
                        <input type="hidden" id="gpxDistance" name="distance" value="{{ '%.2f'|format(distance_km) if distance_km else 'N/D' }}">
                        <input type="hidden" id="gpxDuration" name="duration" value="{{ duration_sec }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                        <div class="row g-3">
                            <div class="col-md-7">
                                <label for="name" class="form-label fw-bold">Nome Attività/Percorso*</label>
                                <input type="text" class="form-control" id="name" name="name" value="{{ filename.rsplit('.', 1)[0]|replace('_', ' ')|title }}" required> 
                            </div>
                            <div class="col-md-5">
                                <label for="activity_type" class="form-label fw-bold">Tipo Attività*</label>
                                <select class="form-select" id="activity_type" name="activity_type" required>
                                    <option value="" disabled selected>Seleziona...</option>
                                    <option value="Corsa" {% if 'run' in filename.lower() or 'corsa' in filename.lower() %}selected{% endif %}>Corsa</option>
                                    <option value="Bici" {% if 'bike' in filename.lower() or 'bici' in filename.lower() %}selected{% endif %}>Bici</option>
                                    <option value="Hike" {% if 'hike' in filename.lower() or 'trek' in filename.lower() %}selected{% endif %}>Hike</option>
                                    <option value="Sci" {% if 'ski' in filename.lower() %}selected{% endif %}>Sci</option>
                                    <option value="Altro">Altro</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row g-3 mt-3 text-center bg-light p-3 rounded">
                            <div class="col-4">
                                <label class="form-label fw-bold">Distanza</label>
                                <div class="h4" id="displayDistance">N/D</div>
                                <small class="text-muted">km</small>
                            </div>
                            <div class="col-4">
                                <label class="form-label fw-bold">Durata</label>
                                <div class="h4" id="displayDuration">N/D</div>
                                <small class="text-muted">HH:MM:SS</small>
                            </div>
                             <div class="col-4">
                                <label class="form-label fw-bold">Punti</label>
                                <div class="h4" id="displayPointsCount">N/D</div>
                                <small class="text-muted">tracciati</small>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <label class="form-label fw-bold">Anteprima Mappa</label>
                            <div id="gpxMapPreview" style="height: 300px; background-color: #f8f9fa;" class="rounded border"></div>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card shadow-lg mb-4 border-warning">
                <div class="card-header bg-warning text-dark">
                    <h4 class="mb-0"><i class="bi bi-tools me-2"></i>Azioni Disponibili</h4>
                </div>
                <div class="card-body text-center p-4">
                    <p class="text-muted">Cosa vuoi fare con questo tracciato?</p>
                    <div class="d-grid gap-3 d-md-flex justify-content-md-center">
                        <button id="saveActivityBtn" class="btn btn-lg btn-primary">
                            <i class="bi bi-activity me-2"></i>Salva come Attività
                        </button>
                        <button id="saveRouteBtn" class="btn btn-lg btn-secondary">
                            <i class="bi bi-map-fill me-2"></i>Salva come Nuovo Percorso
                        </button>
                    </div>
                    
                    <div id="createChallengeSection" style="display: none;" class="mt-4 pt-4 border-top">
                        <p class="fw-bold text-success">Ottimo! Ora puoi creare una sfida basata su questo percorso.</p>
                        <button type="button" id="createChallengeFromGPXBtn" class="btn btn-lg btn-success">
                            <i class="bi bi-award-fill me-2"></i>Crea una Sfida
                        </button>
                    </div>
                    
                    <div id="savingInfo" style="display: none;" class="alert alert-info mt-3">Salvataggio in corso...</div>
                    <div id="saveError" style="display: none;" class="alert alert-danger mt-3"></div>
                    <div id="saveSuccess" style="display: none;" class="alert alert-success mt-3"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<!-- Assicurati che Leaflet sia caricato (idealmente in base.html) -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Elementi del DOM ---
        const gpxPointsJsonInput = document.getElementById('gpxPointsJson');
        const gpxDistanceInput = document.getElementById('gpxDistance');
        const gpxDurationInput = document.getElementById('gpxDuration');
        const displayDistanceDiv = document.getElementById('displayDistance');
        const displayDurationDiv = document.getElementById('displayDuration');
        const displayPointsCountDiv = document.getElementById('displayPointsCount');
        const saveActivityBtn = document.getElementById('saveActivityBtn');
        const saveRouteBtn = document.getElementById('saveRouteBtn');
        const createChallengeBtn = document.getElementById('createChallengeFromGPXBtn');
        const createChallengeSection = document.getElementById('createChallengeSection');
        const savingInfoDiv = document.getElementById('savingInfo');
        const saveErrorDiv = document.getElementById('saveError');
        const saveSuccessDiv = document.getElementById('saveSuccess');

        // --- Funzione helper per formattare la durata ---
        function formatDuration(seconds) {
            if (seconds === null || isNaN(seconds) || seconds <= 0) return "N/D";
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        }

        // --- Inizializzazione Dati e Mappa ---
        try {
            const points = JSON.parse(gpxPointsJsonInput.value);
            const map = L.map('gpxMapPreview').setView([41.9, 12.5], 6);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 }).addTo(map);

            if (points && points.length > 0) {
                const latlngs = points.map(p => [p.lat, p.lon]);
                L.polyline(latlngs, { color: 'blue' }).addTo(map);
                map.fitBounds(L.latLngBounds(latlngs));
                displayPointsCountDiv.textContent = points.length;
            } else {
                displayPointsCountDiv.textContent = '0';
            }

            displayDurationDiv.textContent = formatDuration(parseInt(gpxDurationInput.value, 10));
            displayDistanceDiv.textContent = gpxDistanceInput.value || 'N/D';
        } catch (e) {
            console.error("Errore inizializzazione:", e);
            saveErrorDiv.textContent = "Errore nell'inizializzazione della pagina.";
            saveErrorDiv.style.display = 'block';
        }

        // --- Funzione per il Salvataggio (AJAX) ---
        async function saveItem(itemType) {
            savingInfoDiv.style.display = 'block';
            saveErrorDiv.style.display = 'none';
            saveSuccessDiv.style.display = 'none';
            saveActivityBtn.disabled = true;
            saveRouteBtn.disabled = true;

            const formData = new FormData(document.getElementById('saveGpxItemForm'));
            const data = Object.fromEntries(formData.entries());
            data.item_type = itemType;

            try {
                const response = await fetch("{{ url_for('main.save_gpx_item') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': data.csrf_token },
                    body: JSON.stringify(data)
                });
                const result = await response.json();

                if (result.status === 'success') {
                    saveSuccessDiv.textContent = result.message;
                    saveSuccessDiv.style.display = 'block';
                    createChallengeSection.style.display = 'block';
                    createChallengeBtn.dataset.itemId = result.item_id;
                    createChallengeBtn.dataset.itemType = itemType;
                } else {
                    throw new Error(result.message || 'Errore sconosciuto.');
                }
            } catch (error) {
                saveErrorDiv.textContent = `Errore: ${error.message}`;
                saveErrorDiv.style.display = 'block';
                saveActivityBtn.disabled = false;
                saveRouteBtn.disabled = false;
            } finally {
                savingInfoDiv.style.display = 'none';
            }
        }

        // --- Event Listeners ---
        saveActivityBtn.addEventListener('click', () => saveItem('activity'));
        saveRouteBtn.addEventListener('click', () => saveItem('route'));
        createChallengeBtn.addEventListener('click', () => {
            const { itemId, itemType } = createChallengeBtn.dataset;
            if (itemId && itemType) {
                window.location.href = `{{ url_for('main.create_challenge') }}?item_id=${itemId}&item_type=${itemType}`;
            }
        });
    });
</script>
{% endblock %}