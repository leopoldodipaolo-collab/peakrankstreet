{# --- CORREZIONE: Estende il template di base, non la homepage --- #}
{% extends "base.html" %}

{% block title %}Tracciamento Live{% endblock %}

{% block content %}
<meta name="csrf-token" content="{{ csrf_token() }}">

<!-- Splash Screen -->
<div id="welcomeSplash" class="splash-screen vh-100 d-flex align-items-center justify-content-center">
  <div class="splash-content text-center">
    <div class="spinner-grow text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
      <span class="visually-hidden">Caricamento...</span>
    </div>
    <h3 class="text-white">Preparazione Tracciamento</h3>
    <p class="text-white-50">Ottimizzazione segnale GPS...</p>
    <div class="progress mt-3 mx-auto w-75" style="height: 8px;">
      <div class="progress-bar progress-bar-striped progress-bar-animated bg-info" style="width: 100%"></div>
    </div>
  </div>
</div>

<div class="container-fluid my-3 pt-4">
  <div class="row justify-content-center">
    <div class="col-12">

      <!-- Header con Controlli -->
      <div class="text-center mb-4 position-relative d-flex justify-content-center align-items-center">
        <div class="position-absolute top-0 end-0 me-2">
          <button class="btn btn-sm btn-outline-secondary me-2 rounded-circle" id="darkModeToggle" aria-label="Toggle Dark Mode">
            <span class="light-icon">üåô</span>
            <span class="dark-icon d-none">‚òÄÔ∏è</span>
          </button>
          <button class="btn btn-sm btn-outline-primary rounded-circle" data-bs-toggle="modal" data-bs-target="#settingsModal" aria-label="Impostazioni">‚öôÔ∏è</button>
        </div>
        <h1 class="display-6 fw-bold text-primary mb-0">üèÉ Traccia la tua Attivit√†</h1>
      </div>

      <!-- Indicatori di Stato -->
      <div class="status-indicators d-flex justify-content-center flex-wrap gap-2 mb-3 text-center">
        <span class="badge rounded-pill bg-secondary" id="statusBadge">üü¢ Pronto</span>
        <span class="badge rounded-pill bg-danger" id="gpsStatus">üì° GPS: Non Disponibile</span>
        <span class="badge rounded-pill bg-info" id="accuracyStatus">üéØ Precisione: --</span>
        <span class="badge rounded-pill bg-warning text-dark" id="batteryStatus">üîã Batteria: --</span>
      </div>

      <!-- Selezione Percorso -->
      <div class="card mb-3 rounded-4 shadow-sm tracking-card">
        <div class="card-header bg-white">
          <h5 class="mb-0 fs-6"><i class="bi bi-signpost-split-fill me-2 text-primary"></i> Percorso (Opzionale)</h5>
        </div>
        <div class="card-body p-2">
          <select class="form-select form-select-sm rounded-3" id="routeSelect" aria-label="Seleziona Percorso">
            <option value="">üéØ Modalit√† Libera</option>
            {% for route in routes %}
            <option value="{{ route.id }}" data-distance="{{ route.distance or 0 }}">
              üìç {{ route.name }} {% if route.distance %}({{ "%.1f"|format(route.distance) }} km){% endif %}
            </option>
            {% endfor %}
          </select>
        </div>
      </div>

      <!-- Pannello Tracking -->
      <div class="card shadow-lg rounded-4 tracking-card vh-75 d-flex flex-column">
        <div class="card-header bg-primary text-white rounded-top-4">
          <h5 class="mb-0 fs-5 py-1"><i class="bi bi-broadcast-pin me-2"></i> Tracciamento Live</h5>
        </div>
        <div class="card-body text-center p-3 flex-grow-1 d-flex flex-column justify-content-center align-items-center">

          <button id="btnStart" class="btn btn-success btn-lg mb-3 rounded-pill w-75 shadow-sm fs-5">
            ‚ñ∂Ô∏è INIZIA
          </button>

          <div id="autoStartMessage" class="alert alert-info rounded-3 w-100 mb-3 p-2 d-none" role="alert">
            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
            <strong>Avvio GPS...</strong>
          </div>

          <div id="liveStats" class="w-100 d-none flex-column">
            <div class="row mb-3 g-2">
              <div class="col-6"><div class="stat-box-mobile pulse-animation"><div class="stat-value text-primary" id="timer">00:00:00</div><div class="stat-label">TEMPO</div></div></div>
              <div class="col-6"><div class="stat-box-mobile"><div class="stat-value text-success" id="distance">0.00</div><div class="stat-label">DIST (KM)</div></div></div>
            </div>
            <div class="row mb-3 g-2">
              <div class="col-6"><div class="stat-box-mobile"><div class="stat-value text-warning" id="pace">0:00</div><div class="stat-label">RITMO (MIN/KM)</div></div></div>
              <div class="col-6"><div class="stat-box-mobile"><div class="stat-value text-info" id="speed">0.0</div><div class="stat-label">VEL (KM/H)</div></div></div>
            </div>

            <div class="row mb-2 g-2" id="advancedStats" style="display:none;">
              <div class="col-4"><div class="stat-box-sm"><div class="stat-value-sm text-danger" id="calories">0</div><div class="stat-label-sm">CAL</div></div></div>
              <div class="col-4"><div class="stat-box-sm"><div class="stat-value-sm text-purple" id="elevation">+0m</div><div class="stat-label-sm">SALITA</div></div></div>
              <div class="col-4"><div class="stat-box-sm"><div class="stat-value-sm text-orange" id="efficiency">--</div><div class="stat-label-sm">EFF</div></div></div>
            </div>

            <div class="splits-container mb-3 w-100" id="splitsContainer" style="display:none;">
              <h6 class="text-muted mb-2 fs-7">üéØ ULTIMO SPLIT</h6>
              <div class="split-card d-flex justify-content-between align-items-center p-2">
                <span id="lastSplitKm" class="fs-7">1km</span>
                <span id="lastSplitTime" class="fs-7">00:00:00</span>
                <span id="lastSplitPace" class="fs-7">0:00/km</span>
              </div>
            </div>

            <div class="progress mb-3 w-100 d-none" id="routeProgress" style="height: 20px;">
              <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" style="width:0%">
                <span class="progress-text fs-8">0%</span>
              </div>
            </div>

            <div id="miniMap" class="mb-3 rounded-3 border shadow-sm w-100 flex-grow-1" style="min-height: 250px;"></div>
          </div>

          <div class="tracking-controls mt-auto pt-3 d-flex justify-content-center w-100">
  <button id="btnPause" class="btn btn-warning btn-lg rounded-pill me-2 flex-grow-1 d-none">‚è∏Ô∏è PAUSA</button>
  <button id="btnStop" class="btn btn-danger btn-lg rounded-pill flex-grow-1 d-none">‚èπÔ∏è FERMA</button>
</div>

          <div id="statusMessage" class="mt-3 w-100"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Istruzioni GPS -->
<div class="modal fade" id="gpsInstructionsModal" tabindex="-1" aria-labelledby="gpsInstructionsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow">
      <div class="modal-header bg-warning rounded-top-4">
        <h5 class="modal-title" id="gpsInstructionsModalLabel">‚ö†Ô∏è Abilita il GPS</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
      </div>
      <div class="modal-body">
        <p>Per tracciare la tua attivit√†, abilita la posizione GPS nel tuo browser.</p>
        <div class="accordion" id="gpsAccordion">
          <div class="accordion-item">
            <h6 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#chromeHelp" aria-expanded="false" aria-controls="chromeHelp">
                üåê Chrome
              </button>
            </h6>
            <div id="chromeHelp" class="accordion-collapse collapse" data-bs-parent="#gpsAccordion">
              <div class="accordion-body small">
                1. Clicca sull'icona üîí a sinistra della barra URL.<br>
                2. Trova "Posizione" e seleziona "Consenti".<br>
                3. Ricarica la pagina.
              </div>
            </div>
          </div>
          <div class="accordion-item">
            <h6 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#firefoxHelp" aria-expanded="false" aria-controls="firefoxHelp">
                ü¶ä Firefox
              </button>
            </h6>
            <div id="firefoxHelp" class="accordion-collapse collapse" data-bs-parent="#gpsAccordion">
              <div class="accordion-body small">
                1. Clicca sull'icona a sinistra della barra URL.<br>
                2. Seleziona "Consenti condivisione posizione".<br>
                3. Ricarica la pagina.
              </div>
            </div>
          </div>
          <div class="accordion-item">
            <h6 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#safariHelp" aria-expanded="false" aria-controls="safariHelp">
                üçé Safari
              </button>
            </h6>
            <div id="safariHelp" class="accordion-collapse collapse" data-bs-parent="#gpsAccordion">
              <div class="accordion-body small">
                1. Vai su Preferenze ‚Üí Sito Web ‚Üí Posizione.<br>
                2. Imposta "Consenti" per questo sito.<br>
                3. Ricarica la pagina.
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary rounded-pill w-100" data-bs-dismiss="modal">Ho capito!</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Riepilogo Attivit√† -->
<div class="modal fade" id="activitySummaryModal" tabindex="-1" aria-labelledby="activitySummaryModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow">
      <div class="modal-header bg-success text-white rounded-top-4">
        <h5 class="modal-title" id="activitySummaryModalLabel">üìä Riepilogo Attivit√†</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
      </div>
      <div class="modal-body">
        <div class="row text-center mb-3">
          <div class="col-6 mb-2">
            <div class="stat-box-summary"><div class="stat-value text-primary" id="summaryDuration">00:00:00</div><div class="stat-label">DURATA</div></div>
          </div>
          <div class="col-6 mb-2">
            <div class="stat-box-summary"><div class="stat-value text-success" id="summaryDistance">0.00</div><div class="stat-label">DIST (KM)</div></div>
          </div>
          <div class="col-6">
            <div class="stat-box-summary"><div class="stat-value text-info" id="summarySpeed">0.0</div><div class="stat-label">VEL MEDIA</div></div>
          </div>
          <div class="col-6">
            <div class="stat-box-summary"><div class="stat-value text-warning" id="summaryPace">0:00</div><div class="stat-label">RITMO MEDIO</div></div>
          </div>
        </div>
        <div class="advanced-summary mt-3 p-3 bg-light rounded">
          <h6 class="text-center mb-3">üìà Metriche Avanzate</h6>
          <div class="row text-center">
            <div class="col-4"><div class="stat-value-sm text-danger" id="summaryCalories">0</div><small class="text-muted">Calorie</small></div>
            <div class="col-4"><div class="stat-value-sm text-purple" id="summaryElevation">+0m</div><small class="text-muted">Dislivello</small></div>
            <div class="col-4"><div class="stat-value-sm text-orange" id="summaryEfficiency">--</div><small class="text-muted">Efficienza</small></div>
          </div>
        </div>
        <div class="mt-3 p-3 bg-light rounded">
          <small class="text-muted">üí° L'attivit√† verr√† salvata nel tuo profilo per analisi dettagliate.</small>
        </div>
      </div>
      <div class="modal-footer flex-column gap-2">
        <button type="button" class="btn btn-secondary rounded-pill w-100" data-bs-dismiss="modal">Annulla</button>
        <button type="button" class="btn btn-success rounded-pill w-100" id="confirmSaveBtn">üíæ Salva Attivit√†</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Settings -->
<div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="settingsModalLabel">‚öôÔ∏è Impostazioni</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="themeColor" class="form-label">üé® Tema Colori</label>
          <select class="form-select" id="themeColor" aria-label="Tema Colori">
            <option value="default">Blu Classico</option>
            <option value="green">Verde Sport</option>
            <option value="purple">Viola Energia</option>
            <option value="orange">Arancio</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="unitSystem" class="form-label">üìè Unit√† di Misura</label>
          <select class="form-select" id="unitSystem" aria-label="Unit√† di Misura">
            <option value="metric">Metrico (km, min/km)</option>
            <option value="imperial">Imperiale (mi, min/mi)</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="userWeight" class="form-label">‚öñÔ∏è Il tuo Peso (kg)</label>
          <input type="number" class="form-control" id="userWeight" min="30" max="150" value="70" aria-label="Peso Utente">
          <small class="text-muted">Usato per calcolare le calorie bruciate.</small>
        </div>
        <div class="form-check form-switch mb-3">
          <input class="form-check-input" type="checkbox" id="audioToggle" role="switch">
          <label class="form-check-label" for="audioToggle">üîä Feedback Audio</label>
        </div>
        <div class="form-check form-switch mb-3">
          <input class="form-check-input" type="checkbox" id="notificationsToggle" role="switch">
          <label class="form-check-label" for="notificationsToggle">üîî Notifiche Browser</label>
        </div>
        <div class="form-check form-switch mb-3">
          <input class="form-check-input" type="checkbox" id="privacyMode" role="switch">
          <label class="form-check-label" for="privacyMode">üïµÔ∏è Modalit√† Privacy (Approssima posizione)</label>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
        <button type="button" class="btn btn-primary" id="saveSettingsBtn">Salva Impostazioni</button>
      </div>
    </div>
  </div>
</div>

<style>
/* Stili Base Ottimizzati Mobile */
body { padding-bottom: 60px; /* Spazio per eventuale navbar fisso */ }
.splash-screen { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
.splash-content { animation: fadeInUp 0.8s ease; }
@keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

.stat-box-mobile {
  padding: 10px 8px; background: #f8f9fa; border-radius: 10px; border: 1px solid #e0e0e0;
  display: flex; flex-direction: column; justify-content: center; height: 100px;
}
.stat-box-mobile:hover { transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.08); }
.stat-value { font-size: 1.5em; font-weight: bold; margin-bottom: 3px; transition: color 0.3s ease; }
.stat-label { font-size: 0.7em; color: #6c757d; text-transform: uppercase; letter-spacing: 0.5px; }

.stat-box-sm { padding: 8px 5px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef; }
.stat-value-sm { font-size: 1.1em; font-weight: bold; margin-bottom: 2px; }
.stat-label-sm { font-size: 0.65em; color: #6c757d; text-transform: uppercase; }

.stat-box-summary { padding: 15px 10px; background: #f8f9fa; border-radius: 12px; border: 2px solid #e9ecef; margin: 5px;}
.stat-value.text-primary, .stat-value.text-success, .stat-value.text-warning, .stat-value.text-info,
.stat-value-sm.text-danger, .stat-value-sm.text-purple, .stat-value-sm.text-orange { font-size: 1.8em; }
.stat-label { font-size: 0.75em; }

.tracking-card { border-left: 4px solid #28a745; transition: all 0.3s ease; }
.tracking-active { border-left-color: #28a745 !important; background: linear-gradient(90deg, rgba(40, 167, 69, 0.05) 0%, transparent 100%); }
.tracking-paused { border-left-color: #ffc107 !important; background: linear-gradient(90deg, rgba(255, 193, 7, 0.05) 0%, transparent 100%); }

.tracking-controls .btn { min-width: 120px; margin: 5px; transition: all 0.2s ease;}
#btnStart { min-width: 180px; font-size: 1.1rem; }

#gpsIndicator { width: 12px; height: 12px; border-radius: 50%; background: #dc3545; margin-left: 5px; transition: background 0.3s ease; display: inline-block; }
.gps-active { background: #28a745 !important; box-shadow: 0 0 8px rgba(40, 167, 69, 0.5); }

.pulse-animation { animation: pulse 2s infinite; }
@keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

.progress-bar { transition: width 0.5s ease-in-out; background-size: 200% 100% !important; animation: gradientShift 2s ease infinite; }
@keyframes gradientShift { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
.progress-text { font-weight: bold; text-shadow: 1px 1px 1px rgba(0,0,0,0.2); }

.value-change { animation: highlight 1s ease; }
@keyframes highlight { 0% { background-color: rgba(255, 255, 0, 0.3); } 100% { background-color: transparent; } }

.splits-container { background: #f8f9fa; border-radius: 10px; padding: 10px; }
.split-card { background: white; border-radius: 8px; border-left: 3px solid #28a745; }

/* Notifiche */
.split-notification { animation: slideInRight 0.5s ease; }
@keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

/* Dark Mode */
.dark-mode { background-color: #1a1a1a !important; color: #e0e0e0 !important; }
.dark-mode .card, .dark-mode .stat-box-mobile, .dark-mode .stat-box-sm, .dark-mode .stat-box-summary,
.dark-mode .modal-content, .dark-mode .dropdown-menu, .dark-mode .bg-light { background-color: #2d2d2d !important; border-color: #404040 !important; }
.dark-mode .text-muted { color: #bbb !important; }
.dark-mode .alert { background-color: #3a3a3a !important; border-color: #4a4a4a !important; }
.dark-mode .btn-outline-secondary, .dark-mode .btn-outline-primary { border-color: #555 !important; color: #e0e0e0 !important; }
.dark-mode .btn-outline-secondary:hover, .dark-mode .btn-outline-primary:hover { background-color: #444 !important; }
.dark-mode .modal-header { border-bottom-color: #404040 !important; }
.dark-mode .modal-footer { border-top-color: #404040 !important; }

/* Temi Colori */
.theme-green .btn-primary, .theme-green .bg-primary { background-color: #198754 !important; border-color: #198754 !important; }
.theme-purple .btn-primary, .theme-purple .bg-primary { background-color: #6f42c1 !important; border-color: #6f42c1 !important; }
.theme-orange .btn-primary, .theme-orange .bg-primary { background-color: #fd7e14 !important; border-color: #fd7e14 !important; }

/* Colori Specifici */
.text-purple { color: #6f42c1 !important; }
.text-orange { color: #fd7e14 !important; }

/* Sovrapposizione Tour */
.tour-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center; }
.tour-step { position: relative; z-index: 10001; width: 90%; }
.tour-content { background: #fff; border-radius: 15px; padding: 20px; }
.dark-mode .tour-content { background: #333; }
.tour-title { font-size: 1.2em; font-weight: bold; margin-bottom: 10px; color: var(--bs-primary); }
.tour-text { font-size: 0.9em; color: #555; }
.dark-mode .tour-text { color: #ccc; }
.tour-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; }
.tour-counter { font-size: 0.8em; color: #888; }
.tour-buttons .btn { margin-left: 10px; }

/* Scrollbar Personalizzata */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: rgba(255,255,255,0.1); border-radius: 10px; }
::-webkit-scrollbar-thumb { background: rgba(193,193,193,0.5); border-radius: 10px; }
::-webkit-scrollbar-thumb:hover { background: rgba(168,168,168,0.7); }

/* Responsive Adjustments */
@media (max-width: 576px) {
  .splash-content h3 { font-size: 1.5rem; }
  .splash-content p { font-size: 0.9rem; }
  .display-6 { font-size: 1.8rem !important; }
  .stat-value { font-size: 1.3em; }
  .stat-label { font-size: 0.65em; }
  #btnStart { font-size: 1rem; padding: 12px 20px; }
  .tracking-controls .btn { padding: 12px 15px; font-size: 0.9rem; min-width: 100px; }
  .modal-dialog { margin: 0.5rem; }
  .tour-step { width: 95%; }
}
</style>

{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
// =============================================
// AUDIO FEEDBACK SYSTEM
// =============================================
class AudioFeedback {
  constructor() {
    this.enabled = true;
    this.init();
  }
  
  init() {
    this.enabled = !window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    if (!this.enabled) return;
    
    try {
      this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
    } catch (e) {
      console.log('Web Audio API non supportata:', e);
      this.enabled = false;
    }
  }
  
  playBeep(frequency = 440, duration = 200, volume = 0.3) {
    if (!this.enabled || !this.audioContext) return;
    try {
      const oscillator = this.audioContext.createOscillator();
      const gainNode = this.audioContext.createGain();
      oscillator.connect(gainNode); gainNode.connect(this.audioContext.destination);
      oscillator.frequency.value = frequency; oscillator.type = 'sine';
      gainNode.gain.setValueAtTime(volume, this.audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + duration / 1000);
      oscillator.start(this.audioContext.currentTime); oscillator.stop(this.audioContext.currentTime + duration / 1000);
    } catch (e) { console.log('Errore riproduzione audio:', e); }
  }
  
  playStart() { this.playBeep(523, 200); }    // Do
  playPause() { this.playBeep(392, 200); }    // Sol
  playStop() { this.playBeep(330, 300); }     // Mi
  playKm() { this.playBeep(659, 150); }       // Mi alto
  playAlert() { this.playBeep(784, 400, 0.5); } // Sol alto
}

// =============================================
// ACTIVITY TRACKER MIGLIORATO PER MOBILE
// =============================================
class ActivityTracker {
  constructor() {
    this.isTracking = false; 
    this.isPaused = false;
    this.startTime = null; 
    this.positions = []; 
    this.watchId = null;
    this.distance = 0; 
    this.miniMap = null; 
    this.polyline = null;
    this.timerInterval = null; 
    this.autoSaveInterval = null;
    this.errorCount = 0; 
    this.maxErrors = 5; 
    this.currentPositionMarker = null;
    this.splits = []; 
    this.splitDistance = 1; 
    this.lastSplitAt = 0;
    this.audioFeedback = new AudioFeedback();
    this.privacyMode = false; 
    this.userWeight = 70;
    this.route_id = null; 
    this.duration = 0; 
    this.avgSpeed = 0; 
    this.avgPace = '0:00';
    this.pauseStartTime = null;

    this.loadUserSettings();
    this.setupSplits();
    this.setupBrowserNotifications();
    this.checkInitialGPSStatus();
    
    // Bind delle funzioni
    this.updateStatusBadge = this.updateStatusBadge.bind(this);
    this.updateUIState = this.updateUIState.bind(this);
  }

  // FUNZIONE MANCANTE AGGIUNTA
  updateStatusBadge(status) {
    const badge = document.getElementById('statusBadge');
    if (!badge) return;
    
    switch(status) {
      case 'ready':
        badge.textContent = 'üü¢ Pronto';
        badge.className = 'badge rounded-pill bg-secondary';
        break;
      case 'tracking':
        badge.textContent = 'üî¥ Tracciamento Attivo';
        badge.className = 'badge rounded-pill bg-success';
        break;
      case 'paused':
        badge.textContent = 'üü° In Pausa';
        badge.className = 'badge rounded-pill bg-warning text-dark';
        break;
      case 'error':
        badge.textContent = '‚ö™ Errore';
        badge.className = 'badge rounded-pill bg-danger';
        break;
      default:
        badge.textContent = 'üü¢ Pronto';
        badge.className = 'badge rounded-pill bg-secondary';
    }
  }

  // FUNZIONE MANCANTE AGGIUNTA
  updateUIState(state) {
    const startBtn = document.getElementById('btnStart');
    const pauseBtn = document.getElementById('btnPause');
    const stopBtn = document.getElementById('btnStop');
    const liveStats = document.getElementById('liveStats');
    
    switch(state) {
      case 'ready':
        startBtn.classList.remove('d-none');
        pauseBtn.classList.add('d-none');
        stopBtn.classList.add('d-none');
        liveStats.classList.add('d-none');
        break;
        
      case 'tracking':
        startBtn.classList.add('d-none');
        pauseBtn.classList.remove('d-none');
        stopBtn.classList.remove('d-none');
        liveStats.classList.remove('d-none');
        break;
        
      case 'paused':
        startBtn.classList.add('d-none');
        pauseBtn.classList.remove('d-none');
        stopBtn.classList.remove('d-none');
        liveStats.classList.remove('d-none');
        break;
    }
  }

  loadUserSettings() {
    const settings = JSON.parse(localStorage.getItem('appSettings') || '{}');
    this.userWeight = settings.userWeight || 70;
    this.privacyMode = settings.privacyMode || false;
    this.audioFeedback.enabled = settings.audioEnabled !== false;
    document.body.classList.toggle('dark-mode', settings.darkModeEnabled === true);
    document.body.className = document.body.className.replace(/\btheme-\w+/g, '');
    document.body.classList.add(`theme-${settings.themeColor || 'default'}`);
  }

  checkInitialGPSStatus() {
    if (!navigator.geolocation) {
      this.showStatus("Il tuo browser non supporta la geolocalizzazione.", "danger");
      this.updateGPSIndicator(false);
      document.getElementById('gpsStatus').textContent = "üì° GPS: Non Supportato";
      document.getElementById('gpsStatus').className = "badge rounded-pill bg-dark";
      return false;
    }
    return true;
  }

  async requestLocationPermission() {
     try {
       const position = await new Promise((resolve, reject) => {
         navigator.geolocation.getCurrentPosition(resolve, reject, {
           enableHighAccuracy: true,
           timeout: 5000,
           maximumAge: 0
         });
       });
       this.updateGPSIndicator(true);
       document.getElementById('gpsStatus').textContent = "üì° GPS: Connesso";
       document.getElementById('gpsStatus').className = "badge rounded-pill bg-success";
       return true;
     } catch (error) {
       console.error('Errore richiesta GPS:', error);
       if (error.code === error.PERMISSION_DENIED || error.code === error.POSITION_UNAVAILABLE) {
         const modal = new bootstrap.Modal(document.getElementById('gpsInstructionsModal'));
         modal.show();
       }
       this.updateGPSIndicator(false);
       document.getElementById('gpsStatus').textContent = "üì° GPS: Richiesto";
       document.getElementById('gpsStatus').className = "badge rounded-pill bg-warning text-dark";
       return false;
     }
  }

  async startTracking() {
    if (!this.checkInitialGPSStatus()) return;
    
    if (!await this.requestLocationPermission()) {
        this.showStatus("Il GPS √® necessario per avviare il tracciamento.", "warning");
        return;
    }

    document.getElementById('autoStartMessage').classList.remove('d-none');
    this.updateStatusBadge('tracking');

    try {
      this.initMiniMap();
      this.isTracking = true; 
      this.isPaused = false;
      this.startTime = new Date(); 
      this.positions = []; 
      this.distance = 0;
      this.errorCount = 0; 
      this.splits = []; 
      this.lastSplitAt = 0;

      this.updateTimer();
      this.timerInterval = setInterval(() => {
        this.updateTimer(); 
        this.checkForSplits(); 
        this.updateAdvancedMetrics();
      }, 1000);
      
      this.startAutoSave();
      
      this.watchId = navigator.geolocation.watchPosition(
        pos => this.handlePosition(pos),
        err => this.handleError(err),
        { enableHighAccuracy: true, timeout: 20000, maximumAge: 1000, distanceFilter: 5 }
      );

      this.updateUIState('tracking');
      document.querySelector('.tracking-card').classList.add('tracking-active');
      document.querySelector('.tracking-card').classList.remove('tracking-paused');

      document.getElementById('autoStartMessage').classList.add('d-none');
      this.showStatus("‚úÖ Tracciamento attivo!", "success");
      this.audioFeedback.playStart();
      this.showBrowserNotification("Tracciamento Avviato", "L'attivit√† √® in corso...");

    } catch (error) {
      console.error('Errore avvio tracking:', error);
      this.showStatus("‚ùå Errore nell'avvio del tracciamento.", "danger");
      this.resetUI();
    }
  }

  pauseTracking() {
    if (!this.isTracking) return;
    
    this.isPaused = !this.isPaused;
    
    if (this.isPaused) {
      // METTI IN PAUSA
      if (this.watchId) {
        navigator.geolocation.clearWatch(this.watchId);
        this.watchId = null;
      }
      
      if (this.timerInterval) {
        clearInterval(this.timerInterval);
        this.timerInterval = null;
      }
      
      this.pauseStartTime = new Date();
      
      document.getElementById('btnPause').innerHTML = '‚ñ∂Ô∏è RIPRENDI';
      document.querySelector('.tracking-card').classList.remove('tracking-active');
      document.querySelector('.tracking-card').classList.add('tracking-paused');
      
      this.showStatus("‚è∏Ô∏è Tracciamento in pausa", "warning");
      this.updateGPSIndicator(false);
      this.updateStatusBadge('paused');
      this.audioFeedback.playPause();
      
    } else {
      // RIPRENDI
      if (this.pauseStartTime) {
        const pauseDuration = new Date() - this.pauseStartTime;
        this.startTime = new Date(this.startTime.getTime() + pauseDuration);
      }
      
      this.timerInterval = setInterval(() => {
        this.updateTimer();
        this.checkForSplits();
        this.updateAdvancedMetrics();
      }, 1000);
      
      this.watchId = navigator.geolocation.watchPosition(
        pos => this.handlePosition(pos),
        err => this.handleError(err),
        { enableHighAccuracy: true, timeout: 20000, maximumAge: 1000, distanceFilter: 5 }
      );
      
      document.getElementById('btnPause').innerHTML = '‚è∏Ô∏è PAUSA';
      document.querySelector('.tracking-card').classList.remove('tracking-paused');
      document.querySelector('.tracking-card').classList.add('tracking-active');
      
      this.showStatus("‚úÖ Tracciamento ripreso!", "success");
      this.updateGPSIndicator(true);
      this.updateStatusBadge('tracking');
      this.audioFeedback.playStart();
    }
  }

  initMiniMap() {
    if (this.miniMap) { 
        this.polyline.setLatLngs([]);
        if (this.currentPositionMarker) this.miniMap.removeLayer(this.currentPositionMarker);
        return;
    }
    
    const initialLat = 42.35; 
    const initialLng = 13.395;
    this.miniMap = L.map('miniMap', { 
      zoomControl: true,
      touchZoom: true,
      dragging: true
    }).setView([initialLat, initialLng], 15);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors' 
    }).addTo(this.miniMap);

    this.polyline = L.polyline([], { color: 'red', weight: 4, opacity: 0.7, lineJoin: 'round' }).addTo(this.miniMap);
    
    this.currentPositionMarker = L.circleMarker([initialLat, initialLng], { 
      radius: 8, fillColor: "#ff0000", color: "#000", weight: 2, opacity: 1, fillOpacity: 0.8 
    }).addTo(this.miniMap);
    
    this.miniMap.addControl(L.control.scale());
  }

  handlePosition(pos) {
    if (pos.coords.accuracy > 50 && this.positions.length > 5) { 
      this.showStatus(`‚ö†Ô∏è Bassa precisione GPS (${Math.round(pos.coords.accuracy)}m)`, "warning", 3000);
      return;
    }

    const newPos = {
      lat: pos.coords.latitude, 
      lng: pos.coords.longitude,
      timestamp: new Date(), 
      speed: pos.coords.speed || 0,
      accuracy: pos.coords.accuracy,
      altitude: pos.coords.altitude || null
    };

    const processedPos = this.privacyMode ? this.getApproximatePosition(newPos) : newPos;

    this.updateAccuracyIndicator(processedPos.accuracy);

    if (this.positions.length > 0) {
      const last = this.positions[this.positions.length - 1];
      const d = this.calculateDistance(last.lat, last.lng, processedPos.lat, processedPos.lng);
      if (d < 0.001 || d > 0.5) return; 
      this.distance += d;
    }

    this.positions.push(processedPos);
    this.updateDisplay();
    this.updateMap(processedPos);
    this.updateRouteProgress();
    this.errorCount = 0;
  }

  calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2) ** 2 + 
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
              Math.sin(dLon/2) ** 2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }

  updateDisplay() {
    const timerEl = document.getElementById('timer');
    const distanceEl = document.getElementById('distance');
    const paceEl = document.getElementById('pace');
    const speedEl = document.getElementById('speed');

    timerEl.textContent = this.formatTime(new Date() - this.startTime, true); 
    distanceEl.textContent = this.distance.toFixed(2);
    
    [distanceEl, timerEl].forEach(el => el.classList.add('value-change'));

    const elapsedHours = (new Date() - this.startTime) / 3600000;
    if (elapsedHours > 0 && this.distance > 0) {
      const avgPaceMinutes = (elapsedHours * 60) / this.distance;
      paceEl.textContent = this.formatPace(avgPaceMinutes);
      speedEl.textContent = (this.distance / elapsedHours).toFixed(1);
      [paceEl, speedEl].forEach(el => el.classList.add('value-change'));
    } else {
      paceEl.textContent = '0:00'; 
      speedEl.textContent = '0.0';
    }
    
    setTimeout(() => {
      [distanceEl, timerEl, paceEl, speedEl].forEach(el => el.classList.remove('value-change'));
    }, 1000);
  }

  updateAdvancedMetrics() {
    const metrics = this.calculateMetrics();
    document.getElementById('calories').textContent = metrics.calories;
    document.getElementById('elevation').textContent = `+${metrics.elevation.ascent}m`;
    document.getElementById('efficiency').textContent = metrics.efficiency;
    
    ['calories', 'elevation', 'efficiency'].forEach(id => 
      document.getElementById(id).classList.add('value-change'));
    
    setTimeout(() => {
      ['calories', 'elevation', 'efficiency'].forEach(id => 
        document.getElementById(id).classList.remove('value-change'));
    }, 1000);
  }
  
  calculateMetrics() {
    const hours = Math.max(1, (new Date() - this.startTime) / 3600000);
    const met = this.getMETValue();
    const calories = Math.round(met * this.userWeight * hours);
    const elevation = this.calculateElevationFromPositions();
    const efficiency = this.calculateEfficiencyScore();
    return { calories, elevation, efficiency };
  }

  getMETValue() {
    const avgSpeed = this.distance / ((new Date() - this.startTime) / 3600000);
    if (avgSpeed < 5) return 4.0;
    if (avgSpeed < 8) return 7.0;
    if (avgSpeed < 12) return 10.0;
    return 12.0;
  }

  calculateElevationFromPositions() {
    if (this.positions.length < 2) return { ascent: 0, descent: 0 };
    let ascent = 0; let descent = 0;
    for (let i = 1; i < this.positions.length; i++) {
      const alt1 = this.positions[i-1].altitude || 0;
      const alt2 = this.positions[i].altitude || 0;
      const diff = alt2 - alt1;
      if (alt1 > 0 && alt2 > 0) { 
        if (diff > 2) ascent += diff;
        else if (diff < -2) descent += Math.abs(diff);
      }
    }
    return { ascent: Math.round(ascent), descent: Math.round(descent) };
  }

  calculateEfficiencyScore() {
    if (this.distance < 0.1) return '--';
    const pace = ((new Date() - this.startTime) / 60000) / this.distance;
    const elevationRate = this.calculateElevationFromPositions().ascent / this.distance;
    let efficiency = 100 - (pace * 8) + (elevationRate * 3); 
    efficiency = Math.max(0, Math.min(100, efficiency));
    if (efficiency >= 80) return 'A+'; if (efficiency >= 60) return 'A';
    if (efficiency >= 40) return 'B'; if (efficiency >= 20) return 'C';
    return 'D';
  }

  updateTimer() {
    if (!this.startTime) return;
    const timerEl = document.getElementById('timer');
    timerEl.textContent = this.formatTime(new Date() - this.startTime, true);
  }

  updateMap(pos) {
    if (!this.miniMap) return;
    const ll = [pos.lat, pos.lng];
    this.polyline.addLatLng(ll);
    this.currentPositionMarker.setLatLng(ll);
    
    if (this.positions.length < 5 || this.miniMap.isMoving()) { 
      this.miniMap.setView(ll);
    }
  }

  updateGPSIndicator(active) {
    const statusEl = document.getElementById('gpsStatus');
    if (active) {
      statusEl.textContent = "üì° GPS: Attivo";
      statusEl.className = "badge rounded-pill bg-success";
    } else {
      statusEl.textContent = "üì° GPS: Inattivo";
      statusEl.className = "badge rounded-pill bg-danger";
    }
  }

  updateAccuracyIndicator(accuracy) {
    const accuracyEl = document.getElementById('accuracyStatus');
    accuracyEl.textContent = `üéØ ${Math.round(accuracy)}m`;
    accuracyEl.className = `badge rounded-pill ${
      accuracy < 15 ? 'bg-success' : accuracy < 40 ? 'bg-warning text-dark' : 'bg-danger'
    }`;
  }

  updateBatteryStatus() {
    if ('getBattery' in navigator) {
      navigator.getBattery().then(battery => {
        const batteryEl = document.getElementById('batteryStatus');
        const level = Math.round(battery.level * 100);
        batteryEl.textContent = `üîã ${level}%`;
        batteryEl.className = `badge rounded-pill ${
          level > 50 ? 'bg-success' : level > 20 ? 'bg-warning text-dark' : 'bg-danger'
        }`;
      }).catch(() => { });
    }
  }

  updateRouteProgress() {
    const sel = document.getElementById('routeSelect');
    const selectedOption = sel.options[sel.selectedIndex];
    const routeDistance = parseFloat(selectedOption?.getAttribute('data-distance')) || 0;
    
    if (routeDistance > 0) {
      const progress = Math.min(100, (this.distance / routeDistance) * 100);
      const progressBar = document.getElementById('routeProgress').querySelector('.progress-bar');
      progressBar.style.width = `${progress}%`;
      progressBar.querySelector('.progress-text').textContent = `${progress.toFixed(0)}%`;
      document.getElementById('routeProgress').style.display = 'block';
    } else {
      document.getElementById('routeProgress').style.display = 'none';
    }
  }

  setupSplits() { 
    this.splits = [];
    this.splitDistance = 1;
    this.lastSplitAt = 0;
  }

  checkForSplits() {
    if (!this.isTracking || this.isPaused) return;
    const kmCompleted = Math.floor(this.distance);
    if (kmCompleted > this.lastSplitAt) {
      for (let km = this.lastSplitAt + 1; km <= kmCompleted; km++) {
        this.recordSplit(km);
      }
      this.lastSplitAt = kmCompleted;
    }
  }

  recordSplit(km) {
    const splitTime = new Date() - this.startTime;
    const splitPace = this.calculatePaceForKm(km);
    const split = { kilometer: km, time: splitTime, pace: splitPace, timestamp: new Date() };
    this.splits.push(split);
    this.showSplitNotification(split);
    this.audioFeedback.playKm();
  }

  calculatePaceForKm(km) {
    if (km === 1) return this.formatPace((new Date() - this.startTime) / 60000);
    const split = this.splits.find(s => s.kilometer === km - 1); 
    if (!split) return '0:00';
    const timeForKm = (new Date() - this.startTime - split.time) / 60000;
    return this.formatPace(timeForKm);
  }

  setupBrowserNotifications() { 
    if (!("Notification" in window)) {
      console.log("Browser non supporta notifiche");
      return;
    }
  }
  
  showBrowserNotification(title, body) {
    const settings = JSON.parse(localStorage.getItem('appSettings') || '{}');
    if (Notification.permission === "granted" && settings.notificationsEnabled) {
      new Notification(title, { 
        body: body, 
        icon: '/static/favicon.ico',
        badge: '/static/favicon.ico' 
      });
    } else if (Notification.permission !== "denied") {
      Notification.requestPermission();
    }
  }

  startAutoSave() {
    this.autoSaveInterval = setInterval(async () => {
      if (this.isTracking && !this.isPaused && this.positions.length > 0) {
        await this.backupActivity();
      }
    }, 60000); 
  }

  async backupActivity() {
    const backupData = {
      positions: this.positions,
      distance: this.distance,
      startTime: this.startTime,
      duration: new Date() - this.startTime,
      splits: this.splits
    };
    localStorage.setItem('activityBackup', JSON.stringify(backupData));
  }

  getApproximatePosition(position, radiusKm = 0.3) {
    const offsetLat = (Math.random() - 0.5) * (radiusKm / 110.574);
    const offsetLng = (Math.random() - 0.5) * (radiusKm / (111.320 * Math.cos(position.lat * Math.PI / 180)));
    return { 
      ...position,
      lat: position.lat + offsetLat,
      lng: position.lng + offsetLng
    };
  }

  handleError(err) {
    this.errorCount++;
    if (this.errorCount >= this.maxErrors) {
      this.showStatus("‚ùå Segnale GPS perso. Tracciamento sospeso.", "danger");
      this.stopTracking(); 
      return;
    }
    
    let msg = "Errore GPS";
    if (err.code === err.PERMISSION_DENIED) {
      msg = "Permesso GPS negato."; 
      const modal = new bootstrap.Modal(document.getElementById('gpsInstructionsModal')); 
      modal.show();
    } else if (err.code === err.POSITION_UNAVAILABLE) msg = "Posizione non disponibile.";
    else if (err.code === err.TIMEOUT) msg = "Timeout GPS, riprovo...";
    
    this.showStatus(`‚ö†Ô∏è ${msg} (${this.errorCount}/${this.maxErrors})`, "danger", 4000);
    this.updateGPSIndicator(false);
  }

  async stopTracking() {
    if (this.watchId) navigator.geolocation.clearWatch(this.watchId); 
    this.watchId = null;
    
    if (this.timerInterval) clearInterval(this.timerInterval);
    if (this.autoSaveInterval) clearInterval(this.autoSaveInterval);
    
    this.isTracking = false;
    this.updateGPSIndicator(false);
    this.updateStatusBadge('ready');

    const sel = document.getElementById('routeSelect');
    this.route_id = sel.value || null;
    this.duration = Math.max(1, Math.round((new Date() - this.startTime) / 1000));
    this.distance = Math.max(0.01, this.distance);

    const hours = this.duration / 3600;
    this.avgSpeed = (this.distance / hours).toFixed(1);
    const paceMinutes = (hours * 60) / this.distance;
    this.avgPace = this.formatPace(paceMinutes);

    const finalMetrics = this.calculateMetrics();
    
    document.getElementById('summaryDuration').textContent = this.formatTime(this.duration * 1000, true);
    document.getElementById('summaryDistance').textContent = this.distance.toFixed(2);
    document.getElementById('summarySpeed').textContent = this.avgSpeed;
    document.getElementById('summaryPace').textContent = this.avgPace;
    document.getElementById('summaryCalories').textContent = finalMetrics.calories;
    document.getElementById('summaryElevation').textContent = `+${finalMetrics.elevation.ascent}m`;
    document.getElementById('summaryEfficiency').textContent = finalMetrics.efficiency;

    const modal = new bootstrap.Modal(document.getElementById('activitySummaryModal'));
    modal.show();

    document.getElementById('confirmSaveBtn').onclick = async () => {
      modal.hide();
      const data = {
        route_id: this.route_id, 
        duration: this.duration, 
        distance: this.distance,
        positions: this.positions, 
        start_time: this.startTime.toISOString(),
        avg_speed: this.avgSpeed, 
        avg_pace: this.avgPace,
        calories: finalMetrics.calories, 
        elevation: finalMetrics.elevation.ascent,
        splits: this.splits
      };
      await this.saveActivity(data);
    };
    
    this.audioFeedback.playStop();
    localStorage.removeItem('activityBackup');
    this.resetUI();
  }

  async saveActivity(data) {
    const statusEl = document.getElementById('statusMessage');
    statusEl.innerHTML = '<div class="alert alert-info w-100">üíæ Salvataggio in corso...</div>';
    try {
      const csrfMeta = document.querySelector('meta[name="csrf-token"]');
      const csrfToken = csrfMeta ? csrfMeta.content : null;
      const headers = { 'Content-Type': 'application/json' };
      if (csrfToken) headers['X-CSRFToken'] = csrfToken;

      const res = await fetch('/api/save-live-activity', {
        method: 'POST', 
        headers: headers, 
        body: JSON.stringify(data), 
        credentials: 'same-origin'
      });

      if (!res.ok) { 
        const text = await res.text(); 
        throw new Error(`Errore server ${res.status}: ${text}`); 
      }
      
      const result = await res.json();
      
      if (result.success) {
        statusEl.innerHTML = `<div class="alert alert-success w-100">${result.message}</div>`;
        setTimeout(() => window.location.href = "{{ url_for('main.all_activities') }}", 2000);
      } else { 
        throw new Error(result.error || "Errore sconosciuto dal server"); 
      }
    } catch (error) {
      console.error("Save activity failed:", error);
      statusEl.innerHTML = `<div class="alert alert-danger w-100">‚ùå Errore salvataggio: ${error.message}</div>`;
    }
  }

  showStatus(msg, type, timeout = 5000) {
    const el = document.getElementById('statusMessage');
    el.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show w-100" role="alert">${msg}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
    
    if (timeout && timeout > 0) {
      setTimeout(() => { 
        if (el.innerHTML.includes(msg)) el.innerHTML = ''; 
      }, timeout);
    }
  }

  formatTime(ms, includeHours = false) {
    const seconds = Math.floor(ms / 1000);
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = seconds % 60;
    
    if (includeHours) return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
    return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
  }
  
  formatPace(minutes) {
    const m = Math.floor(minutes);
    const s = Math.floor((minutes - m) * 60);
    return `${m}:${s.toString().padStart(2, '0')}`;
  }

  showSplitNotification(split) {
    document.getElementById('lastSplitKm').textContent = `${split.kilometer}km`;
    document.getElementById('lastSplitTime').textContent = this.formatTime(split.time, true);
    document.getElementById('lastSplitPace').textContent = `${split.pace}/km`;
    
    const notificationEl = document.createElement('div');
    notificationEl.className = 'alert alert-info alert-dismissible split-notification w-100';
    notificationEl.innerHTML = `
      <strong>üéâ ${split.kilometer}km!</strong> Ritmo: ${split.pace}/km
      <button type="button" class="btn-close btn-close-white float-end" onclick="this.parentElement.remove()"></button>
    `;
    const statusMessage = document.getElementById('statusMessage');
    statusMessage.prepend(notificationEl);
    
    setTimeout(() => { if (notificationEl.parentElement) notificationEl.remove(); }, 7000);
    this.showBrowserNotification(`üéØ ${split.kilometer}km Completato!`, `Ritmo: ${split.pace}/km`);
  }

  resetUI() { 
    this.updateUIState('ready');
    document.getElementById('autoStartMessage').classList.add('d-none');
    document.getElementById('splitsContainer').style.display = 'none';
    document.getElementById('routeProgress').style.display = 'none';
    document.querySelector('.tracking-card').classList.remove('tracking-active', 'tracking-paused');
    
    document.getElementById('timer').textContent = '00:00:00';
    document.getElementById('distance').textContent = '0.00';
    document.getElementById('pace').textContent = '0:00';
    document.getElementById('speed').textContent = '0.0';
    document.getElementById('calories').textContent = '0';
    document.getElementById('elevation').textContent = '+0m';
    document.getElementById('efficiency').textContent = '--';
    
    document.getElementById('lastSplitKm').textContent = '1km';
    document.getElementById('lastSplitTime').textContent = '00:00:00';
    document.getElementById('lastSplitPace').textContent = '0:00/km';
    
    this.updateAccuracyIndicator(0);
    this.updateBatteryStatus();
    
    if (this.miniMap) { 
      this.polyline.setLatLngs([]);
    }
  }
}

// =============================================
// APP TOUR SYSTEM
// =============================================
class AppTour {
  constructor() {
    this.steps = [
      { element: '#routeSelect', title: 'üéØ Percorsi', content: 'Seleziona un percorso predefinito o usa la modalit√† libera.' },
      { element: '#btnStart', title: '‚ñ∂Ô∏è Inizia', content: 'Tocca qui per attivare il GPS e avviare il tracciamento.' },
      { element: '#liveStats', title: 'üìä Statistiche', content: 'Visualizza tempo, distanza, ritmo e velocit√† in tempo reale.' },
      { element: '#miniMap', title: 'üó∫Ô∏è Mappa', content: 'Segui il tuo percorso in diretta sulla mappa.' }
    ];
    this.currentStep = 0;
  }

  start() {
    if (localStorage.getItem('appTourCompleted')) return;
    this.currentStep = 0;
    setTimeout(() => this.showStep(this.currentStep), 500); 
  }

  showStep(index) {
    if (index >= this.steps.length) { 
      this.removeOverlay();
      localStorage.setItem('appTourCompleted', 'true');
      return; 
    }
    
    this.currentStep = index;
    const step = this.steps[index];
    const targetElement = document.querySelector(step.element);
    
    if (!targetElement) { 
      this.showStep(index + 1); 
      return; 
    }
    
    this.createStepOverlay(step, index);
  }

  createStepOverlay(step, index) {
    this.removeOverlay();
    const overlay = document.createElement('div');
    overlay.id = 'tourOverlay'; 
    overlay.className = 'tour-overlay';
    
    overlay.innerHTML = `
      <div class="tour-step">
        <div class="tour-content card shadow-lg">
          <div class="card-body text-center">
            <h5 class="tour-title">${step.title}</h5>
            <p class="tour-text">${step.content}</p>
            <div class="tour-footer">
              <small class="tour-counter">${index + 1}/${this.steps.length}</small>
              <div class="d-flex">
                <button class="btn btn-sm btn-outline-secondary tour-skip me-2">Salta</button>
                <button class="btn btn-sm btn-primary tour-next">${index === this.steps.length - 1 ? 'Fine' : 'Avanti'}</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
    
    document.body.appendChild(overlay);
    this.highlightElement(document.querySelector(step.element));
    
    overlay.querySelector('.tour-next').addEventListener('click', () => this.next());
    overlay.querySelector('.tour-skip').addEventListener('click', () => this.skip());
    overlay.addEventListener('click', (e) => { if (e.target === overlay) this.skip(); });
  }

  highlightElement(element) {
    if (!element) return;
    element.style.transition = 'box-shadow 0.3s ease, transform 0.3s ease';
    element.style.boxShadow = '0 0 0 4px rgba(50, 150, 255, 0.7)';
    element.style.zIndex = '10002';
    element.style.transform = 'scale(1.02)';
  }

  removeHighlight() {
    this.steps.forEach(step => {
      const el = document.querySelector(step.element);
      if (el) { 
        el.style.boxShadow = ''; 
        el.style.zIndex = ''; 
        el.style.transform = ''; 
      }
    });
  }

  removeOverlay() { 
    this.removeHighlight();
    const overlay = document.getElementById('tourOverlay'); 
    if (overlay) overlay.remove();
  }
  
  next() { this.showStep(this.currentStep + 1); }
  skip() { this.removeOverlay(); localStorage.setItem('appTourCompleted', 'true'); }
}

// =============================================
// GESTIONE IMPOSTAZIONI UTENTE
// =============================================
function loadSettings() {
  const settings = JSON.parse(localStorage.getItem('appSettings') || '{}');
  
  document.getElementById('themeColor').value = settings.themeColor || 'default';
  document.getElementById('unitSystem').value = settings.unitSystem || 'metric';
  document.getElementById('userWeight').value = settings.userWeight || 70;
  document.getElementById('audioToggle').checked = settings.audioEnabled !== false;
  document.getElementById('notificationsToggle').checked = settings.notificationsEnabled || false;
  document.getElementById('privacyMode').checked = settings.privacyMode || false;
  
  const darkModeEnabled = settings.darkModeEnabled === true;
  document.getElementById('darkModeToggle').querySelector('.dark-icon').classList.toggle('d-none', !darkModeEnabled);
  document.getElementById('darkModeToggle').querySelector('.light-icon').classList.toggle('d-none', darkModeEnabled);
  document.body.classList.toggle('dark-mode', darkModeEnabled);
  
  applySettings(settings);
}

function saveSettings() {
  const settings = {
    themeColor: document.getElementById('themeColor').value,
    unitSystem: document.getElementById('unitSystem').value,
    userWeight: parseInt(document.getElementById('userWeight').value) || 70,
    audioEnabled: document.getElementById('audioToggle').checked,
    notificationsEnabled: document.getElementById('notificationsToggle').checked,
    privacyMode: document.getElementById('privacyMode').checked,
    darkModeEnabled: document.body.classList.contains('dark-mode')
  };
  
  localStorage.setItem('appSettings', JSON.stringify(settings));
  applySettings(settings);
  
  if (window.tracker) window.tracker.loadUserSettings();
  
  const modal = bootstrap.Modal.getInstance(document.getElementById('settingsModal'));
  if (modal) modal.hide();
  
  showTempAlert('Impostazioni salvate!', 'success');
}

function applySettings(settings) {
  document.body.className = document.body.className.replace(/\btheme-\w+/g, ''); 
  document.body.classList.add(`theme-${settings.themeColor || 'default'}`); 
}

function showTempAlert(message, type) {
  const alert = document.createElement('div');
  alert.className = `alert alert-${type} alert-dismissible fade show position-fixed top-2 start-50 translate-middle-x w-75 w-md-auto shadow-lg`;
  alert.style.zIndex = '1051';
  alert.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
  document.body.appendChild(alert);
  
  setTimeout(() => { if (alert.parentElement) alert.remove(); }, 3000); 
}

// =============================================
// INIZIALIZZAZIONE APP
// =============================================
let tracker;

document.addEventListener('DOMContentLoaded', () => {
  // Nasconde splash screen
  setTimeout(() => {
    const splash = document.getElementById('welcomeSplash');
    if (splash) {
      splash.style.opacity = '0';
      setTimeout(() => splash.remove(), 500);
    }
  }, 1200);

  // Inizializza tracker
  tracker = new ActivityTracker();
  loadSettings();

  // Setup dark mode toggle
  const darkModeToggle = document.getElementById('darkModeToggle');
  darkModeToggle.addEventListener('click', () => {
    document.body.classList.toggle('dark-mode');
    const lightIcon = darkModeToggle.querySelector('.light-icon');
    const darkIcon = darkModeToggle.querySelector('.dark-icon');
    darkIcon.classList.toggle('d-none'); 
    lightIcon.classList.toggle('d-none');
    localStorage.setItem('darkModeEnabled', document.body.classList.contains('dark-mode'));
  });

  // Event listeners per i pulsanti
  document.getElementById('btnStart').addEventListener('click', () => {
    console.log('Start clickato');
    tracker.startTracking();
  });
  
  document.getElementById('btnPause').addEventListener('click', () => {
    console.log('Pause clickato');
    tracker.pauseTracking();
  });
  
  document.getElementById('btnStop').addEventListener('click', () => {
    console.log('Stop clickato');
    tracker.stopTracking();
  });
  
  // Salva impostazioni
  document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
  
  // Aggiorna batteria
  tracker.updateBatteryStatus();
  setInterval(tracker.updateBatteryStatus.bind(tracker), 60000);
  
  // Avvia tour
  if (!localStorage.getItem('appTourCompleted')) {
     const tour = new AppTour();
     tour.start();
  }

  // Gestione uscita pagina
  window.addEventListener('beforeunload', (e) => {
    if (tracker.isTracking && !tracker.isPaused) {
      e.preventDefault();
      e.returnValue = 'Tracciamento in corso. Uscire?';
    }
  });

  // Recupero sessione
  const backup = localStorage.getItem('activityBackup');
  if (backup) {
    try {
      const backupData = JSON.parse(backup);
      const modalHtml = `
        <div class="modal fade" id="recoveryModal" tabindex="-1" aria-labelledby="recoveryModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 shadow">
              <div class="modal-header bg-warning rounded-top-4">
                <h5 class="modal-title" id="recoveryModalLabel">üìã Sessione Interrotta</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
              </div>
              <div class="modal-body">
                <p>Abbiamo trovato una sessione di tracciamento non salvata:</p>
                <ul class="small">
                  <li>Durata: ${tracker.formatTime(backupData.duration, true)}</li>
                  <li>Distanza: ${backupData.distance?.toFixed(2) || '0.00'} km</li>
                  <li>Iniziata: ${new Date(backupData.startTime).toLocaleString()}</li>
                </ul>
                <p>Vuoi continuare da qui?</p>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal" onclick="localStorage.removeItem('activityBackup')">Scarta</button>
                <button type="button" class="btn btn-primary rounded-pill" data-bs-dismiss="modal" onclick="window.recoverSession && window.recoverSession()">Riprendi Attivit√†</button>
              </div>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      new bootstrap.Modal(document.getElementById('recoveryModal')).show();
      
      window.recoverSession = () => {
        localStorage.removeItem('activityBackup');
        showTempAlert('Sessione recuperata. Premi "RIPRENDI" o "INIZIA" per continuare.', 'info');
      };
    } catch (error) { 
      console.error('Errore recupero sessione:', error); 
      localStorage.removeItem('activityBackup');
    }
  }
});
</script>
{% endblock %}