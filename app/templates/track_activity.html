{% extends "index.html" %}

{% block content %}
<meta name="csrf-token" content="{{ csrf_token() }}">
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">

            <!-- Header -->
            <div class="text-center mb-4">
                <h1>üèÉ Inizia la tua Attivit√†</h1>
                <p class="lead">Tracciamento GPS in tempo reale - Nessun GPX necessario!</p>
            </div>

            <!-- Selezione Percorso -->
            <div class="card mb-4 shadow-sm rounded-4">
                <div class="card-header bg-primary"><h5>üìå Seleziona Percorso (Opzionale)</h5></div>
                <div class="card-body">
                    <select class="form-select" id="routeSelect">
                        <option value="">üéØ Modalit√† Libera</option>
                        {% for route in routes %}
                        <option value="{{ route.id }}" data-distance="{{ route.distance or 0 }}">
                            üìç {{ route.name }} {% if route.distance %}({{ "%.1f"|format(route.distance) }} km){% endif %}
                        </option>
                        {% endfor %}
                    </select>
                    <small class="text-muted">
                        <strong>Libera:</strong> tracciamento libero<br>
                        <strong>Percorso:</strong> confronta performance
                    </small>
                </div>
            </div>

            <!-- Pannello Tracking -->
            <div class="card shadow-sm rounded-4">
                <div class="card-header bg-success text-white"><h5>üéØ Tracciamento Live</h5></div>
                <div class="card-body text-center">

                    <button id="btnStart" class="btn btn-success btn-lg mb-3 rounded-pill">‚ñ∂Ô∏è INIZIA TRACCIAMENTO</button>

                    <div id="autoStartMessage" class="alert alert-info rounded-3" style="display:none;">
                        <div class="spinner-border spinner-border-sm me-2"></div>Avvio del tracciamento GPS...
                    </div>

                    <!-- Stats -->
                    <div class="row mb-4" id="liveStats" style="display:none;">
                        <div class="col-3 stat-box"><div class="stat-value" id="timer">00:00:00</div><div class="stat-label">TEMPO</div></div>
                        <div class="col-3 stat-box"><div class="stat-value" id="distance">0.00</div><div class="stat-label">KM</div></div>
                        <div class="col-3 stat-box"><div class="stat-value" id="pace">0:00</div><div class="stat-label">MIN/KM</div></div>
                        <div class="col-3 stat-box"><div class="stat-value" id="speed">0.0</div><div class="stat-label">KM/H</div></div>
                    </div>

                    <!-- Barra progresso -->
                    <div class="progress mb-2" id="routeProgress" style="display:none;height:20px;">
                        <div class="progress-bar bg-success" style="width:0%">0%</div>
                    </div>

                    <!-- Mini mappa -->
                    <div id="miniMap" style="height:300px;display:none;" class="mb-3 rounded-3 border"></div>

                    <!-- Controlli -->
                    <div class="tracking-controls">
                        <button id="btnStop" class="btn btn-danger btn-lg rounded-pill" onclick="stopTracking()" style="display:none;">‚èπÔ∏è FERMA E SALVA</button>
                        <button id="btnPause" class="btn btn-warning btn-lg rounded-pill" onclick="pauseTracking()" style="display:none;">‚è∏Ô∏è PAUSA</button>
                        <span id="gpsIndicator"></span>
                    </div>

                    <!-- Messaggi stato -->
                    <div id="statusMessage" class="mt-3"></div>
                </div>
            </div>

            <!-- Modal istruzioni GPS -->
            <div class="modal fade" id="gpsInstructionsModal" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content rounded-4 shadow">
                        <div class="modal-header bg-warning rounded-top-4">
                            <h5 class="modal-title">‚ö†Ô∏è GPS Bloccato</h5>
                        </div>
                        <div class="modal-body">
                            <p>Per utilizzare il tracciamento, devi abilitare il GPS nel tuo browser.</p>
                            <h6>Chrome:</h6>
                            <ol>
                                <li>Clicca sull‚Äôicona üîí a sinistra della barra URL</li>
                                <li>Trova ‚ÄúPosizione‚Äù e seleziona ‚ÄúConsenti‚Äù</li>
                                <li>Ricarica la pagina</li>
                            </ol>
                            <h6>Firefox:</h6>
                            <ol>
                                <li>Clicca sull‚Äôicona a sinistra della barra URL</li>
                                <li>Seleziona ‚ÄúConsenti condivisione posizione‚Äù</li>
                                <li>Ricarica la pagina</li>
                            </ol>
                            <h6>Safari:</h6>
                            <ol>
                                <li>Vai su Preferenze ‚Üí Sito Web ‚Üí Posizione</li>
                                <li>Imposta ‚ÄúConsenti‚Äù per questo sito</li>
                                <li>Ricarica la pagina</li>
                            </ol>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary rounded-pill" data-bs-dismiss="modal">Chiudi</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal riepilogo attivit√† -->
            <div class="modal fade" id="activitySummaryModal" tabindex="-1">
              <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content rounded-4 shadow">
                  <div class="modal-header bg-success text-white rounded-top-4">
                    <h5 class="modal-title">üìä Riepilogo Attivit√†</h5>
                  </div>
                  <div class="modal-body">
                    <p><strong>Durata:</strong> <span id="summaryDuration">00:00:00</span></p>
                    <p><strong>Distanza:</strong> <span id="summaryDistance">0.00</span> km</p>
                    <p><strong>Velocit√† media:</strong> <span id="summarySpeed">0.0</span> km/h</p>
                    <p><strong>Ritmo medio:</strong> <span id="summaryPace">0:00</span> min/km</p>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">Annulla</button>
                    <button type="button" class="btn btn-success rounded-pill" id="confirmSaveBtn">üíæ Salva Attivit√†</button>
                  </div>
                </div>
              </div>
            </div>

        </div>
    </div>
</div>

<style>
.stat-box{padding:10px;background:#f8f9fa;border-radius:8px;border:2px solid #e9ecef;}
.stat-value{font-size:1.5em;font-weight:bold;color:#28a745;}
.stat-label{font-size:.8em;color:#6c757d;text-transform:uppercase;}
.tracking-controls .btn{margin:5px;min-width:180px;}
#gpsIndicator{display:inline-block;width:12px;height:12px;border-radius:50%;background:red;margin-left:5px;}
.gps-active{background:green;}
</style>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
// Activity Tracker con modal riepilogo
class ActivityTracker {
    constructor(){
        this.isTracking=false; this.isPaused=false;
        this.startTime=null; this.positions=[]; this.watchId=null; this.distance=0;
        this.miniMap=null; this.polyline=null; this.timerInterval=null;
    }

    async startTracking(){
        document.getElementById('autoStartMessage').style.display='block';
        this.initMiniMap();
        this.isTracking=true; this.isPaused=false;
        this.startTime=new Date(); this.positions=[]; this.distance=0;
        this.updateTimer();
        this.timerInterval=setInterval(()=>this.updateTimer(),1000);

        this.watchId=navigator.geolocation.watchPosition(
            pos=>this.handlePosition(pos),
            err=>this.handleError(err),
            {enableHighAccuracy:true,timeout:30000,maximumAge:2000}
        );

        document.getElementById('btnStart').style.display='none';
        document.getElementById('btnStop').style.display='inline-block';
        document.getElementById('btnPause').style.display='inline-block';
        document.getElementById('liveStats').style.display='flex';
        document.getElementById('miniMap').style.display='block';
        this.updateGPSIndicator(true);
        document.getElementById('autoStartMessage').style.display='none';
        this.showStatus("‚úÖ Tracciamento attivo!","success");
    }

    initMiniMap(){
        if(this.miniMap) return;
        this.miniMap=L.map('miniMap').setView([42.35,13.395],15); // zoom iniziale maggiore
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© OpenStreetMap'}).addTo(this.miniMap);
        this.polyline=L.polyline([], {color:'red'}).addTo(this.miniMap);
        this.miniMap.addControl(L.control.scale());
    }

    handlePosition(pos){
        const newPos={lat:pos.coords.latitude,lng:pos.coords.longitude,timestamp:new Date(),speed:pos.coords.speed||0};
        if(this.positions.length>0){
            const last=this.positions[this.positions.length-1];
            const d=this.calculateDistance(last.lat,last.lng,newPos.lat,newPos.lng);
            if(d<0.05) return;
            this.distance+=d;
        }
        this.positions.push(newPos);
        this.updateDisplay();
        this.updateMap(newPos);
        this.updateRouteProgress();
    }

    calculateDistance(lat1,lon1,lat2,lon2){
        const R=6371,dLat=(lat2-lat1)*Math.PI/180,dLon=(lon2-lon1)*Math.PI/180;
        const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
        return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    }

    updateDisplay(){
        this.updateTimer();
        document.getElementById('distance').textContent=this.distance.toFixed(2);
        const elapsedH=(new Date()-this.startTime)/3600000;
        if(elapsedH>0 && this.distance>0){
            const pace=(elapsedH*60)/this.distance;
            const m=Math.floor(pace), s=Math.floor((pace-m)*60);
            document.getElementById('pace').textContent=`${m}:${s.toString().padStart(2,'0')}`;
            document.getElementById('speed').textContent=(this.distance/elapsedH).toFixed(1);
        }
    }

    updateTimer(){
        if(!this.startTime) return;
        const e=new Date()-this.startTime,h=Math.floor(e/3600000),m=Math.floor((e%3600000)/60000),s=Math.floor((e%60000)/1000);
        document.getElementById('timer').textContent=`${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    }

    updateMap(pos){
        if(!this.miniMap) return;
        const ll=[pos.lat,pos.lng];
        this.polyline.addLatLng(ll);
        this.miniMap.setView(ll);
    }

    updateGPSIndicator(active){
        const el=document.getElementById('gpsIndicator');
        active?el.classList.add('gps-active'):el.classList.remove('gps-active');
    }

    updateRouteProgress(){
        const sel=document.getElementById('routeSelect');
        const opt=sel.options[sel.selectedIndex];
        const rd=parseFloat(opt.getAttribute('data-distance'))||0;
        if(rd>0){
            const p=Math.min(100,(this.distance/rd)*100);
            const bar=document.getElementById('routeProgress').querySelector('.progress-bar');
            bar.style.width=p+'%';
            bar.textContent=p.toFixed(0)+'%';
            document.getElementById('routeProgress').style.display='block';
        }
    }

    pauseTracking(){
        this.isPaused=!this.isPaused;
        if(this.isPaused){
            navigator.geolocation.clearWatch(this.watchId);
            document.getElementById('btnPause').innerHTML='‚ñ∂Ô∏è RIPRENDI';
            this.showStatus("Tracciamento in pausa","warning");
            this.updateGPSIndicator(false);
        } else {
            this.startTracking();
            document.getElementById('btnPause').innerHTML='‚è∏Ô∏è PAUSA';
        }
    }

    handleError(err){
        if(err.code===err.PERMISSION_DENIED){
            const modal=new bootstrap.Modal(document.getElementById('gpsInstructionsModal'));
            modal.show();
        } else {
            let msg="Errore GPS sconosciuto";
            if(err.code===err.POSITION_UNAVAILABLE) msg="Posizione non disponibile";
            if(err.code===err.TIMEOUT) msg="Timeout GPS";
            this.showStatus(msg,"danger");
        }
        this.updateGPSIndicator(false);
    }

    async stopTracking(){
        if(this.watchId) navigator.geolocation.clearWatch(this.watchId);
        if(this.timerInterval) clearInterval(this.timerInterval);
        this.isTracking=false;
        this.updateGPSIndicator(false);

        const sel=document.getElementById('routeSelect');
        this.route_id = sel.value || 1;

        this.duration = Math.max(1, Math.round((new Date()-this.startTime)/1000));
        this.distance = Math.max(0.1, this.distance);

        // Velocit√† media e ritmo
        const hours=this.duration/3600;
        this.avgSpeed=(this.distance/hours).toFixed(1);
        const paceM=Math.floor((hours*60)/this.distance);
        const paceS=Math.floor(((hours*60)/this.distance-paceM)*60);
        this.avgPace=`${paceM}:${paceS.toString().padStart(2,'0')}`;

        // Aggiorna modal riepilogo
        document.getElementById('summaryDuration').textContent = new Date(this.duration*1000).toISOString().substr(11,8);
        document.getElementById('summaryDistance').textContent = this.distance.toFixed(2);
        document.getElementById('summarySpeed').textContent = this.avgSpeed;
        document.getElementById('summaryPace').textContent = this.avgPace;

        const modal=new bootstrap.Modal(document.getElementById('activitySummaryModal'));
        modal.show();

        document.getElementById('confirmSaveBtn').onclick=async()=>{
            modal.hide();
            const data={ route_id:this.route_id, duration:this.duration, distance:this.distance, positions:this.positions, start_time:this.startTime.toISOString() };
            await this.saveActivity(data);
        };
    }

    async saveActivity(data){
        const statusEl=document.getElementById('statusMessage');
        try{
            statusEl.innerHTML=`<div class="alert alert-info">Salvataggio attivit√†...</div>`;
            const csrfMeta=document.querySelector('meta[name="csrf-token"]');
            const csrfToken = csrfMeta? csrfMeta.content:null;
            const headers={ 'Content-Type':'application/json' };
            if(csrfToken) headers['X-CSRFToken']=csrfToken;

            const res = await fetch('/api/save-live-activity',{ method:'POST', headers, body:JSON.stringify(data), credentials:'same-origin' });
            const contentType=res.headers.get("content-type")||"";
            if(!res.ok){
                const text=await res.text();
                console.error("Server returned error:", text);
                statusEl.innerHTML=`<div class="alert alert-danger">Errore server: ${res.status}</div>`;
                return;
            }
            if(!contentType.includes("application/json")){
                const text=await res.text();
                console.error("Server returned non-JSON:", text);
                statusEl.innerHTML=`<div class="alert alert-danger">Errore server: risposta non valida</div>`;
                return;
            }
            const r=await res.json();
            if(r.success){
                statusEl.innerHTML=`<div class="alert alert-success">‚úÖ ${r.message}</div>`;
                setTimeout(()=>window.location.href="{{ url_for('main.all_activities') }}",2000);
            }else{
                statusEl.innerHTML=`<div class="alert alert-danger">Errore: ${r.error}</div>`;
            }
        }catch(e){
            console.error("Fetch failed:",e);
            statusEl.innerHTML=`<div class="alert alert-danger">Errore di connessione: ${e.message}</div>`;
        }
    }

    showStatus(msg,type,timeout=5000){
        const el=document.getElementById('statusMessage');
        el.innerHTML=`<div class="alert alert-${type}">${msg}</div>`;
        if(timeout) setTimeout(()=>{el.innerHTML='';},timeout);
    }
}

const tracker=new ActivityTracker();

document.getElementById('btnStart').addEventListener('click',async()=>{
    if(!navigator.geolocation){ alert("GPS non supportato dal browser"); return; }
    try{
        await new Promise((resolve,reject)=>{ navigator.geolocation.getCurrentPosition(resolve,reject,{enableHighAccuracy:true}); });
        tracker.startTracking();
    }catch(e){
        const modal=new bootstrap.Modal(document.getElementById('gpsInstructionsModal'));
        modal.show();
    }
});

function stopTracking(){ tracker.stopTracking(); }
function pauseTracking(){ tracker.pauseTracking(); }
</script>
{% endblock %}
