{% extends "index.html" %}

{% block title %}Dettaglio Percorso: {{ route.name }}{% endblock %}

{% block content %}
<a href="{{ url_for('main.index') }}" class="btn btn-secondary mb-3">&larr; Torna alla Home</a>

<div class="card mb-4 shadow-sm">
    <div class="card-header bg-success text-white">
        <h2 class="mb-0">{{ route.name }}</h2>
    </div>
    <div class="card-body">
        <p><strong>Descrizione:</strong> {{ route.description or "Nessuna descrizione." }}</p>
        <p><strong>Distanza:</strong> {% if route.distance_km %}{{ "%.2f"|format(route.distance_km) }} km{% else %}N/D{% endif %}</p>
        <p><strong>Creato da:</strong> 
            <a href="{{ url_for('main.user_profile', user_id=route.creator.id) }}" class="user-link">{{ route.creator.username }}</a> 
            il {{ route.created_at.strftime('%d/%m/%Y %H:%M') }}
        </p>

        <!-- Mappa -->
        <h3 class="mt-4">Mappa del Percorso</h3>
        <div id="routeDetailMap" style="height:500px;width:100%;border:1px solid #ddd;border-radius:5px;"></div>

        <div class="d-grid gap-2 d-md-flex justify-content-md-start mt-4">
            <a href="{{ url_for('main.record_activity', route_id=route.id) }}" class="btn btn-primary">Registra Attività per questo Percorso</a>
        </div>
    </div>
</div>

<!-- Post (Esempio) -->
<div class="card my-4 shadow-sm">
    <div class="card-header bg-info text-white">
        <h3 class="mb-0">Post sul Percorso</h3>
    </div>
    <div class="card-body">
        <div class="card-body">
    {% for post in posts %}
        <p>ID: {{ post.id }} - Content: {{ post.content }}</p>
    {% else %}
        <p>Nessun post trovato</p>
    {% endfor %}
</div>

    </div>
</div>

<!-- Commenti -->
<div class="card my-4 shadow-sm">
    <div class="card-header bg-secondary text-white">
        <h3 class="mb-0">Commenti</h3>
    </div>
    <div class="card-body">
        {% if current_user.is_authenticated %}
            <form method="POST" id="commentForm" class="needs-validation" novalidate>
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="mb-3">
                    <label for="comment_content" class="form-label">Aggiungi un commento:</label>
                    <textarea id="comment_content" name="comment_content" rows="3" class="form-control" required></textarea>
                    <div class="invalid-feedback">Il commento non può essere vuoto.</div>
                </div>
                <button type="submit" class="btn btn-primary">Invia Commento</button>
            </form>
        {% else %}
            <p class="text-center text-muted">Accedi per aggiungere un commento. <a href="{{ url_for('auth.login') }}">Login</a></p>
        {% endif %}

        {% if comments_with_like_info %}
            <div class="list-group mt-3">
                {% for item in comments_with_like_info %}
                    {% set comment = item.comment %}
                    {% set like_count = item.like_count %}
                    {% set has_liked = item.has_liked %}
                    <div class="list-group-item mb-2">
                        <p class="mb-1">
                            <img src="{{ url_for('static', filename='profile_pics/' + comment.author.profile_image) }}" class="rounded-circle me-2 profile-image-small" alt="Avatar">
                            <strong><a href="{{ url_for('main.user_profile', user_id=comment.author.id) }}" class="user-link text-primary">{{ comment.author.username }}</a></strong>:
                        </p>
                        <p class="mb-1">{{ comment.content }}</p>
                        <small class="text-muted">{{ comment.created_at.strftime('%d/%m/%Y %H:%M') }}</small>
                        <div class="mt-2">
                            {% if current_user.is_authenticated %}
                                <button class="btn btn-sm {% if has_liked %}btn-primary liked{% else %}btn-outline-primary{% endif %} like-button" 
                                        data-comment-id="{{ comment.id }}">
                                    {% if has_liked %}Non Mi Piace più{% else %}Mi Piace{% endif %}
                                </button>
                                <span id="likes-count-{{ comment.id }}" class="ms-2 badge bg-light text-dark">{{ like_count }} Mi Piace</span>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="text-center text-muted mt-3">Ancora nessun commento. Sii il primo a lasciare un feedback!</p>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}

<script>
const csrfToken = "{{ csrf_token() }}";

// --- Toggle Like Commenti ---
document.querySelectorAll('.like-button').forEach(button => {
    button.addEventListener('click', function() {
        const commentId = this.dataset.commentId;
        if (!commentId) return console.error("Comment ID non definito!");

        const url = `{{ url_for('main.toggle_like', comment_id=0) }}`.replace('0', commentId);
        const currentButton = this;

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({})
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                // Aggiorna contatore Mi Piace
                const likesSpan = document.getElementById(`likes-count-${commentId}`);
                if (likesSpan) likesSpan.textContent = `${data.new_like_count} Mi Piace`;

                // Aggiorna bottone
                if (data.action === 'liked') {
                    currentButton.textContent = 'Non Mi Piace più';
                    currentButton.classList.remove('btn-outline-primary');
                    currentButton.classList.add('btn-primary', 'liked');
                } else {
                    currentButton.textContent = 'Mi Piace';
                    currentButton.classList.remove('btn-primary', 'liked');
                    currentButton.classList.add('btn-outline-primary');
                }
            } else {
                alert('Errore: ' + (data.message || 'Riprova più tardi'));
            }
        })
        .catch(err => console.error('Errore AJAX like commento:', err));
    });
});

// --- Toggle Like Post ---
document.querySelectorAll('.btn-like').forEach(button => {
    button.addEventListener('click', function() {
        const postId = this.dataset.postId;
        if (!postId) return console.error("Post ID non definito!");

        const url = `/post/${postId}/like`;
        const currentButton = this;

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({})
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                // Aggiorna contatore Mi Piace
                const likesSpan = document.getElementById(`likes-count-post-${postId}`);
                if (likesSpan) likesSpan.textContent = `${data.new_like_count} Mi Piace`;

                // Aggiorna bottone
                if (data.action === 'liked') {
                    currentButton.textContent = 'Non Mi Piace più';
                    currentButton.classList.remove('btn-outline-primary');
                    currentButton.classList.add('btn-primary', 'liked');
                } else {
                    currentButton.textContent = 'Mi Piace';
                    currentButton.classList.remove('btn-primary', 'liked');
                    currentButton.classList.add('btn-outline-primary');
                }
            } else {
                alert('Errore: ' + (data.message || 'Riprova più tardi'));
            }
        })
        .catch(err => console.error('Errore AJAX like post:', err));
    });
});
</script>

{% endblock %}
