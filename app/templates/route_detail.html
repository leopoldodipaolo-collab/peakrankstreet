{% extends "base.html" %}

{# ===================================================================== #}
{#               ### BLOCCO SEO SPECIFICO PER LA PAGINA ###                #}
{# ===================================================================== #}

{% block title %}{{ route.name }} - Percorso di {{ route.activity_type }} a {{ route.classic_city or 'PeakRankStreet' }}{% endblock %}

{% block description %}Scopri i dettagli del percorso di {{ route.activity_type }} '{{ route.name }}' a {{ route.classic_city or 'PeakRankStreet' }}: distanza {{ "%.1f"|format(route.distance_km) }} km, dislivello {{ route.elevation_gain or 'N/D' }}m e classifica. Unisciti alla community!{% endblock %}

{# Se il percorso ha un'immagine, la usiamo per l'anteprima social, altrimenti usa quella di default del sito #}
{% block og_image %}{{ url_for('static', filename='featured_routes/' + route.featured_image, _external=True) if route.featured_image else super() }}{% endblock %}


{# ===================================================================== #}
{#               ### FINE BLOCCO SEO ###                                 #}
{# ===================================================================== #}

{% block content %}
<div class="container my-5 pt-5">

    <!-- HERO SECTION -->
    <div class="position-relative mb-5">
        <img src="{{ url_for('static', filename='featured_routes/' + (route.featured_image or 'default_route.jpg')) }}" 
             class="img-fluid rounded-4 shadow w-100" 
             alt="Mappa del percorso {{ route.name }}" 
             style="max-height: 400px; object-fit: cover;">
   <div class="position-absolute bottom-0 start-0 w-100 p-4 rounded-bottom-4" 
     style="background: linear-gradient(to top, rgba(0,0,0,0.9), rgba(0,0,0,0));">
    <h1 class="text-white fw-bold mb-1">{{ route.name }}</h1>
    <p class="text-white-50 mb-2">
        {{ route.activity_type or 'Attività' }} • Creato da {{ route.creator.username }} il {{ route.created_at.strftime('%d/%m/%Y') }}
    </p>
    <a href="{{ url_for('main.record_activity', route_id=route.id) }}" class="btn btn-light btn-sm">
        <i class="bi bi-play-circle me-1"></i> Registra Attività
    </a>
</div>


    </div>

    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{{ url_for('main.index') }}" class="text-decoration-none">Home</a>
            </li>
            <li class="breadcrumb-item active text-primary fw-semibold">Dettaglio Percorso</li>
        </ol>
    </nav>

    <div class="row g-4">
        <!-- MAIN COLUMN -->
        <div class="col-lg-8">

            <!-- MAPPA -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-map me-2"></i>Mappa del Percorso</h5>
                </div>
                <div class="card-body p-0">
                    <div id="routeDetailMap" style="height: 420px; background-color: #f0f2f5; border-radius: 0 0 0.5rem 0.5rem;">
                        
                        <div id="routeDetailMap" style="height: 400px; background: #f8f9fa;">
                        <div class="h-100 d-flex justify-content-center align-items-center">
                            <div class="text-center text-muted">
                                <i class="bi bi-map display-4 mb-3"></i>
                                <p>Caricamento mappa...</p>
                            </div>
                        </div>
                    </div>
                    </div>
                </div>
            </div>

            <!-- DESCRIZIONE -->
            {% if route.description %}
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="fw-bold mb-3 text-primary"><i class="bi bi-info-circle me-2"></i>Descrizione</h5>
                    <p class="text-muted mb-0">{{ route.description }}</p>
                </div>
            </div>
            {% endif %}

            <!-- COMMENTI -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-chat-dots me-2"></i>Commenti</h5>
                </div>
                <div class="card-body">
                    {% if current_user.is_authenticated %}
                    <form method="POST" class="mb-4">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="d-flex gap-3">
                            <img src="{{ url_for('main.uploaded_file', filename='profile_pics/' + current_user.profile_image) }}" 
                                 class="rounded-circle" width="50" height="50" alt="{{ current_user.username }}">
                            <div class="flex-grow-1">
                                <textarea name="comment_content" class="form-control" rows="3" placeholder="Scrivi un commento..." required></textarea>
                                <button type="submit" class="btn btn-primary btn-sm mt-2 float-end">
                                    <i class="bi bi-send me-1"></i> Invia
                                </button>
                            </div>
                        </div>
                    </form>
                    {% else %}
                    <div class="alert alert-info">
                        <a href="{{ url_for('auth.login') }}" class="alert-link">Accedi</a> per aggiungere un commento.
                    </div>
                    {% endif %}

                    {% if comments_with_like_info %}
                        {% for item in comments_with_like_info %}
                        <div class="d-flex mb-4 pb-3 border-bottom">
                            <img src="{{ url_for('main.uploaded_file', filename='profile_pics/' + item.comment.author.profile_image) }}" 
                                 class="rounded-circle me-3" width="50" height="50" alt="{{ item.comment.author.username }}">
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between">
                                    <h6 class="fw-bold mb-0">{{ item.comment.author.username }}</h6>
                                    <small class="text-muted">{{ item.comment.created_at.strftime('%d/%m/%Y %H:%M') }}</small>
                                </div>
                                <p class="text-muted mb-2 mt-1">{{ item.comment.content }}</p>
                                <div class="d-flex align-items-center gap-2">
                                    {% if current_user.is_authenticated %}
                                    <button class="btn btn-sm btn-outline-primary like-button" data-comment-id="{{ item.comment.id }}">
                                        <i class="bi bi-hand-thumbs-up"></i> Mi piace
                                    </button>
                                    {% endif %}
                                    <span class="small text-muted">{{ item.like_count }} mi piace</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-chat-quote display-5 mb-3"></i>
                            <p>Nessun commento ancora. Sii il primo a condividere la tua esperienza!</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- SIDEBAR -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Statistiche & Info</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-4">
                        <li class="mb-2"><strong>Tipo:</strong> {{ route.activity_type or 'Non specificato' }}</li>
                        <li class="mb-2"><strong>Difficoltà:</strong> {{ route.difficulty or 'N/D' }}</li>
                        <li class="mb-2"><strong>Dislivello:</strong> {{ route.elevation_gain or '0' }} m</li>
                        <li class="mb-2"><strong>Distanza:</strong> {{ "%.1f"|format(route.distance_km) if route.distance_km else '0.0' }} km</li>
                        <li class="mb-2"><strong>Creato da:</strong> 
                            <a href="{{ url_for('main.user_profile', user_id=route.creator.id) }}" class="text-decoration-none">
                                {{ route.creator.username }}
                            </a>
                        </li>
                        <li><strong>Data creazione:</strong> {{ route.created_at.strftime('%d/%m/%Y') }}</li>
                    </ul>
                    <hr>
                    <div class="text-center">
                        <h6 class="fw-bold text-secondary mb-2">Record del percorso</h6>
                        {% set fastest = top_5_activities_for_route[0][0] if top_5_activities_for_route else None %}
                        {% if fastest %}
                        <div class="display-6 fw-bold text-warning">{{ '%02d:%02d'|format(fastest.duration // 3600, (fastest.duration % 3600) // 60) }}</div>
                        {% else %}
                        <div class="text-muted">Nessun record disponibile</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-trophy me-2"></i>Top 5 Classifica</h5>
                </div>
                <div class="list-group list-group-flush">
                    {% for activity_tuple in top_5_activities_for_route %}
                        {% set activity = activity_tuple[0] %}
                        {% set user = activity_tuple[1] %}
                        <div class="list-group-item d-flex align-items-center">
                            <span class="fw-bold text-primary me-3">#{{ loop.index }}</span>
                            <img src="{{ url_for('main.uploaded_file', filename='profile_pics/' + user.profile_image) }}" 
                                 class="rounded-circle me-2" width="36" height="36" alt="{{ user.username }}">
                            <a href="{{ url_for('main.user_profile', user_id=user.id) }}" class="text-decoration-none text-dark flex-grow-1">
                                {{ user.username }}
                            </a>
                            <span class="fw-semibold text-muted">
                                {{ '%02d:%02d'|format(activity.duration // 3600, (activity.duration % 3600) // 60) }}
                            </span>
                        </div>
                    {% else %}
                        <div class="list-group-item text-center text-muted py-4">
                            <i class="bi bi-emoji-neutral display-5 d-block mb-2"></i>
                            <p class="mb-0">Nessuna attività registrata</p>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}

{# ===================================================================== #}
{#      ### NUOVO CODICE: SCRIPT PER I DATI STRUTTURATI (JSON-LD) ###      #}
{# ===================================================================== #}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "SportsActivityLocation",
  "name": "{{ route.name | escape }}",
  "description": "{{ route.description | striptags | escape | truncate(250) }}",
  "url": "{{ request.url }}",
  {% if route.featured_image %}
  "image": "{{ url_for('static', filename='featured_routes/' + route.featured_image, _external=True) }}",
  {% endif %}
  "address": {
    "@type": "PostalAddress",
    "addressLocality": "{{ route.classic_city or '' }}",
    "addressCountry": "IT"
  },
  "geo": {
    "@type": "GeoShape",
    "line": "{% if route_geojson_data and route_geojson_data.geometry and route_geojson_data.geometry.coordinates %}{% for point in route_geojson_data.geometry.coordinates %}{{ point[1] }} {{ point[0] }}{% if not loop.last %} {% endif %}{% endfor %}{% endif %}"
  }
}
</script>
{# ===================================================================== #}
{#               ### FINE SCRIPT DATI STRUTTURATI ###                    #}
{# ===================================================================== #}


<script>
    // Definisci la variabile globale per i dati della mappa
    const routeGeoJSON = {{ route_geojson_data|tojson }};
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    let map = null;
    
    // --- MAP INITIALIZATION ---
    function initRouteMap() {
        const mapElement = document.getElementById('routeDetailMap');
        
        if (!mapElement) {
            console.warn('Elemento routeDetailMap non trovato');
            return;
        }

        // Aspetta che l'elemento sia completamente renderizzato
        setTimeout(() => {
            try {
                // Inizializza la mappa con vista di default
                map = L.map('routeDetailMap').setView([42.44, 13.56], 13);
                
                // Aggiungi il layer delle tile
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    maxZoom: 20
                }).addTo(map);

                // Verifica e aggiungi il percorso
                if (routeGeoJSON && routeGeoJSON !== "{}") {
                    try {
                        const geojsonData = typeof routeGeoJSON === 'string' ? JSON.parse(routeGeoJSON) : routeGeoJSON;
                        
                        if (geojsonData.geometry && geojsonData.geometry.coordinates && geojsonData.geometry.coordinates.length > 0) {
                            const routeLayer = L.geoJSON(geojsonData, {
                                style: { 
                                    color: '#0d6efd', 
                                    weight: 6, 
                                    opacity: 0.8,
                                    lineCap: 'round'
                                }
                            }).addTo(map);
                            
                            // Aggiungi marker di partenza e arrivo
                            const coords = geojsonData.geometry.coordinates;
                            if (coords.length > 0) {
                                const startIcon = L.divIcon({ 
                                    html: '<i class="bi bi-play-circle-fill fs-4 text-success"></i>', 
                                    className: 'bg-transparent border-0'
                                });
                                const endIcon = L.divIcon({ 
                                    html: '<i class="bi bi-flag-fill fs-4 text-danger"></i>', 
                                    className: 'bg-transparent border-0'
                                });
                                
                                // Marker partenza (prima coordinata)
                                L.marker([coords[0][1], coords[0][0]], { 
                                    icon: startIcon 
                                }).addTo(map).bindPopup('<strong>Partenza</strong>');
                                
                                // Marker arrivo (ultima coordinata)
                                L.marker([coords[coords.length - 1][1], coords[coords.length - 1][0]], { 
                                    icon: endIcon 
                                }).addTo(map).bindPopup('<strong>Arrivo</strong>');
                                
                                // Adatta la vista al percorso
                                map.fitBounds(routeLayer.getBounds(), { 
                                    padding: [20, 20],
                                    maxZoom: 15
                                });
                            }
                        } else {
                            throw new Error('Struttura GeoJSON non valida');
                        }
                    } catch (error) {
                        console.error('Errore nel parsing GeoJSON:', error);
                        showMapError('Errore nel caricamento del percorso');
                    }
                } else {
                    showMapError('Dati percorso non disponibili');
                }

            } catch (error) {
                console.error('Errore durante l\'inizializzazione della mappa:', error);
                showMapError('Errore nel caricamento della mappa');
            }
        }, 500);
    }

    function showMapError(message) {
        const mapElement = document.getElementById('routeDetailMap');
        if (mapElement) {
            mapElement.innerHTML = `
                <div class="h-100 d-flex justify-content-center align-items-center text-muted">
                    <div class="text-center">
                        <i class="bi bi-exclamation-triangle display-4 mb-3"></i>
                        <p>${message}</p>
                    </div>
                </div>
            `;
        }
    }

    // Inizializza la mappa
    initRouteMap();

    // --- LIKE BUTTONS LOGIC ---
    const csrfToken = "{{ csrf_token() }}";
    document.querySelectorAll('.like-button').forEach(button => {
        button.addEventListener('click', function() {
            const commentId = this.dataset.commentId;
            if (!commentId) return;
            
            const url = `{{ url_for('main.toggle_like', comment_id=0) }}`.replace('0', commentId);
            
            fetch(url, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json', 
                    'X-CSRFToken': csrfToken 
                },
                body: JSON.stringify({})
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    const likesSpan = document.getElementById(`likes-count-${commentId}`);
                    if (likesSpan) {
                        likesSpan.textContent = `${data.new_like_count} Mi Piace`;
                    }
                    this.classList.toggle('text-primary', data.action === 'liked');
                    this.classList.toggle('text-muted', data.action !== 'liked');
                }
            })
            .catch(error => {
                console.error('Errore durante il like:', error);
            });
        });
    });
});
</script>
{% endblock %}