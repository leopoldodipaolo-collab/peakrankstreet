{% extends "base.html" %}

{% block title %}Dettaglio Percorso: {{ route.name }}{% endblock %}

{% block content %}
<div class="container my-5 pt-5">
    <!-- Intestazione -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 fw-bold text-dark">{{ route.name }}</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}" class="text-decoration-none">Home</a></li>
                    <li class="breadcrumb-item active">Dettaglio Percorso</li>
                </ol>
            </nav>
        </div>
        <a href="{{ url_for('main.record_activity', route_id=route.id) }}" class="btn btn-primary">
            <i class="bi bi-play-circle me-2"></i>Registra Attività
        </a>
    </div>

    <div class="row">
        <!-- Colonna Principale -->
        <div class="col-lg-8">
            <!-- Mappa -->
            <div class="card mb-4">
                <div class="card-header bg-primary">
                    <h5 class="mb-0"><i class="bi bi-map me-2"></i>Mappa del Percorso</h5>
                </div>
                <div class="card-body p-0">
                    <div id="routeDetailMap" style="height: 400px; background: #f8f9fa;">
                        <div class="h-100 d-flex justify-content-center align-items-center">
                            <div class="text-center text-muted">
                                <i class="bi bi-map display-4 mb-3"></i>
                                <p>Caricamento mappa...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Commenti -->
            <div class="card">
                <div class="card-header bg-primary">
                    <h5 class="mb-0"><i class="bi bi-chat me-2"></i>Commenti</h5>
                </div>
                <div class="card-body">
                    {% if current_user.is_authenticated %}
                    <form method="POST" class="mb-4">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="d-flex gap-2">
                            <img src="{{ url_for('static', filename='profile_pics/' + current_user.profile_image) }}" 
                                 class="rounded-circle" width="40" height="40" alt="{{ current_user.username }}">
                            <div class="flex-grow-1">
                                <textarea name="comment_content" class="form-control" rows="3" 
                                          placeholder="Condividi la tua esperienza..." required></textarea>
                                <div class="mt-2">
                                    <button type="submit" class="btn btn-primary btn-sm">Invia commento</button>
                                </div>
                            </div>
                        </div>
                    </form>
                    {% else %}
                    <div class="alert alert-info">
                        <a href="{{ url_for('auth.login') }}" class="alert-link">Accedi</a> per commentare.
                    </div>
                    {% endif %}

                    <div class="comments-section">
                        {% for item in comments_with_like_info %}
                        <div class="d-flex mb-3">
                            <img src="{{ url_for('static', filename='profile_pics/' + item.comment.author.profile_image) }}" 
                                 class="rounded-circle me-3" width="50" height="50" alt="{{ item.comment.author.username }}">
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-start mb-1">
                                    <strong>{{ item.comment.author.username }}</strong>
                                    <small class="text-muted">{{ item.comment.created_at.strftime('%d/%m/%Y %H:%M') }}</small>
                                </div>
                                <p class="mb-1">{{ item.comment.content }}</p>
                                <div class="d-flex align-items-center gap-2">
                                    {% if current_user.is_authenticated %}
                                    <button class="btn btn-sm btn-outline-primary like-button" 
                                            data-comment-id="{{ item.comment.id }}">
                                        <i class="bi bi-hand-thumbs-up"></i> Mi Piace
                                    </button>
                                    {% endif %}
                                    <span class="text-muted small">{{ item.like_count }} mi piace</span>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="text-center py-4 text-muted">
                            <i class="bi bi-chat-quote display-4 mb-3"></i>
                            <p>Ancora nessun commento. Sii il primo a commentare!</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Informazioni Percorso -->
            <div class="card mb-4">
                <div class="card-header bg-primary">
                    <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Informazioni</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">{{ route.description or "Nessuna descrizione disponibile." }}</p>
                    
                    <div class="list-group list-group-flush">
                        <div class="list-group-item d-flex justify-content-between px-0">
                            <span>Tipo:</span>
                            <strong>{{ route.activity_type or 'Non specificato' }}</strong>
                        </div>
                        <div class="list-group-item d-flex justify-content-between px-0">
                            <span>Creato da:</span>
                            <strong>
                                <a href="{{ url_for('main.user_profile', user_id=route.creator.id) }}" class="text-decoration-none">
                                    {{ route.creator.username }}
                                </a>
                            </strong>
                        </div>
                        <div class="list-group-item d-flex justify-content-between px-0">
                            <span>Data creazione:</span>
                            <strong>{{ route.created_at.strftime('%d/%m/%Y') }}</strong>
                        </div>
                        {% if route.difficulty %}
                        <div class="list-group-item d-flex justify-content-between px-0">
                            <span>Difficoltà:</span>
                            <strong>{{ route.difficulty }}</strong>
                        </div>
                        {% endif %}
                        {% if route.elevation_gain %}
                        <div class="list-group-item d-flex justify-content-between px-0">
                            <span>Dislivello:</span>
                            <strong>{{ route.elevation_gain }} m</strong>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Statistiche -->
            <div class="card mb-4">
                <div class="card-header bg-primary">
                    <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Statistiche</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="h5 fw-bold text-primary">{{ "%.1f"|format(route.distance_km) if route.distance_km else '0.0' }}</div>
                            <small class="text-muted">km</small>
                        </div>
                        <div class="col-4">
                            <div class="h5 fw-bold text-success">{{ route.activities.count() }}</div>
                            <small class="text-muted">Attività</small>
                        </div>
                        <div class="col-4">
                            {% set fastest = top_5_activities_for_route[0][0] if top_5_activities_for_route else None %}
                            <div class="h5 fw-bold text-warning">
                                {% if fastest %}
                                    {{ '%02d:%02d'|format(fastest.duration // 3600, (fastest.duration % 3600) // 60) }}
                                {% else %}
                                    N/D
                                {% endif %}
                            </div>
                            <small class="text-muted">Record</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Classifica -->
            <div class="card">
                <div class="card-header bg-primary">
                    <h5 class="mb-0"><i class="bi bi-trophy me-2"></i>Classifica</h5>
                </div>
                <div class="list-group list-group-flush">
                    {% for activity_tuple in top_5_activities_for_route %}
                        {% set activity = activity_tuple[0] %}
                        {% set user = activity_tuple[1] %}
                        <div class="list-group-item d-flex align-items-center">
                            <span class="fw-bold me-3">#{{ loop.index }}</span>
                            <img src="{{ url_for('static', filename='profile_pics/' + user.profile_image) }}" 
                                 class="rounded-circle me-2" width="32" height="32" alt="{{ user.username }}">
                            <a href="{{ url_for('main.user_profile', user_id=user.id) }}" class="text-decoration-none text-dark me-auto">
                                {{ user.username }}
                            </a>
                            <span class="fw-semibold">
                                {{ '%02d:%02d'|format(activity.duration // 3600, (activity.duration % 3600) // 60) }}
                            </span>
                        </div>
                    {% else %}
                        <div class="list-group-item text-center text-muted">
                            <i class="bi bi-trophy display-4 mb-2"></i>
                            <p>Nessuna attività registrata</p>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // Definisci la variabile globale per i dati della mappa
    const routeGeoJSON = {{ route_geojson_data|tojson }};
    console.log('Dati GeoJSON:', routeGeoJSON); // Debug
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    let map = null;
    
    // --- MAP INITIALIZATION ---
    function initRouteMap() {
        const mapElement = document.getElementById('routeDetailMap');
        
        if (!mapElement) {
            console.warn('Elemento routeDetailMap non trovato');
            return;
        }

        // Aspetta che l'elemento sia completamente renderizzato
        setTimeout(() => {
            try {
                // Inizializza la mappa con vista di default
                map = L.map('routeDetailMap').setView([42.44, 13.56], 13);
                
                // Aggiungi il layer delle tile
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    maxZoom: 20
                }).addTo(map);

                // Verifica e aggiungi il percorso
                if (routeGeoJSON && routeGeoJSON !== "{}") {
                    try {
                        const geojsonData = typeof routeGeoJSON === 'string' ? JSON.parse(routeGeoJSON) : routeGeoJSON;
                        
                        if (geojsonData.geometry && geojsonData.geometry.coordinates && geojsonData.geometry.coordinates.length > 0) {
                            const routeLayer = L.geoJSON(geojsonData, {
                                style: { 
                                    color: '#0d6efd', 
                                    weight: 6, 
                                    opacity: 0.8,
                                    lineCap: 'round'
                                }
                            }).addTo(map);
                            
                            // Aggiungi marker di partenza e arrivo
                            const coords = geojsonData.geometry.coordinates;
                            if (coords.length > 0) {
                                const startIcon = L.divIcon({ 
                                    html: '<i class="bi bi-play-circle-fill fs-4 text-success"></i>', 
                                    className: 'bg-transparent border-0'
                                });
                                const endIcon = L.divIcon({ 
                                    html: '<i class="bi bi-flag-fill fs-4 text-danger"></i>', 
                                    className: 'bg-transparent border-0'
                                });
                                
                                // Marker partenza (prima coordinata)
                                L.marker([coords[0][1], coords[0][0]], { 
                                    icon: startIcon 
                                }).addTo(map).bindPopup('<strong>Partenza</strong>');
                                
                                // Marker arrivo (ultima coordinata)
                                L.marker([coords[coords.length - 1][1], coords[coords.length - 1][0]], { 
                                    icon: endIcon 
                                }).addTo(map).bindPopup('<strong>Arrivo</strong>');
                                
                                // Adatta la vista al percorso
                                map.fitBounds(routeLayer.getBounds(), { 
                                    padding: [20, 20],
                                    maxZoom: 15
                                });
                            }
                        } else {
                            throw new Error('Struttura GeoJSON non valida');
                        }
                    } catch (error) {
                        console.error('Errore nel parsing GeoJSON:', error);
                        showMapError('Errore nel caricamento del percorso');
                    }
                } else {
                    showMapError('Dati percorso non disponibili');
                }

            } catch (error) {
                console.error('Errore durante l\'inizializzazione della mappa:', error);
                showMapError('Errore nel caricamento della mappa');
            }
        }, 500);
    }

    function showMapError(message) {
        const mapElement = document.getElementById('routeDetailMap');
        if (mapElement) {
            mapElement.innerHTML = `
                <div class="h-100 d-flex justify-content-center align-items-center text-muted">
                    <div class="text-center">
                        <i class="bi bi-exclamation-triangle display-4 mb-3"></i>
                        <p>${message}</p>
                    </div>
                </div>
            `;
        }
    }

    // Inizializza la mappa
    initRouteMap();

    // --- LIKE BUTTONS LOGIC ---
    const csrfToken = "{{ csrf_token() }}";
    document.querySelectorAll('.like-button').forEach(button => {
        button.addEventListener('click', function() {
            const commentId = this.dataset.commentId;
            if (!commentId) return;
            
            const url = `{{ url_for('main.toggle_like', comment_id=0) }}`.replace('0', commentId);
            
            fetch(url, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json', 
                    'X-CSRFToken': csrfToken 
                },
                body: JSON.stringify({})
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    const likesSpan = document.getElementById(`likes-count-${commentId}`);
                    if (likesSpan) {
                        likesSpan.textContent = `${data.new_like_count} Mi Piace`;
                    }
                    this.classList.toggle('text-primary', data.action === 'liked');
                    this.classList.toggle('text-muted', data.action !== 'liked');
                }
            })
            .catch(error => {
                console.error('Errore durante il like:', error);
            });
        });
    });
});
</script>
{% endblock %}