{% extends "index.html" %}

{% block title %}Profilo di {{ user.username }}{% endblock %}

{% block content %}
    <!-- MODIFICATO -->
    <a href="{{ url_for('main.index') }}" class="btn btn-secondary mb-3">&larr; Torna alla Home</a>
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
            <h2 class="mb-0">Profilo Utente: {{ user.username }}</h2>
            {% if current_user.is_authenticated and current_user.id == user.id %}
                <!-- MODIFICATO -->
                <a href="{{ url_for('main.edit_profile') }}" class="btn btn-light btn-sm">Modifica Profilo</a>
            {% endif %}
        </div>
        <div class="card-body text-center">
            <!-- 'static' non cambia -->
            <img src="{{ url_for('static', filename='profile_pics/' + user.profile_image) }}" class="rounded-circle mb-3 border border-3 border-dark" alt="Immagine di profilo" style="width: 150px; height: 150px; object-fit: cover;">
            <p class="card-text"><strong>Email:</strong> {{ user.email }}</p>
            <p class="card-text"><strong>Iscritto dal:</strong> {{ user.created_at.strftime('%d/%m/%Y') }}</p>
            {% if user.city %}
                <p class="card-text"><strong>Citt√†:</strong> {{ user.city }}</p>
            {% endif %}

            <div class="mt-3">
                {% if current_user.is_authenticated and user != current_user %}
                    {% if not current_user.is_following(user) %}
                        <!-- MODIFICATO -->
                        <a href="{{ url_for('main.follow', username=user.username) }}" class="btn btn-primary">
                            <i class="bi bi-person-plus-fill"></i> Segui
                        </a>
                    {% else %}
                        <!-- MODIFICATO -->
                        <a href="{{ url_for('main.unfollow', username=user.username) }}" class="btn btn-outline-secondary">
                            <i class="bi bi-person-check-fill"></i> Segui gi√†
                        </a>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>

    <div class="card my-4 shadow-sm">
        <div class="card-header bg-primary text-white">
            <h3 class="mb-0">Statistiche di {{ user.username }}</h3>
        </div>
        <div class="card-body">
            <div class="row text-center">
                <div class="col-6 col-md-3 mb-3">
                    <h5 class="text-primary">{{ "%.2f"|format(total_distance) }} km</h5>
                    <small class="text-muted">Distanza Totale Percorsa</small>
                </div>
                <div class="col-6 col-md-3 mb-3">
                    <h5 class="text-success">{{ total_activities }}</h5>
                    <small class="text-muted">Attivit√† Registrate</small>
                </div>
                <div class="col-6 col-md-3 mb-3">
                    <h5 class="text-info">{{ total_routes_created }}</h5>
                    <small class="text-muted">Percorsi Creati</small>
                </div>
                <div class="col-6 col-md-3 mb-3">
                    <h5 class="text-warning">{{ total_records_held }}</h5>
                    <small class="text-muted">Record Detenuti</small>
                </div>
                <div class="col-6 col-md-3 mb-3">
                    <h5 class="text-secondary">{{ followers_count }}</h5>
                    <small class="text-muted">Follower</small>
                </div>
                <div class="col-6 col-md-3 mb-3">
                    <h5 class="text-secondary">{{ followed_count }}</h5>
                    <small class="text-muted">Seguiti</small>
                </div>
            </div>
        </div>
    </div>


    <div class="card my-4 shadow-sm">
        <div class="card-header bg-warning text-dark">
            <h3 class="mb-0">I miei Badge</h3>
        </div>
        <div class="card-body">
            {% if user.user_badges %}
                <div class="d-flex flex-wrap justify-content-center">
                    {% for user_badge in user.user_badges %}
                        <div class="text-center m-2 p-2 border rounded shadow-sm" style="width: 120px;">
                            <!-- 'static' non cambia -->
                            <img src="{{ url_for('static', filename='badges/' + user_badge.badge_info.image_url) }}" class="img-fluid mb-1" alt="{{ user_badge.badge_info.name }}" style="width: 60px; height: 60px; object-fit: contain;">
                            <p class="fw-bold mb-0">{{ user_badge.badge_info.name }}</p>
                            <small class="text-muted">{{ user_badge.awarded_at.strftime('%d/%m/%Y') }}</small>
                            <span class="d-block badge bg-info mt-1" data-bs-toggle="tooltip" data-bs-placement="top" title="{{ user_badge.badge_info.description }}">Info</span>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-center text-muted mt-3">Ancora nessun badge. Inizia a esplorare e registrare attivit√†!</p>
            {% endif %}
        </div>
    </div>


    <div class="card my-4 shadow-sm">
        <div class="card-header bg-success text-white">
            <h3 class="mb-0">Percorsi Creati da {{ user.username }}</h3>
        </div>
        <div class="card-body">
            <!-- Attenzione: user.routes √® una query dynamic, quindi dobbiamo chiamare .all() o iterarla -->
            {% if user.routes.count() > 0 %}
                <div class="list-group">
                    {% for route in user.routes.order_by(Route.created_at.desc()).all() %}
                        <!-- MODIFICATO -->
                        <a href="{{ url_for('main.route_detail', route_id=route.id) }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center mb-2">
                            <div class="route-info">
                                <h5 class="mb-1 text-success">{{ route.name }}</h5>
                                <p class="mb-1">{{ route.description if route.description else "Nessuna descrizione." }}</p>
                                <small class="text-muted">Distanza: {{ "%.2f"|format(route.distance_km) }} km</small>
                            </div>
                            <div class="route-actions">
                                <span class="btn btn-sm btn-outline-success">Dettagli</span>
                            </div>
                        </a>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-center text-muted mt-3">Nessun percorso creato.</p>
            {% endif %}
        </div>
    </div>

    <div class="card my-4 shadow-sm">
        <div class="card-header bg-info text-white">
            <h3 class="mb-0">Attivit√† Recenti di {{ user.username }}</h3>
        </div>
        <div class="card-body">
            {% if user_activities %}
                <div class="list-group">
                    {% for activity in user_activities %}
                        <!-- MODIFICATO -->
                        <a href="{{ url_for('main.activity_detail', activity_id=activity.id) }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center mb-2">
                            <div class="route-info">
                                <h5 class="mb-1">Attivit√† su: <span class="text-success">{{ activity.route_activity.name }}</span></h5>
                                <p class="small mb-1">Distanza: <strong>{{ "%.2f"|format(activity.distance) }} km</strong> |
                                Tempo:
                                    {% set hours = activity.duration // 3600 %}
                                    {% set minutes = (activity.duration % 3600) // 60 %}
                                    {% set seconds = activity.duration % 60 %}
                                    <strong>{{ "%02d:%02d:%02d"|format(hours, minutes, seconds) }}</strong>
                                </p>
                                <small class="text-muted">Registrata il: {{ activity.created_at.strftime('%d/%m/%Y %H:%M') }}</small>
                                {% if activity.challenge_info %}
                                    <br><small class="text-muted">Parte della sfida: <strong>{{ activity.challenge_info.name }}</strong></small>
                                {% endif %}
                            </div>
                            <div class="route-actions">
                                <span class="btn btn-sm btn-outline-info">Dettagli Attivit√†</span>
                            </div>
                        </a>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-center text-muted mt-3">Nessuna attivit√† registrata.</p>
            {% endif %}
        </div>
    </div>

    <!-- Sostituisci la sezione scommesse con: -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-warning text-dark">
            <h5 class="mb-0">üí∞ Resoconto Scommesse</h5>
        </div>
        <div class="card-body">
            <!-- Tab Navigation -->
            <ul class="nav nav-tabs mb-3" id="betsTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="active-tab" data-bs-toggle="tab" 
                            data-bs-target="#active" type="button" role="tab">
                        ‚è≥ Attive ({{ (bets_won|selectattr('status', 'equalto', 'pending')|list|length) + (bets_lost|selectattr('status', 'equalto', 'pending')|list|length) }})
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="history-tab" data-bs-toggle="tab" 
                            data-bs-target="#history" type="button" role="tab">
                        üìö Storico ({{ (bets_won|selectattr('status', 'equalto', 'paid')|list|length) + (bets_lost|selectattr('status', 'equalto', 'paid')|list|length) }})
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="betsTabContent">
                <!-- TAB ATTIVE -->
                <div class="tab-pane fade show active" id="active" role="tabpanel">
                    <div class="row text-center">
                        <div class="col-md-4">
                            <h6>üç∫ Ti Devono</h6>
                            {% set pending_won = bets_won|selectattr('status', 'equalto', 'pending')|list %}
                            <span class="badge bg-success fs-6">{{ pending_won|length }}</span>
                            <div class="mt-2">
                                {% for bet in pending_won %}
                                <small class="d-block text-muted">
                                    <strong>{{ bet.bet_value }}</strong> da 
                                    <a href="{{ url_for('main.user_profile', user_id=bet.loser.id) }}">
                                        {{ bet.loser.username }}
                                    </a>
                                    <span class="badge bg-warning btn-sm">In attesa</span>
                                </small>
                                {% else %}
                                <small class="text-muted">Nessuna scommessa attiva</small>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <h6>üí∏ Devi Pagare</h6>
                            {% set pending_lost = bets_lost|selectattr('status', 'equalto', 'pending')|list %}
                            <span class="badge bg-danger fs-6">{{ pending_lost|length }}</span>
                            <div class="mt-2">
                                {% for bet in pending_lost %}
                                <small class="d-block text-muted">
                                    <strong>{{ bet.bet_value }}</strong> a 
                                    <a href="{{ url_for('main.user_profile', user_id=bet.winner.id) }}">
                                        {{ bet.winner.username }}
                                    </a>
                                    <a href="{{ url_for('main.mark_bet_paid', bet_id=bet.id) }}" 
                                    class="badge bg-primary btn-sm" 
                                    onclick="return confirm('Segnare come pagata?')">
                                        Segna come pagato
                                    </a>
                                </small>
                                {% else %}
                                <small class="text-muted">Nessun debito attivo</small>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <h6>‚öñÔ∏è Saldo Attivo</h6>
                            {% set active_balance = pending_won|length - pending_lost|length %}
                            <span class="badge bg-{{ 'primary' if active_balance >= 0 else 'danger' }} fs-6">
                                {{ active_balance }}
                            </span>
                            <div class="mt-2">
                                <small class="text-muted">
                                    {% if active_balance > 0 %}
                                    üéâ Sei in credito!
                                    {% elif active_balance < 0 %}
                                    üí∏ Sei in debito!
                                    {% else %}
                                    ‚öñÔ∏è In pari
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB STORICO -->
                <div class="tab-pane fade" id="history" role="tabpanel">
                    <div class="row text-center">
                        <div class="col-md-6">
                            <h6>‚úÖ Riscosse</h6>
                            {% set paid_won = bets_won|selectattr('status', 'equalto', 'paid')|list %}
                            <span class="badge bg-success fs-6">{{ paid_won|length }}</span>
                            <div class="mt-2">
                                {% for bet in paid_won %}
                                <small class="d-block text-muted">
                                    {{ bet.bet_value }} da {{ bet.loser.username }}
                                    <br><small>Pagata il {{ bet.paid_at.strftime('%d/%m/%Y') }}</small>
                                </small>
                                {% else %}
                                <small class="text-muted">Nessuna scommessa riscossa</small>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <h6>üí≥ Pagate</h6>
                            {% set paid_lost = bets_lost|selectattr('status', 'equalto', 'paid')|list %}
                            <span class="badge bg-info fs-6">{{ paid_lost|length }}</span>
                            <div class="mt-2">
                                {% for bet in paid_lost %}
                                <small class="d-block text-muted">
                                    {{ bet.bet_value }} a {{ bet.winner.username }}
                                    <br><small>Pagata il {{ bet.paid_at.strftime('%d/%m/%Y') }}</small>
                                </small>
                                {% else %}
                                <small class="text-muted">Nessuna scommessa pagata</small>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Statistiche Totali -->
            <div class="row mt-3 text-center border-top pt-3">
                <div class="col-4">
                    <small class="text-muted">Totale Scommesse</small>
                    <div class="fw-bold">{{ bets_won|length + bets_lost|length }}</div>
                </div>
                <div class="col-4">
                    <small class="text-muted">Vinte Totali</small>
                    <div class="fw-bold text-success">{{ bets_won|length }}</div>
                </div>
                <div class="col-4">
                    <small class="text-muted">Perse Totali</small>
                    <div class="fw-bold text-danger">{{ bets_lost|length }}</div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
        // Inizializza i tooltip di Bootstrap
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        })
    </script>
{% endblock %}