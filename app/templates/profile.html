{% extends "base.html" %}

{% block title %}Profilo di {{ user.username }}{% endblock %}

{% block content %}
<div class="container my-5 pt-5">

    <!-- ======================= HEADER DEL PROFILO ======================= -->
    <div class="card shadow-lg mb-4 profile-header-card border-0">
        <div class="card-body p-4">
            <div class="row align-items-center">
                <div class="col-md-3 text-center">
                    <img src="{{ url_for('static', filename='profile_pics/' + user.profile_image) }}" class="rounded-circle img-fluid border border-3 border-light" alt="Immagine di profilo" style="width: 150px; height: 150px; object-fit: cover;">
                </div>
                <div class="col-md-6">
                    <h1 class="display-5 fw-bold mb-0">
                        {{ user.username }} 
                        {% if user.surname %} {# Controlla se il cognome esiste prima di mostrarlo #}
                            <small class="text-muted fs-5"><i class="bi bi-person-badge"></i> {{ user.surname }}</small>
                        {% endif %}
                    </h1>
                    {% if user.title %}
                    <span class="badge bg-primary fs-6 fw-normal">{{ user.title }}</span>
                    {% endif %}
                    <p class="text-muted mt-2">
                        <i class="bi bi-geo-alt-fill"></i> {{ user.city or 'Citt√† non specificata' }}
                        <span class="mx-2 d-none d-md-inline">|</span>
                        <br class="d-md-none">
                        <i class="bi bi-calendar-plus"></i> Iscritto dal: {{ user.created_at.strftime('%d %B %Y') }}
                    </p>
                    <div class="d-flex mt-3">
                        <div class="me-4"><strong>{{ followers_count }}</strong> Follower</div>
                        <div><strong>{{ followed_count }}</strong> Following</div>
                    </div>
                </div>
                <div class="col-md-3 text-center text-md-end mt-3 mt-md-0">
                    {% if current_user.is_authenticated %}
                        {% if current_user.id == user.id %}
                            <a href="{{ url_for('main.edit_profile') }}" class="btn btn-outline-secondary"><i class="bi bi-pencil-square me-1"></i>Modifica Profilo</a>
                        {% elif not current_user.is_following(user) %}
                            <a href="{{ url_for('main.follow', username=user.username) }}" class="btn btn-primary"><i class="bi bi-person-plus-fill me-1"></i> Segui</a>
                        {% else %}
                            <a href="{{ url_for('main.unfollow', username=user.username) }}" class="btn btn-secondary"><i class="bi bi-person-check-fill me-1"></i> Segui gi√†</a>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- ======================= NAVIGAZIONE A SCHEDE (TABS) ======================= -->
    <ul class="nav nav-pills nav-fill mb-4" id="profileTab" role="tablist">
        <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">Panoramica</button></li>
        <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#activities" type="button" role="tab">Attivit√†</button></li>
        <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#content" type="button" role="tab">Contenuti</button></li>
        <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#community" type="button" role="tab">Community</button></li>
    </ul>

    <!-- ======================= CONTENUTO DELLE SCHEDE ======================= -->
    <div class="tab-content" id="profileTabContent">

        <!-- ### SCHEDA 1: PANORAMICA ### -->
        <div class="tab-pane fade show active" id="overview" role="tabpanel">
            <div class="row g-4">
                <div class="col-12">
                    <div class="card shadow-sm border-0">
                        <div class="card-body">
                            <h5 class="card-title">Progresso Nobiliare</h5>
                            {% set data = namespace(next_title_name='Massimo Grado', next_title_threshold=user.prestige, found=false) %}
                            {% for threshold, title_name in TITLES %}{% if threshold > user.prestige and not data.found %}{% set data.next_title_name = title_name %}{% set data.next_title_threshold = threshold %}{% set data.found = true %}{% endif %}{% endfor %}
                            <p class="text-muted mb-1">Prossimo Titolo: <strong>{{ data.next_title_name }}</strong></p>
                            <div class="progress" style="height: 20px;">
                                {% set progress_percent = ((user.prestige / data.next_title_threshold) * 100) if data.next_title_threshold > 0 and data.next_title_threshold != user.prestige else 100 %}
                                <div class="progress-bar" role="progressbar" style="width: {{ progress_percent }}%;" aria-valuenow="{{ user.prestige }}" aria-valuemin="0" aria-valuemax="{{ data.next_title_threshold }}">{{ user.prestige }} / {{ data.next_title_threshold if data.next_title_threshold != user.prestige else user.prestige }} Prestigio</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12">
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-success"><h5 class="mb-0">Statistiche Riepilogative</h5></div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-6 col-md-4 mb-3"><h5 class="text-primary">{{ "%.2f"|format(total_distance) }} km</h5><small class="text-muted">Distanza Totale</small></div>
                                <div class="col-6 col-md-4 mb-3"><h5 class="text-success">{{ total_activities }}</h5><small class="text-muted">Attivit√†</small></div>
                                <div class="col-6 col-md-4 mb-3"><h5 class="text-info">{{ total_routes_created }}</h5><small class="text-muted">Percorsi Creati</small></div>
                                <div class="col-6 col-md-4 mb-3"><h5 class="text-warning">{{ total_records_held }}</h5><small class="text-muted">Record Detenuti</small></div>
                                <div class="col-6 col-md-4 mb-3"><h5 class="text-secondary">{{ followers_count }}</h5><small class="text-muted">Follower</small></div>
                                <div class="col-6 col-md-4 mb-3"><h5 class="text-secondary">{{ followed_count }}</h5><small class="text-muted">Following</small></div>
                            </div>
                        </div>
                    </div>
                </div>
                 <div class="col-12">
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-primary"><h5 class="mb-0">üí∞ Resoconto Scommesse</h5></div>
                        {# --- USA L'INCLUDE QUI --- #}
                        {% include 'partials/_bets_summary.html' %}
                        <div class="card-body">
                           <div class="row text-center">
                                <div class="col-4 border-end"><h6>Vinte</h6><span class="badge bg-success fs-6">{{ bets_won|length }}</span></div>
                                <div class="col-4 border-end"><h6>Perse</h6><span class="badge bg-danger fs-6">{{ bets_lost|length }}</span></div>
                                <div class="col-4"><h6>In Sospeso</h6><span class="badge bg-warning text-dark fs-6">{{ bets_lost|selectattr('status', 'equalto', 'pending')|list|length }}</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ### SCHEDA 2: ATTIVIT√Ä ### -->
        <div class="tab-pane fade" id="activities" role="tabpanel">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-primary"><h5 class="mb-0">Attivit√† Recenti</h5></div>
                <div class="list-group list-group-flush">
                    {% for activity in user_activities %}
                        <a href="{{ url_for('main.activity_detail', activity_id=activity.id) }}" class="list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">{{ activity.route_activity.name if activity.route_activity else 'Attivit√† Manuale' }}</h6>
                                <small>{{ activity.created_at.strftime('%d/%m/%Y') }}</small>
                            </div>
                            <p class="mb-1 small">Distanza: <strong>{{ "%.2f"|format(activity.distance) }} km</strong> | Tempo: <strong>{{ "%02d:%02d:%02d"|format(activity.duration // 3600, (activity.duration % 3600) // 60, activity.duration % 60) }}</strong></p>
                        </a>
                    {% else %}
                        <div class="list-group-item text-muted">Nessuna attivit√† registrata.</div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- ### SCHEDA 3: CONTENUTI CREATI ### -->
        <div class="tab-pane fade" id="content" role="tabpanel">
            <div class="row g-4">
                <div class="col-lg-6">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-header bg-primary"><h5 class="mb-0">Percorsi Creati ({{ total_routes_created }})</h5></div>
                        <div class="list-group list-group-flush">
                            {% for route in user.routes.order_by(Route.created_at.desc()).all() %}
                                <a href="{{ url_for('main.route_detail', route_id=route.id) }}" class="list-group-item list-group-item-action">
                                    {{ route.name }} - <small class="text-muted">{{ "%.2f"|format(route.distance_km) }} km</small>
                                </a>
                            {% else %}
                                <div class="list-group-item text-muted">Nessun percorso creato.</div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                     <div class="card shadow-sm border-0 h-100">
                        <div class="card-header bg-primary"><h5 class="mb-0">Post Pubblici ({{ user_posts|length }})</h5></div>
                        <div class="list-group list-group-flush">
                            {% for item in user_posts %}
                                <a href="{{ url_for('main.post_detail', post_id=item.id) }}" class="list-group-item list-group-item-action">
                                    {{ item.content|striptags|truncate(80) }}
                                    <small class="d-block text-muted">{{ item.created_at.strftime('%d/%m/%Y') }}</small>
                                </a>
                            {% else %}
                                <div class="list-group-item text-muted">Nessun post pubblico creato.</div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ### SCHEDA 4: COMMUNITY ### -->
        <div class="tab-pane fade" id="community" role="tabpanel">
             <div class="card shadow-sm border-0">
                <div class="card-header bg-primary"><h5 class="mb-0">Gruppi a cui partecipa ({{ user_groups|length }})</h5></div>
                <div class="list-group list-group-flush">
                    {% for group in user_groups %}
                        <a href="{{ url_for('main.group_detail', group_id=group.id) }}" class="list-group-item list-group-item-action d-flex align-items-center">
                            <img src="{{ url_for('static', filename='group_pics/' + group.profile_image) }}" class="rounded-circle me-3" style="width: 40px; height: 40px; object-fit: cover;" alt="{{ group.name }}">
                            <span class="fw-semibold">{{ group.name }}</span>
                        </a>
                    {% else %}
                        <div class="list-group-item text-muted">L'utente non partecipa a nessun gruppo.</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}