{% extends "index.html" %}

{% block title %}Classifica Sfida: {{ challenge.name }}{% endblock %}

{% block content %}
<a href="{{ url_for('main.index') }}" class="btn btn-secondary mb-3">&larr; Torna alla Home</a>

<h2 class="mb-3">Classifica: "{{ challenge.name }}"</h2>
<p>Percorso: <strong>{{ challenge.route_info.name }}</strong> ({{ "%.2f"|format(challenge.route_info.distance_km) }} km)</p>
<p>Periodo: Dal {{ challenge.start_date.strftime('%d/%m/%Y') }} al {{ challenge.end_date.strftime('%d/%m/%Y') }}</p>

{% if leaderboard_entries %}
    <!-- Desktop Table -->
    <div class="d-none d-md-block">
        <div class="table-responsive">
            <table class="table table-striped table-hover mt-4 align-middle">
                <thead class="table-success">
                    <tr>
                        <th scope="col">Pos.</th>
                        <th scope="col">Atleta</th>
                        <th scope="col">Tempo</th>
                        <th scope="col">Vel. Media (km/h)</th>
                        <th scope="col">Distanza (km)</th>
                        <th scope="col">Data Attività</th>
                    </tr>
                </thead>
                <tbody>
                    {% for activity, user in leaderboard_entries %}
                    <tr class="{% if loop.index == 1 %}table-warning{% elif loop.index == 2 %}table-secondary{% elif loop.index == 3 %}table-dark text-white{% endif %}">
                        <td>
                            {% if loop.index <= 3 %}
                                <i class="bi bi-trophy-fill"></i>
                            {% else %}
                                {{ loop.index }}
                            {% endif %}
                        </td>
                        <td><a href="{{ url_for('main.user_profile', user_id=user.id) }}" class="text-primary">{{ user.username }}</a></td>
                        <td>
                            {% set hours = activity.duration // 3600 %}
                            {% set minutes = (activity.duration % 3600) // 60 %}
                            {% set seconds = activity.duration % 60 %}
                            {{ "%02d:%02d:%02d"|format(hours, minutes, seconds) }}
                        </td>
                        <td>{{ "%.2f"|format(activity.avg_speed) }}</td>
                        <td>{{ "%.2f"|format(activity.distance) }}</td>
                        <td>{{ activity.created_at.strftime('%d/%m/%Y %H:%M') }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Mobile Cards -->
    <div class="d-md-none">
        {% for activity, user in leaderboard_entries %}
        <div class="card mb-3 shadow-sm
                    {% if loop.index == 1 %}border-warning{% elif loop.index == 2 %}border-secondary{% elif loop.index == 3 %}border-dark{% endif %}">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    {% if loop.index == 1 %}
                        <i class="bi bi-trophy-fill text-warning fs-3 me-2"></i>
                    {% elif loop.index == 2 %}
                        <i class="bi bi-trophy-fill text-secondary fs-3 me-2"></i>
                    {% elif loop.index == 3 %}
                        <i class="bi bi-trophy-fill text-dark fs-3 me-2"></i>
                    {% else %}
                        <span class="fw-bold me-2">{{ loop.index }}</span>
                    {% endif %}
                    <img src="{{ url_for('static', filename='profile_pics/' + user.profile_image) }}" 
                         class="rounded-circle me-3" width="50" height="50" alt="Avatar {{ user.username }}">
                    <div>
                        <a href="{{ url_for('main.user_profile', user_id=user.id) }}" class="text-decoration-none text-primary fw-semibold">
                            {{ user.username }}
                        </a>
                    </div>
                </div>
                <div class="text-end">
                    <div class="fw-bold">
                        Tempo: 
                        {% set hours = activity.duration // 3600 %}
                        {% set minutes = (activity.duration % 3600) // 60 %}
                        {% set seconds = activity.duration % 60 %}
                        {{ "%02d:%02d:%02d"|format(hours, minutes, seconds) }}
                    </div>
                    <small class="text-muted d-block">
                        Vel. {{ "%.2f"|format(activity.avg_speed) }} km/h<br>
                        Distanza {{ "%.2f"|format(activity.distance) }} km
                    </small>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

{% else %}
    <p class="text-center text-muted mt-4">Nessuna attività registrata per questa sfida. Sii il primo a partecipare!</p>
{% endif %}

{% endblock %}
