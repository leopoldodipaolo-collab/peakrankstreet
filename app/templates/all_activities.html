{% extends "index.html" %}

{% block title %}Tutte le Attività{% endblock %}

{% block content %}
    <!-- MODIFICATO: Aggiunto 'main.' -->
    <a href="{{ url_for('main.index') }}" class="btn btn-secondary mb-3">&larr; Torna alla Home</a>
    
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h2 class="mb-0">Tutte le Attività</h2>
        </div>
        <div class="card-body">
            {% if activities %}
                <div class="list-group">
                    <!-- MODIFICATO: Cicliamo su un singolo 'activity' -->
                    {% for activity in activities %}
                        <div class="list-group-item list-group-item-action d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-2">
                            <div class="activity-info flex-grow-1 mb-2 mb-md-0">
                                <!-- MODIFICATO: Usiamo le relazioni dell'oggetto 'activity' -->
                                <h5>Attività di <a href="{{ url_for('main.user_profile', user_id=activity.user_activity.id) }}" class="user-link text-primary">{{ activity.user_activity.username }}</a></h5>
                                <p class="mb-1">
                                    {% if activity.route_activity %}
                                        su <strong><a href="{{ url_for('main.route_detail', route_id=activity.route_activity.id) }}" class="user-link text-success">{{ activity.route_activity.name }}</a></strong>
                                    {% else %}
                                        su <strong><span class="text-muted">Percorso Libero</span></strong>
                                    {% endif %}
                                </p>
                                <p class="small text-muted mb-1">
                                    Distanza: <strong>{{ "%.2f"|format(activity.distance) }} km</strong> |
                                    Tempo:
                                    {% set hours = activity.duration // 3600 %}
                                    {% set minutes = (activity.duration % 3600) // 60 %}
                                    {% set seconds = activity.duration % 60 %}
                                    <strong>{{ "%02d:%02d:%02d"|format(hours, minutes, seconds) }}</strong> |
                                    Vel. Media: <strong>{{ "%.2f"|format(activity.avg_speed) }} km/h</strong>
                                </p>
                                {% if activity.challenge_info %}
                                    <small class="text-muted">Parte della sfida: <strong><a href="{{ url_for('main.leaderboard', challenge_id=activity.challenge_info.id) }}" class="user-link text-info">{{ activity.challenge_info.name }}</a></strong></small><br>
                                {% endif %}
                                <small class="text-muted">Registrata il: {{ activity.created_at.strftime('%d/%m/%Y %H:%M') }}</small>
                            </div>
                            <div class="activity-actions text-end ms-md-auto">
                                <a href="{{ url_for('main.activity_detail', activity_id=activity.id) }}" class="btn btn-info btn-sm">Dettagli Attività</a>
                            </div>
                        </div>
                    {% endfor %}
                </div>

                <!-- MODIFICATO: Paginazione aggiornata per usare la nuova variabile 'pagination' -->
                <nav aria-label="Pagina di navigazione attività" class="mt-4">
                    <ul class="pagination justify-content-center">
                        <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                            <a class="page-link" href="{{ url_for('main.all_activities', page=pagination.prev_num) }}">Precedente</a>
                        </li>
                        {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                            {% if page_num %}
                                {% if pagination.page == page_num %}
                                    <li class="page-item active" aria-current="page"><a class="page-link" href="#">{{ page_num }}</a></li>
                                {% else %}
                                    <li class="page-item"><a class="page-link" href="{{ url_for('main.all_activities', page=page_num) }}">{{ page_num }}</a></li>
                                {% endif %}
                            {% else %}
                                <li class="page-item disabled"><a class="page-link" href="#">...</a></li>
                            {% endif %}
                        {% endfor %}
                        <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                            <a class="page-link" href="{{ url_for('main.all_activities', page=pagination.next_num) }}">Successivo</a>
                        </li>
                    </ul>
                </nav>

            {% else %}
                <!-- MODIFICATO: Aggiunto 'main.' -->
                <p class="text-center text-muted mt-4">Nessuna attività registrata. Sii il primo a <a href="{{ url_for('main.record_activity') }}">registrarne una!</a></p>
            {% endif %}
        </div>
    </div>
{% endblock %}