{% extends "index.html" %}

{% block title %}Tutte le Sfide{% endblock %}

{% block content %}
    <a href="{{ url_for('main.index') }}" class="btn btn-secondary mb-3">&larr; Torna alla Home</a>
    
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h2 class="mb-0">ðŸŽ¯ Tutte le Sfide</h2>
        </div>
        <div class="card-body">
            <!-- Filtro per stato -->
            <div class="mb-3 d-flex flex-column flex-md-row align-items-start align-items-md-center">
                <label for="statusFilter" class="form-label mb-2 mb-md-0 me-md-2">Filtra per stato:</label>
                <select id="statusFilter" class="form-select w-auto">
                    <option value="all" {% if status_filter == 'all' %}selected{% endif %}>Tutte le Sfide</option>
                    <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Sfide Attive</option>
                    <option value="finished" {% if status_filter == 'finished' %}selected{% endif %}>Sfide Terminate</option>
                    <option value="closed_only" {% if status_filter == 'closed_only' %}selected{% endif %}>Solo Sfide Chiuse</option>
                </select>
            </div>

            <!-- === SEZIONE SFIDE INVIATE === -->
            {% if invited_challenges %}
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-warning text-dark">
                    <h4 class="mb-0">ðŸ“¬ Sfide a Sei Invitato</h4>
                </div>
                <div class="card-body">
                    <div class="list-group">
                        {% for challenge in invited_challenges %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="mb-1">{{ challenge.name }}</h5>
                                    <p class="mb-1">
                                        <strong>Percorso:</strong> {{ challenge.route_info.name }} 
                                        â€¢ <strong>Creato da:</strong> {{ challenge.challenger.username }}
                                    </p>
                                    <small class="text-muted">
                                        {{ challenge.start_date.strftime('%d/%m/%Y') }} - {{ challenge.end_date.strftime('%d/%m/%Y') }}
                                    </small>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-warning me-2">In attesa</span>
                                    <a href="{{ url_for('main.challenge_detail', challenge_id=challenge.id) }}" 
                                       class="btn btn-primary btn-sm">
                                        Dettagli
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- === SEZIONE SFIDE APERTE === -->
            {% if challenges %}
                <div class="list-group">
                    {% for challenge in challenges %}
                        <div class="list-group-item d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-2">
                            <div class="route-info flex-grow-1 mb-2 mb-md-0">
                                <h5>{{ challenge.name }}</h5>
                                <p class="mb-1">Percorso: <a href="{{ url_for('main.route_detail', route_id=challenge.route_info.id) }}" class="user-link text-success">{{ challenge.route_info.name }}</a></p>
                                <p class="mb-1">Periodo: Dal {{ challenge.start_date.strftime('%d/%m/%Y') }} al {{ challenge.end_date.strftime('%d/%m/%Y') }}</p>
                                <small class="text-muted">Creata da: <a href="{{ url_for('main.user_profile', user_id=challenge.challenger.id) }}" class="user-link text-primary">{{ challenge.challenger.username }}</a> il {{ challenge.created_at.strftime('%d/%m/%Y %H:%M') }}</small>
                            </div>
                            <div class="route-actions text-end ms-md-auto">
                                {% if current_user.is_authenticated and challenge.end_date >= now %}
                                    <a href="{{ url_for('main.record_activity', challenge_id=challenge.id) }}" class="btn btn-primary btn-sm me-2">Partecipa</a>
                                {% elif challenge.end_date < now %}
                                    <span class="badge bg-secondary me-2">Terminata</span>
                                {% endif %}
                                <a href="{{ url_for('main.leaderboard', challenge_id=challenge.id) }}" class="btn btn-success btn-sm">Classifica</a>
                            </div>
                        </div>
                    {% endfor %}
                </div>

                <!-- Paginazione -->
                <nav aria-label="Pagina di navigazione sfide" class="mt-4">
                    <ul class="pagination justify-content-center">
                        <li class="page-item {% if not challenges_pagination.has_prev %}disabled{% endif %}">
                            <a class="page-link" href="{{ url_for('main.challenges_list', page=challenges_pagination.prev_num, status=status_filter) }}">Precedente</a>
                        </li>
                        {% for page_num in challenges_pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                            {% if page_num %}
                                {% if challenges_pagination.page == page_num %}
                                    <li class="page-item active" aria-current="page"><a class="page-link" href="#">{{ page_num }}</a></li>
                                {% else %}
                                    <li class="page-item"><a class="page-link" href="{{ url_for('main.challenges_list', page=page_num, status=status_filter) }}">{{ page_num }}</a></li>
                                {% endif %}
                            {% else %}
                                <li class="page-item disabled"><a class="page-link" href="#">...</a></li>
                            {% endif %}
                        {% endfor %}
                        <li class="page-item {% if not challenges_pagination.has_next %}disabled{% endif %}">
                            <a class="page-link" href="{{ url_for('main.challenges_list', page=challenges_pagination.next_num, status=status_filter) }}">Successivo</a>
                        </li>
                    </ul>
                </nav>

            {% else %}
                <p class="text-center text-muted mt-4">Ancora nessuna sfida creata. Sii il primo a <a href="{{ url_for('main.create_challenge') }}">crearne una!</a></p>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
        document.getElementById('statusFilter').addEventListener('change', function() {
            var selectedStatus = this.value;
            window.location.href = "{{ url_for('main.challenges_list') }}?status=" + selectedStatus;
        });
    </script>
{% endblock %}