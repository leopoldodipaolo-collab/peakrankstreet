{% extends "base.html" %}

{% block title %}Home - PeakRankStreet App{% endblock %}

{% block content %}
    <!-- ======================= HERO SECTION (CON STATISTICHE INTEGRATE) ======================= -->
    <section class="hero-section text-white text-center d-flex align-items-center justify-content-center">
        <div class="container">
            <!-- Contenuto Principale (Invariato) -->
            <h1 class="display-3 fw-bold mb-3 animate__animated animate__fadeInDown">Esplora, Sfida, Conquista!</h1>
            <p class="lead mb-4 animate__animated animate__fadeInUp">Traccia le tue attivit√†, scopri nuovi percorsi e competi con la community di PeakRankStreet.</p>
            
            <!-- Pulsanti Call-to-Action (Invariati) -->
            {% if not current_user.is_authenticated %}
                <a href="{{ url_for('auth.register') }}" class="btn btn-lg btn-success-custom mx-2 animate__animated animate__zoomIn">Inizia Ora!</a>
                <a href="{{ url_for('main.upload_gpx') }}" class="btn btn-lg btn-outline-light animate__animated animate__zoomIn"><i class="bi bi-upload me-2"></i>Carica il tuo GPX</a>
            {% else %}
                <a href="{{ url_for('main.track_activity') }}" class="btn btn-lg btn-success-custom mx-2 animate__animated animate__zoomIn"><i class="bi bi-geo-alt-fill me-2"></i>Inizia a Tracciare!</a>
                <a href="{{ url_for('main.upload_gpx') }}" class="btn btn-lg btn-outline-light animate__animated animate__zoomIn"><i class="bi bi-upload me-2"></i>Carica GPX</a>
                <a href="{{ url_for('main.challenges_list') }}" class="btn btn-lg btn-outline-light animate__animated animate__zoomIn"><i class="bi bi-award-fill me-2"></i>Le mie Sfide</a>
            {% endif %}

            <!-- ======================================================= -->
            <!-- SEZIONE STATISTICHE AGGIUNTA QUI                        -->
            <!-- ======================================================= -->
            <div class="hero-stats-container mt-5 pt-4">
                <div class="row">
                    <!-- Statistica Utenti -->
                    <div class="col-md-3 col-6">
                        <div class="stat-card-hero">
                            <div class="stat-number" data-goal="{{ site_stats.total_users }}">0</div>
                            <div class="stat-label-hero">Utenti</div>
                        </div>
                    </div>
                    <!-- Statistica Post -->
                    <div class="col-md-3 col-6">
                        <div class="stat-card-hero">
                            <div class="stat-number" data-goal="{{ site_stats.total_posts }}">0</div>
                            <div class="stat-label-hero">Post</div>
                        </div>
                    </div>
                    <!-- Statistica Attivit√† -->
                    <div class="col-md-3 col-6">
                        <div class="stat-card-hero">
                            <div class="stat-number" data-goal="{{ site_stats.get('total_activities', 0) }}">0</div>
                            <div class="stat-label-hero">Attivit√†</div>
                        </div>
                    </div>
                    <!-- Statistica Percorsi -->
                    <div class="col-md-3 col-6">
                        <div class="stat-card-hero">
                            <div class="stat-number" data-goal="{{ site_stats.get('total_routes', 0) }}">0</div>
                            <div class="stat-label-hero">Percorsi</div>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </section>

    <div class="container mt-5">
        <h2 class="text-center mb-4 section-title">La Tua Avventura Ti Aspetta</h2>
        
        <div class="row mb-5 justify-content-center">
            <div class="col-12 col-md-8">
                <div class="card p-3 shadow-lg rounded-pill-custom">
                    <div class="input-group">
                        <input type="text" id="citySearchInput" class="form-control form-control-lg rounded-pill-left" placeholder="Cerca la tua citt√† o un'area..." value="{{ user_city if user_city else '' }}">
                        <button class="btn btn-primary-custom rounded-pill-right" type="button" id="searchCityButton">
                            Cerca
                            <span id="citySearchSpinner" class="spinner-border spinner-border-sm ms-2" role="status" aria-hidden="true" style="display: none;"></span>
                        </button>
                    </div>
                    <div class="text-center mt-3">
                        <div class="btn-group activity-type-filter" role="group" id="activityTypeFilter">
                            <button type="button" class="btn btn-outline-secondary btn-sm active" data-type="all"><i class="bi bi-globe me-1"></i>Tutti</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" data-type="Corsa"><i class="bi bi-person-running me-1"></i>Corsa</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" data-type="Bici"><i class="bi bi-bicycle me-1"></i>Bici</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" data-type="Hike"><i class="bi bi-mountains me-1"></i>Hike</button>
                        </div>
                    </div>
                    <!-- <hr class="my-3">
                    <div class="text-center">
                        <a href="{{ url_for('main.explore') }}" class="btn btn-lg btn-outline-light animate__animated animate__zoomIn" style="background-color: rgb(167, 167, 167);"><i class="bi bi-compass-fill me-2"></i>Esplora</a>
                        <a href="{{ url_for('main.list_groups') }}" class="btn btn-lg btn-outline-light animate__animated animate__zoomIn" style="background-color: rgb(167, 167, 167);"><i class="bi bi-people-fill me-2"></i>Gruppi</a>
                        <a href="{{ url_for('main.propose_classic_route') }}" class="btn btn-lg btn-outline-light animate__animated animate__zoomIn" style="background-color: rgb(167, 167, 167);"><i class="bi bi-map-fill me-2"></i>Proponi un Classico</a>
                    </div>-->
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                <!-- Colonna SINISTRA -->
                <div class="col-lg-6">
                {% if show_onboarding %}
                    <div class="mb-4">
                    {% include 'partials/_onboarding_checklist.html' %}
                    </div>
                {% endif %}

                {% if current_user.is_authenticated %}
                    <div class="mb-4">
                    {% include 'partials/_prestige_widget.html' %}
                    </div>
                {% endif %}
                </div>

                <!-- Colonna DESTRA -->
                <div class="col-lg-6">
                {% if current_user.is_authenticated and upcoming_events %}
                    <div class="mb-4">
                    {% include 'partials/_upcoming_events_widget.html' %}
                    </div>
                {% endif %}

                {% if recent_challenges_in_city %}
                    <div class="card shadow-sm mt-4">
                    <div class="card-header bg-warning">
                        <h5 class="mb-0"><i class="bi bi-bullseye me-2"></i>Sfide nella tua zona</h5>
                    </div>
                    <div class="list-group list-group-flush">
                        {% for challenge in recent_challenges_in_city %}
                        <a href="{{ url_for('main.challenge_detail', challenge_id=challenge.id) }}" class="list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-between">
                            <p class="mb-1 fw-bold">{{ challenge.name }}</p>
                            <small>{{ challenge.end_date.strftime('%d %b') }}</small>
                            </div>
                            <small class="text-muted">Su: {{ challenge.route_info.name }}</small>
                        </a>
                        {% endfor %}
                        <a href="{{ url_for('main.challenges_list') }}" class="list-group-item list-group-item-action text-center text-primary fw-bold">
                        Vedi tutte le sfide...
                        </a>
                    </div>
                    </div>
                {% endif %}
                </div>
            </div>
        </div>

        <div class="card bg-dark text-white my-5 shadow-lg propose-classic-banner position-relative overflow-hidden">
            <!-- Immagine di sfondo solo su desktop -->
            <img src="{{ url_for('main.uploaded_file', filename='img/banner-background.jpg') }}" 
                class="d-none d-sm-block w-100 position-absolute top-0 start-0 h-100" 
                alt="Panorama montano" 
                style="object-fit: cover; opacity: 0.3; z-index: 1;">

            <!-- Overlay testo -->
            <div class="d-flex flex-column justify-content-center align-items-center text-center p-4 position-relative" style="z-index: 2;">
                <h3 class="card-title fw-bold mb-2 fs-5 fs-sm-4">Conosci un percorso leggendario?</h3>
                <p class="card-text mb-3 fs-6 fs-sm-5">Aiutaci a mappare i percorsi "Classici" della tua zona. Proponi il tuo preferito!</p>
                <a href="{{ url_for('main.propose_classic_route') }}" class="btn btn-warning fw-bold btn-sm btn-md">
                    <i class="bi bi-award-fill me-2"></i>Proponi un Percorso Classico
                </a>
            </div>
        </div>

        <div class="card shadow-lg mb-5 map-card-custom">
            <div class="card-header bg-primary-custom text-white d-flex justify-content-between align-items-center">
                <h4 class="mb-0"><i class="bi bi-map-fill me-2"></i>Mappa Esplorativa</h4>
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" id="mapLoadingSpinner" style="display:none;"></span>
            </div>
            <div class="card-body p-0">
                <div id="mainMap" class="map-container"></div>
                <div class="map-overlay-instructions p-3 bg-light text-muted" id="map-instructions">
                    <i class="bi bi-info-circle me-2"></i>Usa la barra di ricerca per esplorare nuove aree o clicca su un percorso sulla mappa per vederne i dettagli.
                </div>
            </div>
        </div>
        <!-- DETTAGLI PERCORSO - SOTTO LA MAPPA -->
        <div id="selected-route-details" class="card shadow-lg mb-5 route-details-card" style="display: none;">
            <div class="card-header bg-success-custom text-white d-flex justify-content-between align-items-center">
                <h4 class="mb-0"><i class="bi bi-info-circle me-2"></i>Dettagli Percorso Selezionato</h4>

                <button type="button" class="btn btn-sm btn-light" onclick="hideRouteDetails()">
                    <i class="bi bi-x-lg"></i> Chiudi
                </button>
            </div>

            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h5 class="card-title text-success-custom fw-bold" id="detail-route-name-body"></h5>
                        <p class="card-text text-muted" id="detail-route-description"></p>
                        <p class="card-text"><small class="text-muted" id="detail-route-meta"></small></p>

                        <div id="detail-king-queen" class="king-queen-highlight mt-4" role="alert" style="display:none;">
                            <div class="royal-container">
                                <!-- SFONDO ANIMATO -->
                                <div class="royal-background"></div>
                                <div class="royal-particles"></div>
                                
                                <!-- CORONA GIGANTE -->
                                <div class="floating-crown">üëë</div>
                                
                                <!-- CONTENUTO PRINCIPALE -->
                                <div class="royal-content">
                                    <div class="royal-header text-center">
                                        <i class="fas fa-crown royal-crown-icon"></i>
                                        <h3 class="royal-title">
                                            Gran Cavaliere del Percorso.: 
                                            <a id="detail-route-name-header" class="text-decoration-none text-success fw-bold"></a>
                                        </h3>
                                        <i class="fas fa-crown royal-crown-icon"></i>
                                        <p class="text-muted mt-1" style="font-size:0.9em;">
                                            Mantienilo‚Ä¶ se ne sei capace. üòè
                                        </p>
                                    </div>

                             
                                    <div class="royal-info">
                                        <div class="royal-avatar-container">
                                            <img id="kq-avatar" src="{{ url_for('main.uploaded_file', filename='img/LogoX_SS.png') }}"  class="royal-avatar" alt="Royal Avatar"> 
                                            <div class="royal-avatar-glow"></div>
                                            <div class="royal-avatar-sparkles">
                                                <div class="sparkle s1"></div>
                                                <div class="sparkle s2"></div>
                                                <div class="sparkle s3"></div>
                                            </div>
                                        </div>
                                        
                                        <div class="royal-details">
                                            <p class="royal-holder">
                                                <span class="royal-label">Detenuto da:</span>
                                                <strong id="kq-username" class="royal-username"></strong>
                                            </p>
                                            <p class="royal-duration">
                                                <span class="royal-label">Durata regno:</span>
                                                <strong id="kq-duration" class="royal-duration-value"></strong>
                                            </p>
                                            <div class="royal-actions">
                                                <a href="#" id="kq-activity-link" class="btn-royal-action">
                                                    <i class="fas fa-external-link-alt"></i>
                                                    Vedi Attivit√†
                                                </a>
                                                <small class="royal-date" id="kq-created-at"></small>
                                            </div>

                                            <!-- Frase tagliente e bottone sfida -->
                                            <p class="text-danger mt-2" style="font-size:0.95em; font-weight:500;">
                                                √à ora di cambiare le cose‚Ä¶
                                            </p>
                                            <a href="#" id="record-activity-link" class="btn btn-outline-danger mt-1">
                                                <i class="bi bi-stopwatch me-1"></i> Sfida e abbatti il Cavaliere!
                                            </a>
  
                                        </div>

                                    </div>
                                </div>
                                
                                <!-- EFFETTI BORDO -->
                                <div class="royal-border"></div>
                                <div class="royal-shine"></div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div id="detail-top-5-times" class="mt-3" style="display:none;">
                            <h6 class="border-bottom pb-2"><i class="bi bi-trophy me-2"></i>Top 5 Tempi</h6>
                            <ul class="list-group list-group-flush list-group-small" id="top-5-list"></ul>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4 pt-3 border-top">
                    <a href="#" id="detail-route-link" class="btn btn-success-custom me-2">
                        <i class="bi bi-eye me-1"></i>Vedi Dettagli Completi
                    </a>
                    <a href="#" id="record-activity-link" class="btn btn-outline-success-custom me-2">
                        <i class="bi bi-stopwatch me-1"></i>Registra Tempo
                    </a>
                    <a href="#" id="create-challenge-link" class="btn btn-outline-warning">
                        <i class="bi bi-trophy me-1"></i>Crea Sfida
                    </a>
                </div>

                <!-- URL nascosti e dati base -->
                <div id="user-profile-url-base" style="display:none;">{{ url_for('main.user_profile', user_id=12345) }}</div> 
                <div id="route-detail-url-base" style="display:none;">{{ url_for('main.route_detail', route_id=12345) }}</div>
                <div id="activity-detail-url-base" style="display:none;">{{ url_for('main.activity_detail', activity_id=12345) }}</div>
                <div id="map-data-api-url" style="display:none;">{{ url_for('api.get_map_data') }}</div>
                <div id="user-initial-city" style="display:none;">{{ user_city if user_city else '' }}</div> 
                <div id="profile-pics-base-url" style="display:none;">{{ url_for('static', filename='profile_pics/') }}</div>
            </div>
        </div>

        <!-- TABBED CONTENT SECTIONS -->
        <ul class="nav nav-pills nav-fill mb-3 d-lg-none" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="leaderboards-tab" data-bs-toggle="pill" data-bs-target="#leaderboards-pane" type="button" role="tab" aria-controls="leaderboards-pane" aria-selected="false"><i class="bi bi-trophy"></i> Classifiche</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="challenges-tab" data-bs-toggle="pill" data-bs-target="#challenges-pane" type="button" role="tab" aria-controls="challenges-pane" aria-selected="true"><i class="bi bi-award"></i> Sfide</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="activities-tab" data-bs-toggle="pill" data-bs-target="#activities-pane" type="button" role="tab" aria-controls="activities-pane" aria-selected="false"><i class="bi bi-activity"></i> Attivit√†</button>
            </li>
        </ul>

        <div class="tab-content d-lg-block">
            <!-- SEZIONE LEADERBOARDS -->
            <div class="tab-pane fade show active d-lg-block" id="leaderboards-pane" role="tabpanel">
                <div class="row my-4">
                    <div class="col-md-6 mb-4">
                        <div class="card shadow-lg h-100 leaderboard-card">
                            <div class="card-header bg-primary-custom text-white d-flex justify-content-between align-items-center">
                                <h5 class="mb-0 text-truncate" title="Eroi Locali: Distanza"><i class="bi bi-star-fill me-2"></i>Eroi Locali: Distanza</h5>
                                <a href="{{ url_for('main.leaderboard_total_distance') }}" class="btn btn-sm btn-light-custom text-truncate" title="Vedi Globale">
                                    <i class="bi bi-globe me-1"></i>Vedi Globale
                                </a>
                            </div>
                            <ul class="list-group list-group-small list-group-flush" id="top-distance-list">
                                <li class="list-group-item text-center text-muted">Caricamento classifica...</li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="card shadow-lg h-100 leaderboard-card">
                            <div class="card-header bg-primary-custom text-white d-flex justify-content-between align-items-center">
                                <h5 class="mb-0 text-truncate" title="Eroi Locali: Percorsi Creati"><i class="bi bi-lightning-fill me-2"></i>Eroi Locali: Percorsi Creati</h5>
                                <a href="{{ url_for('main.leaderboard_most_routes') }}" class="btn btn-sm btn-light-custom text-truncate" title="Vedi Globale">
                                    <i class="bi bi-globe me-1"></i>Vedi Globale
                                </a>
                            </div>
                            <ul class="list-group list-group-small list-group-flush" id="top-creators-list">
                                <li class="list-group-item text-center text-muted">Caricamento classifica...</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SEZIONE PERCORSI CLASSICI & SFIDE RECENTI -->
            <div class="tab-pane fade show active d-lg-block" id="challenges-pane" role="tabpanel">
                <!-- SOTTO-SEZIONE PERCORSI CLASSICI -->
                <div class="classic-routes-section card shadow-lg my-5" id="classic-routes-section">
                    <div class="card-header bg-secondary-custom text-white">
                        <h3 class="mb-0"><i class="bi bi-signpost-fill me-2"></i>Percorsi Classici di <span id="classic-routes-city">L'Aquila</span></h3>
                        <small class="text-white-50">I percorsi pi√π amati e sfidanti della tua citt√†</small>
                    </div>
                    <div class="card-body">
                        <div id="classic-routes-container" class="row row-cols-1 row-cols-md-2 g-4"></div>
                        <div id="no-classic-routes" class="text-center p-3 d-none">
                            <p class="text-muted mb-1">Nessun percorso classico trovato per questa citt√†.</p>
                            <p class="text-muted"><small>I percorsi classici vengono aggiunti dagli amministratori della community.</small></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- =================================================================== -->
            <!-- BOX CREAZIONE POST - DESIGN LINKEDIN CON TESTO PERSONALIZZATO       -->
            <!-- =================================================================== -->
            {% if current_user.is_authenticated %}
            <div class="card shadow-sm mb-4">
                <div class="card-body p-3">
                    <!-- Parte Superiore: Avatar + Pulsante "Crea un post" -->
                    <div class="d-flex align-items-center mb-3">
                        <img src="{{ url_for('main.uploaded_file', filename='profile_pics/' + current_user.profile_image) }}" class="rounded-circle me-2 profile-image-navbar" alt="Avatar di {{ current_user.username }}">
                        
                        <!-- Pulsante aggiornato con il tuo nuovo testo -->
                        <button type="button" class="btn w-100 text-start create-post-pill-btn" 
                                data-bs-toggle="modal" data-bs-target="#createPostModal" data-post-type-select="text">
                            Crea, Inspira, Condividi...
                        </button>
                    </div>

                    <!-- Parte Inferiore: Pulsanti Azione (Video, Foto, Articolo) -->
                    <div class="d-flex justify-content-around">
                        <button type="button" class="btn create-post-action-btn" 
                                data-bs-toggle="modal" data-bs-target="#createPostModal" data-post-type-select="text">
                            <i class="bi bi-play-btn-fill text-success me-2"></i>Video
                        </button>

                        <button type="button" class="btn create-post-action-btn" 
                                data-bs-toggle="modal" data-bs-target="#createPostModal" data-post-type-select="image">
                            <i class="bi bi-image text-primary me-2"></i>Foto
                        </button>
                        
                        <button type="button" class="btn create-post-action-btn" 
                                data-bs-toggle="modal" data-bs-target="#createPostModal" data-post-type-select="text">
                            <i class="bi bi-file-earmark-text text-warning me-2"></i>Scrivi un articolo
                        </button>
                    </div>
                </div>
            </div>
            {% endif %}
            {% from 'macros/_cards.html' import feed_card %}
            {% set community_footer_links = [
                {'url': url_for('main.all_activities'), 'text': 'Tutte le Attivit√†', 'class': 'btn-outline-primary'},
                {'url': url_for('main.challenges_list'), 'text': 'Esplora le Sfide', 'class': 'btn-outline-secondary'}
            ] %}
            {{ feed_card(
                id='community-feed',
                title='Aggiornamenti dalla Community',
                icon_class='bi-newspaper',
                items=community_items,  
                footer_links=community_footer_links,
                current_user=current_user,
                has_next_feed_page=has_next_feed_page
            ) }}

            <!-- ATTIVIT√Ä RECENTI & PERCORSI DISPONIBILI -->
            <div class="tab-pane fade d-lg-block" id="activities-pane" role="tabpanel">
                <div class="social-feed-section card shadow-lg my-5">
                    <div class="card-header bg-info-custom text-white">
                        <h3 class="mb-0"><i class="bi bi-activity me-2"></i>Attivit√† Recenti nell'Area</h3>
                    </div>
                    <div class="card-body">
                        <div id="recent-activities-list" class="list-group">
                            <p class="text-center text-muted">Caricamento attivit√†...</p>
                        </div>
                    </div>
                </div>

                <div class="routes-list-section card shadow-lg my-5">
                    <div class="card-header bg-success-custom text-white">
                        <h3 class="mb-0"><i class="bi bi-flag-fill me-2"></i>Percorsi nell'Area</h3>
                    </div>
                    <div class="card-body">
                        <div id="available-routes-list" class="list-group">
                            <p class="text-center text-muted">Caricamento percorsi...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- =================================================================== -->
    <!-- PASSO 1-B: IL MODALE NASCOSTO CON IL FORM COMPLETO                  -->
    <!-- =================================================================== -->
    <!-- =================================================================== -->
    <!-- CODICE COMPLETO E CORRETTO DEL MODALE (CON SELETTORE GRUPPO)        -->
    <!-- =================================================================== -->
    {% if current_user.is_authenticated %}
    <div class="modal fade" id="createPostModal" tabindex="-1" aria-labelledby="createPostModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="createPostModalLabel"><i class="bi bi-plus-circle-fill me-2"></i>Crea un Nuovo Aggiornamento</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="POST" action="{{ url_for('main.create_post') }}" enctype="multipart/form-data" id="createPostForm">
                    <div class="modal-body">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" id="post_type_hidden" name="post_type" value="text">
                        
                        <div class="d-flex align-items-start mb-3">
                            <img src="{{ url_for('main.uploaded_file', filename='profile_pics/' + current_user.profile_image) }}" class="rounded-circle me-2 profile-image-navbar" alt="Avatar di {{ current_user.username }}">
                            <div class="flex-grow-1">
                                <h6 class="mb-0">{{ current_user.username }}</h6>
                                <small class="text-muted fs-5"><i class="bi bi-person-badge"></i> {{ current_user.surname }}</small>
                                <!-- SELETTORE PUBBLICA IN: -->
                                <select class="form-select form-select-sm mt-1" id="group_id" name="group_id" style="max-width: 250px;">
                                    <option value="">Feed Pubblico (principale)</option>
                                    {% for group in user_groups %}
                                        <option value="{{ group.id }}">Gruppo: {{ group.name }}</option>
                                    {% endfor %}
                                </select>

                            </div>
                        </div>

                        <textarea class="form-control border-0 shadow-none fs-5" id="postContentModal" name="content" rows="6" placeholder="Cosa vuoi condividere, {{ current_user.username }}?"></textarea>
                        
                        <div class="mt-3 p-3 border rounded bg-light" id="image-field-modal" style="display: none;">
                            <label for="image" class="form-label fw-bold">Allega un'immagine*</label>
                            <input class="form-control" type="file" id="image" name="image" accept="image/*">
                        </div>
                        
                        <div class="mt-3 p-3 border rounded bg-light" id="link-field-modal" style="display: none;">
                            <label for="link" class="form-label fw-bold">Inserisci un link*</label>
                            <input type="url" class="form-control" id="link" name="link" placeholder="https://...">
                        </div>
                    </div>

                    <div class="modal-footer d-flex justify-content-between">
                        <div class="post-type-selector">
                            <button type="button" class="btn btn-outline-secondary" data-post-type="text" title="Testo"><i class="bi bi-card-text"></i></button>
                            <button type="button" class="btn btn-outline-secondary" data-post-type="image" title="Immagine"><i class="bi bi-image"></i></button>
                            <button type="button" class="btn btn-outline-secondary" data-post-type="link" title="Link"><i class="bi bi-link-45deg"></i></button>
                        </div>
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-send-fill me-2"></i> Pubblica
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endif %}


{% endblock %}

{% block scripts %}
    <script>var is_homepage_js = true;</script>
    <script src="https://cdn.jsdelivr.net/npm/timeago.js@4.0.2/dist/timeago.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/timeago.js@4.0.2/dist/timeago.locales.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            })

            function applyTimeago(container) {
                const elements = container.querySelectorAll('.timeago:not(.timeago-applied)');
                if (elements.length > 0) {
                    timeago.render(elements, 'it');
                }
            }
            applyTimeago(document.body);

            const csrfToken = '{{ csrf_token() }}';

            document.body.addEventListener('click', function(event) {
                const likeButton = event.target.closest('.like-button');
                if (likeButton) {
                    event.preventDefault();
                    const postId = likeButton.dataset.postId;
                    const apiUrl = `/post/${postId}/like`;
                    
                    fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': csrfToken }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            const icon = likeButton.querySelector('i');
                            const countSpan = likeButton.querySelector('.like-count');
                            countSpan.textContent = data.new_like_count;
                            
                            if (data.action === 'liked') {
                                likeButton.classList.remove('text-muted');
                                likeButton.classList.add('text-danger');
                                icon.classList.remove('bi-heart');
                                icon.classList.add('bi-heart-fill');
                            } else {
                                likeButton.classList.remove('text-danger');
                                likeButton.classList.add('text-muted');
                                icon.classList.remove('bi-heart-fill');
                                icon.classList.add('bi-heart');
                            }
                        }
                    });
                }

                const deletePostBtn = event.target.closest('.delete-post-btn');
                if (deletePostBtn) {
                    event.preventDefault();
                    if (confirm('Sei sicuro di voler eliminare questo post?')) {
                        const url = deletePostBtn.dataset.deleteUrl;
                        fetch(url, { method: 'POST', headers: { 'X-CSRFToken': csrfToken }})
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                document.getElementById(`post-${deletePostBtn.dataset.postId}`).remove();
                            } else { alert('Errore: ' + data.message); }
                        });
                    }
                }

                const editPostBtn = event.target.closest('.edit-post-btn');
                if (editPostBtn) {
                    event.preventDefault();
                    const postId = editPostBtn.dataset.postId;
                    const postDiv = document.getElementById(`post-${postId}`);
                    const contentContainer = postDiv.querySelector('.post-content-container');
                    const originalContentP = contentContainer.querySelector('.post-content-text');
                    
                    if (originalContentP) {
                        const originalContent = originalContentP.innerHTML;
                        const editFormHTML = `
                            <form class="edit-post-form" action="/post/${postId}/edit" method="POST">
                                <textarea class="form-control mb-2" name="content" rows="4">${originalContent.replace(/<br\s*[\/]?>/gi, "")}</textarea>
                                <button type="submit" class="btn btn-primary btn-sm">Salva</button>
                                <button type="button" class="btn btn-secondary btn-sm cancel-edit-post-btn">Annulla</button>
                            </form>
                        `;
                        contentContainer.innerHTML = editFormHTML;
                    }
                }

                const cancelPostBtn = event.target.closest('.cancel-edit-post-btn');
                if (cancelPostBtn) {
                    const contentContainer = cancelPostBtn.closest('.post-content-container');
                    const originalContent = cancelPostBtn.closest('form').querySelector('textarea').defaultValue;
                    contentContainer.innerHTML = `<p class="post-content-text mb-0">${originalContent}</p>`;
                }
            });

            document.body.addEventListener('submit', function(event) {
                const editPostForm = event.target.closest('.edit-post-form');
                if (editPostForm) {
                    event.preventDefault();
                    const url = editPostForm.getAttribute('action');
                    const formData = new FormData(editPostForm);
                    fetch(url, { method: 'POST', headers: { 'X-CSRFToken': csrfToken }, body: formData })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            editPostForm.parentElement.innerHTML = `<p class="post-content-text mb-0">${data.new_content}</p>`;
                        } else { alert('Errore: ' + data.message); }
                    });
                }
            });

            const loadMoreBtn = document.getElementById('load-more-btn');
            if (loadMoreBtn) {
                const loadingSpinner = document.getElementById('loading-spinner');
                const postsContainer = document.getElementById('feed-posts-container');
                
                loadMoreBtn.addEventListener('click', function() {
                    loadMoreBtn.style.display = 'none';
                    loadingSpinner.style.display = 'block';
                    const nextPage = this.dataset.nextPage;

                    fetch(`/api/feed?page=${nextPage}`)
                        .then(response => response.json())
                        .then(data => {
                            postsContainer.insertAdjacentHTML('beforeend', data.html);
                            applyTimeago(postsContainer);
                            if (data.has_next_page) {
                                loadMoreBtn.dataset.nextPage = parseInt(nextPage) + 1;
                                loadMoreBtn.style.display = 'block';
                            }
                        })
                        .catch(error => {
                            console.error('Errore nel caricare altri post:', error);
                            loadMoreBtn.style.display = 'block';
                        })
                        .finally(() => {
                            loadingSpinner.style.display = 'none';
                        });
                });
            }

             // ===============================================================
            // LOGICA PER IL MODALE DI CREAZIONE POST PROFESSIONALE
            // ===============================================================
            const createPostModal = document.getElementById('createPostModal');
            if (createPostModal) {
                const form = createPostModal.querySelector('#createPostForm');
                const postTypeButtons = createPostModal.querySelectorAll('.post-type-selector button');
                const hiddenPostTypeInput = createPostModal.querySelector('#post_type_hidden');
                
                const linkField = createPostModal.querySelector('#link-field-modal');
                const imageField = createPostModal.querySelector('#image-field-modal');
                const linkInput = createPostModal.querySelector('#link');
                const imageInput = createPostModal.querySelector('#image');
                
                // Funzione per aggiornare l'interfaccia del modale
                function setPostType(type) {
                    hiddenPostTypeInput.value = type;
                    imageField.style.display = (type === 'image') ? 'block' : 'none';
                    linkField.style.display = (type === 'link') ? 'block' : 'none';
                    imageInput.required = (type === 'image');
                    linkInput.required = (type === 'link');
                    postTypeButtons.forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.postType === type);
                    });
                }

                // Aggiungi listener ai pulsanti DENTRO il modale
                postTypeButtons.forEach(button => {
                    button.addEventListener('click', () => setPostType(button.dataset.postType));
                });

                // Listener che si attiva PRIMA che il modale si apra
                createPostModal.addEventListener('show.bs.modal', function (event) {
                    form.reset(); 
                    const triggerButton = event.relatedTarget;
                    const postTypeToSelect = triggerButton.getAttribute('data-post-type-select') || 'text';
                    setPostType(postTypeToSelect); 
                });
                
                // Inizializza Tribute.js (menzioni @utente) quando il modale √® visibile
                createPostModal.addEventListener('shown.bs.modal', function () {
                    const postTextarea = document.getElementById('postContentModal');
                    if (typeof Tribute !== 'undefined' && !postTextarea.hasAttribute('data-tribute-attached')) {
                        var tribute = new Tribute({
                            trigger: '@',
                            values: function(text, callback) {
                                fetch(`/api/search_users?q=${text}`)
                                    .then(response => response.json())
                                    .then(data => callback(data))
                                    .catch(error => callback([]));
                            },
                            menuItemTemplate: function(item) {
                                return `<img src="${item.original.avatar}" class="rounded-circle me-2" style="width: 25px; height: 25px; object-fit: cover;"> ${item.string}`;
                            },
                            selectClass: 'highlight',
                            noMatchTemplate: () => '<li class="no-match">Nessun utente trovato</li>'
                        });
                        tribute.attach(postTextarea);
                        postTextarea.setAttribute('data-tribute-attached', 'true');
                    }
                });
            }

            // ===============================================================
            // LOGICA PER ANIMAZIONE SEZIONE STATISTICHE
            // ===============================================================
            gsap.registerPlugin(ScrollTrigger);

            // 1. Anima le card facendole apparire
            const statCards = gsap.utils.toArray(".stat-card");
            if (statCards.length > 0) {
                gsap.from(statCards, {
                    scrollTrigger: {
                        trigger: ".stats-container",
                        start: "top 85%", // Inizia un po' prima
                        toggleActions: "play none none none"
                    },
                    opacity: 0,
                    y: 50,
                    stagger: 0.2,
                    duration: 0.8,
                    ease: "power2.out"
                });
            }

            // 2. Attiva il conteggio dei numeri
            ScrollTrigger.create({
                trigger: ".stats-container",
                start: "top 85%",
                onEnter: () => {
                    document.querySelectorAll('.stat-number').forEach(numberEl => {
                        // Aggiungiamo un controllo per non ri-animare
                        if (numberEl.dataset.animated !== 'true') { 
                            animateNumber(numberEl); 
                            numberEl.dataset.animated = 'true'; 
                        }
                    });
                },
                once: true // Esegue l'animazione solo una volta
            });
            
        });

        function animateNumber(element) {
            const goal = parseInt(element.dataset.goal);
            const duration = 2000; // Durata in millisecondi (2 secondi)
            const startTime = Date.now();

            function updateNumber() {
                const elapsedTime = Date.now() - startTime;
                if (elapsedTime > duration) {
                    // Alla fine, assicurati che il numero sia quello esatto e formattato
                    element.textContent = goal.toLocaleString('it-IT');
                } else {
                    // Calcola il valore corrente e aggiorna il testo
                    const value = Math.round((elapsedTime / duration) * goal);
                    element.textContent = value.toLocaleString('it-IT');
                    requestAnimationFrame(updateNumber); // Continua l'animazione
                }
            }
            requestAnimationFrame(updateNumber);
        }

        document.getElementById('statusFilter')?.addEventListener('change', function() {
            var selectedStatus = this.value;
            const currentUrl = new URL(window.location.href);
            const params = new URLSearchParams(currentUrl.search);
            params.set('status', selectedStatus);
            params.set('page', 1); // Resetta a pagina 1
            window.location.href = currentUrl.pathname + '?' + params.toString();
        });
    </script>
{% endblock %}