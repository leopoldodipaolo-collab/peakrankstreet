{% extends "index.html" %}

{% block title %}Dettaglio Attivit√†{% endblock %}

{% block content %}
    <!-- MODIFICATO: Aggiunto 'main.' al blueprint -->
    <a href="{{ url_for('main.all_activities') }}" class="btn btn-secondary mb-3">&larr; Tutte le Attivit√†</a>
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white">
            <h2 class="mb-0">Dettaglio Attivit√†</h2>
        </div>
        <div class="card-body">
            <!-- MODIFICATO: Aggiunto 'main.' al blueprint -->
            <p class="card-text"><strong>Atleta:</strong> <a href="{{ url_for('main.user_profile', user_id=user.id) }}" class="user-link text-primary">{{ user.username }}</a></p>
            
            <!-- ‚ö†Ô∏è CORREGGI: Controlla se route esiste -->
            <p class="card-text">
                <strong>Percorso:</strong> 
                {% if route %}
                    <!-- MODIFICATO: Aggiunto 'main.' al blueprint -->
                    <a href="{{ url_for('main.route_detail', route_id=route.id) }}" class="user-link text-success">{{ route.name }}</a>
                {% else %}
                    <span class="text-muted">Percorso Libero</span>
                {% endif %}
            </p>
            
            {% if challenge %}
                <!-- MODIFICATO: Aggiunto 'main.' al blueprint -->
                <p class="card-text"><strong>Sfida:</strong> <a href="{{ url_for('main.leaderboard', challenge_id=challenge.id) }}" class="user-link text-info">{{ challenge.name }}</a></p>
            {% endif %}
            
            <p class="card-text"><strong>Data Attivit√†:</strong> {{ activity.created_at.strftime('%d/%m/%Y %H:%M') }}</p>
            <p class="card-text"><strong>Distanza:</strong> {{ "%.2f"|format(activity.distance) }} km</p>
            <p class="card-text"><strong>Tempo:</strong>
                {% set hours = activity.duration // 3600 %}
                {% set minutes = (activity.duration % 3600) // 60 %}
                {% set seconds = activity.duration % 60 %}
                <strong>{{ "%02d:%02d:%02d"|format(hours, minutes, seconds) }}</strong>
            </p>
            <p class="card-text"><strong>Velocit√† Media:</strong> {{ "%.2f"|format(activity.avg_speed) }} km/h</p>

            <h3 class="mt-4">Tracciato GPS dell'Attivit√† e Percorso di Riferimento</h3>
            <div id="activityMap" style="height: 500px; width: 100%; border: 1px solid #ddd; border-radius: 5px;"></div>
            
            <!-- LEGENDA COMPLETA -->
            <div class="map-legend mt-3 p-3 border rounded">
                <div class="row">
                    <div class="col-md-6">
                        <div class="d-flex align-items-center mb-2">
                            <span class="d-inline-block" style="width: 20px; height: 8px; background-color: #007bff; margin-right: 8px;"></span>
                            <span>Tracciato Attivit√†</span>
                        </div>
                        {% if route %}
                        <div class="d-flex align-items-center mb-2">
                            <span class="d-inline-block" style="width: 20px; height: 8px; background-color: #FF7800; margin-right: 8px;"></span>
                            <span>Percorso di Riferimento</span>
                        </div>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex align-items-center mb-2">
                            <span class="d-inline-block" style="width: 16px; height: 16px; background-color: green; border-radius: 50%; border: 2px solid white; margin-right: 8px;"></span>
                            <span>Partenza</span>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <span class="d-inline-block" style="width: 16px; height: 16px; background-color: red; border-radius: 50%; border: 2px solid white; margin-right: 8px;"></span>
                            <span>Arrivo</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Inizializza la mappa
            var activityMap = L.map('activityMap').setView([41.9028, 12.4964], 6);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            }).addTo(activityMap);

            var allLayers = L.featureGroup();
            var hasAnyData = false;

            // CREA ICONE PERSONALIZZATE PER PARTENZA E ARRIVO
            var startIcon = L.divIcon({
                html: '<div style="background-color: green; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>',
                className: 'custom-div-icon',
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });

            var endIcon = L.divIcon({
                html: '<div style="background-color: red; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>',
                className: 'custom-div-icon',
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });

            // TRACCIATO ATTIVIT√Ä (PRINCIPALE)
            var activityGeoJSONData = {{ activity_geojson_data | safe if activity_geojson_data else 'null' }};
            if (activityGeoJSONData) {
                try {
                    var activityLayer = L.geoJSON(activityGeoJSONData, {
                        style: {
                            color: '#007bff',
                            weight: 5,
                            opacity: 0.9
                        }
                    });
                    allLayers.addLayer(activityLayer);
                    hasAnyData = true;
                    console.log("‚úÖ Tracciato attivit√† caricato");

                    // AGGIUNGI MARKER PARTENZA E ARRIVO
                    var coordinates = activityGeoJSONData.coordinates;
                    if (coordinates && coordinates.length > 0) {
                        // PRIMO PUNTO = PARTENZA (VERDE)
                        var startPoint = coordinates[0];
                        var startMarker = L.marker([startPoint[1], startPoint[0]], {icon: startIcon})
                            .bindPopup(`
                                <div class="text-center">
                                    <strong>üèÅ PARTENZA</strong><br>
                                    <small>Lat: ${startPoint[1].toFixed(6)}</small><br>
                                    <small>Lon: ${startPoint[0].toFixed(6)}</small>
                                </div>
                            `)
                            .addTo(activityMap);
                        
                        // ULTIMO PUNTO = ARRIVO (ROSSO)
                        var endPoint = coordinates[coordinates.length - 1];
                        var endMarker = L.marker([endPoint[1], endPoint[0]], {icon: endIcon})
                            .bindPopup(`
                                <div class="text-center">
                                    <strong>üéØ ARRIVO</strong><br>
                                    <small>Lat: ${endPoint[1].toFixed(6)}</small><br>
                                    <small>Lon: ${endPoint[0].toFixed(6)}</small>
                                </div>
                            `)
                            .addTo(activityMap);

                        console.log("‚úÖ Marker partenza e arrivo aggiunti");
                    }

                } catch (e) {
                    console.error("‚ùå Errore tracciato attivit√†:", e);
                }
            }

            // PERCORSO DI RIFERIMENTO (OPZIONALE)
            var routeGeoJSONData = {{ route_geojson_data | safe if route_geojson_data else 'null' }};
            if (routeGeoJSONData) {
                try {
                    var routeLayer = L.geoJSON(routeGeoJSONData, {
                        style: {
                            color: '#FF7800',
                            weight: 3,
                            opacity: 0.8,
                            dashArray: '5, 5'
                        }
                    });
                    allLayers.addLayer(routeLayer);
                    console.log("‚úÖ Percorso riferimento caricato");
                } catch (e) {
                    console.error("‚ùå Errore percorso riferimento:", e);
                }
            }

            // GESTIONE FINALE MAPPA
            if (hasAnyData) {
                allLayers.addTo(activityMap);
                activityMap.fitBounds(allLayers.getBounds().pad(0.1)); // Aggiungi un po' di padding
                console.log("‚úÖ Mappa centrata sui dati disponibili");
            } else {
                console.warn("‚ö†Ô∏è Nessun dato GeoJSON disponibile");
                
                // FALLBACK: Prova a creare il tracciato dai punti GPS grezzi
                {% if activity.gps_track %}
                    try {
                        var points = JSON.parse('{{ activity.gps_track | safe }}');
                        if (points && points.length > 0) {
                            var latlngs = points.map(function(p) {
                                return [p.lat, p.lon];
                            });
                            var polyline = L.polyline(latlngs, {
                                color: 'blue', 
                                weight: 5,
                                opacity: 0.9
                            }).addTo(activityMap);
                            
                            // Aggiungi marker partenza e arrivo anche per il fallback
                            var startPoint = latlngs[0];
                            var endPoint = latlngs[latlngs.length - 1];
                            
                            L.marker(startPoint, {icon: startIcon})
                                .bindPopup('<strong>üèÅ PARTENZA</strong>')
                                .addTo(activityMap);
                                
                            L.marker(endPoint, {icon: endIcon})
                                .bindPopup('<strong>üéØ ARRIVO</strong>')
                                .addTo(activityMap);
                            
                            activityMap.fitBounds(polyline.getBounds().pad(0.1));
                            console.log("‚úÖ Tracciato creato da punti GPS grezzi");
                        }
                    } catch (e) {
                        console.error("‚ùå Impossibile creare tracciato:", e);
                        activityMap.setView([45.4642, 9.1900], 13);
                        L.popup()
                            .setLatLng([45.4642, 9.1900])
                            .setContent("Impossibile visualizzare il tracciato GPS.")
                            .openOn(activityMap);
                    }
                {% else %}
                    activityMap.setView([45.4642, 9.1900], 13);
                    L.popup()
                        .setLatLng([45.4642, 9.1900])
                        .setContent("Nessun tracciato GPS disponibile per questa attivit√†.")
                        .openOn(activityMap);
                {% endif %}
            }

            // Aggiungi qualche stile CSS per migliorare l'aspetto
            var style = document.createElement('style');
            style.textContent = `
                .map-legend {
                    background-color: #f8f9fa;
                    font-size: 14px;
                }
                .custom-div-icon {
                    background: transparent !important;
                    border: none !important;
                }
            `;
            document.head.appendChild(style);
        });
    </script>
{% endblock %}