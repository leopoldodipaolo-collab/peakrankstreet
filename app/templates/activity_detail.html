{% extends "base.html" %}

{% block title %}Dettaglio Attività{% endblock %}

{% block styles %}
{{ super() }}
<style>
    /* ===== Marcatori Mappe ===== */
    .map-marker-icon {
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 0 10px rgba(0,0,0,0.4);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .map-marker-icon:hover {
        transform: scale(1.3);
        box-shadow: 0 0 15px rgba(0,0,0,0.6);
    }

    .start-marker {
        background: radial-gradient(circle, #28a745 0%, #218838 100%);
        animation: pulse 2s infinite;
    }

    .end-marker {
        background: radial-gradient(circle, #dc3545 0%, #b02a37 100%);
    }

    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(40,167,69,0.5); }
        70% { box-shadow: 0 0 0 15px rgba(40,167,69,0); }
        100% { box-shadow: 0 0 0 0 rgba(40,167,69,0); }
    }

    /* ===== Legenda ===== */
    .legend-marker, .legend-color-box {
        border-radius: 50%;
        display: inline-block;
        width: 14px;
        height: 14px;
        border: 1px solid #ccc;
        margin-right: 6px;
        vertical-align: middle;
    }

    .legend-marker.start-marker { background-color: #28a745; }
    .legend-marker.end-marker { background-color: #dc3545; }
    .legend-color-box.activity-track { background: linear-gradient(90deg, #0d6efd, #6610f2); }
    .legend-color-box.route-track { background-color: #FF7800; border-style: dashed; }

    /* ===== Tracciati Mappe ===== */
    .leaflet-overlay-pane svg path.glow {
        stroke: var(--bs-primary);
        stroke-width: 6;
        filter: drop-shadow(0 0 8px var(--bs-primary));
        transition: stroke-width 0.3s ease, filter 0.3s ease;
    }

    /* ===== Card e UI ===== */
    .card {
        border-radius: 1rem;
        overflow: hidden;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 25px rgba(0,0,0,0.15);
    }

    .card-header {
        background: linear-gradient(90deg, #0d6efd, #6610f2);
        color: white;
        font-weight: 500;
    }

    .card-title i {
        color: #0d6efd;
        transition: transform 0.3s ease;
    }

    .card-title i:hover {
        transform: rotate(15deg);
    }

    .display-4 {
        background: linear-gradient(to right, #0d6efd, #6610f2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-5 pt-5">
    <div class="mb-4">
        <a href="{{ url_for('main.all_activities') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-2"></i>Torna a Tutte le Attività
        </a>
    </div>

    <div class="row g-4">
        <!-- ===== Riepilogo ===== -->
        <div class="col-lg-4">
            <div class="card shadow-sm h-100 border-0">
                <div class="card-body d-flex flex-column">
                    <h4 class="card-title border-bottom pb-3 mb-3">
                        <i class="bi bi-clipboard-data-fill me-2 text-primary"></i>Riepilogo Attività
                    </h4>
                    <div class="row text-center mb-4">
                        <div class="col-12">
                            <h5 class="text-muted fw-light">Distanza Totale</h5>
                            <p class="display-4 fw-bold text-primary mb-0">{{ "%.2f"|format(activity.distance) }}</p>
                            <span class="text-muted">km</span>
                        </div>
                        <div class="col-6 mt-3">
                            <h6 class="text-muted fw-light">Durata</h6>
                            {% set hours = activity.duration // 3600 %}
                            {% set minutes = (activity.duration % 3600) // 60 %}
                            {% set seconds = activity.duration % 60 %}
                            <p class="h5 fw-semibold mb-0">{{ "%02d:%02d:%02d"|format(hours, minutes, seconds) }}</p>
                        </div>
                        <div class="col-6 mt-3">
                            <h6 class="text-muted fw-light">Vel. Media</h6>
                            <p class="h5 fw-semibold mb-0">{{ "%.2f"|format(activity.avg_speed) }} <span class="fw-light fs-6">km/h</span></p>
                        </div>
                    </div>
                    <div class="list-group list-group-flush mt-auto">
                        <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <span class="text-muted"><i class="bi bi-person-circle me-2"></i>Atleta</span>
                            <a href="{{ url_for('main.user_profile', user_id=user.id) }}" class="fw-bold text-decoration-none">{{ user.username }}</a>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <span class="text-muted"><i class="bi bi-calendar-event-fill me-2"></i>Data</span>
                            <span class="fw-bold">{{ activity.created_at.strftime('%d/%m/%Y %H:%M') }}</span>
                        </div>
                        {% if route %}
                        <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <span class="text-muted"><i class="bi bi-signpost-2-fill me-2"></i>Percorso</span>
                            <a href="{{ url_for('main.route_detail', route_id=route.id) }}" class="fw-bold text-decoration-none text-success">{{ route.name }}</a>
                        </div>
                        {% else %}
                        <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <span class="text-muted"><i class="bi bi-signpost-2-fill me-2"></i>Percorso</span>
                            <span class="text-muted fst-italic">Nessun percorso specifico</span>
                        </div>
                        {% endif %}
                        {% if challenge %}
                        <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <span class="text-muted"><i class="bi bi-trophy-fill me-2"></i>Sfida</span>
                            <a href="{{ url_for('main.leaderboard', challenge_id=challenge.id) }}" class="fw-bold text-decoration-none text-info">{{ challenge.name }}</a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- ===== Mappa ===== -->
        <div class="col-lg-8">
            <div class="card shadow-sm border-0">
                <div class="card-header">
                    <h5 class="mb-0 fw-normal"><i class="bi bi-map-fill me-2 text-white"></i>Tracciato GPS</h5>
                </div>
                <div class="map-container" id="activityMap" style="aspect-ratio:16/9; min-height:400px; background-color:#f8f9fa;"></div>
                <div class="card-footer bg-light">
                    <div class="d-flex flex-wrap justify-content-center align-items-center gap-3 small">
                        <div class="legend-item"><span class="legend-color-box activity-track"></span>Tracciato Attività</div>
                        {% if route %}
                        <div class="legend-item"><span class="legend-color-box route-track"></span>Percorso Riferimento</div>
                        {% endif %}
                        <div class="legend-item"><span class="legend-marker start-marker"></span>Partenza</div>
                        <div class="legend-item"><span class="legend-marker end-marker"></span>Arrivo</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// ===== Animazione tracciato progressivo =====
document.addEventListener('DOMContentLoaded', function() {
    const activityMap = L.map('activityMap').setView([41.9028,12.4964],6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors', maxZoom:19
    }).addTo(activityMap);

    const createPopupContent = (title, lat, lon) =>
        `<div><strong>${title}</strong><br><small>Lat:${lat.toFixed(5)}, Lon:${lon.toFixed(5)}</small></div>`;

    const allLayers = L.featureGroup();
    let hasData = false;

    const activityGeoJSONData = {{ activity_geojson_data|safe if activity_geojson_data else 'null' }};
    if(activityGeoJSONData && activityGeoJSONData.coordinates && activityGeoJSONData.coordinates.length>0){
        const coords = activityGeoJSONData.coordinates.map(c=>[c[1],c[0]]);
        const progressiveLine = L.polyline([], {color:'var(--bs-primary)', weight:5, opacity:0.9}).addTo(activityMap);
        const runner = L.circleMarker(coords[0], {radius:6, color:'#ff0000', fillColor:'#ff0000', fillOpacity:1}).addTo(activityMap);

        let idx = 0;
        const step = 5;
        const interval = setInterval(()=>{
            if(idx>=coords.length){ clearInterval(interval); return; }
            progressiveLine.setLatLngs(coords.slice(0, idx+1));
            runner.setLatLng(coords[idx]);
            idx += step;
        },15);

        // ===== START / END con icone Bootstrap =====
        const startIcon = L.divIcon({
            html: '<i class="bi bi-flag-fill text-success fs-3"></i>',
            className: '',
            iconSize: [24,24],
            iconAnchor: [12,24],
            popupAnchor: [0,-24]
        });

        const endIcon = L.divIcon({
            html: '<i class="bi bi-flag-fill text-danger fs-3"></i>',
            className: '',
            iconSize: [24,24],
            iconAnchor: [12,24],
            popupAnchor: [0,-24]
        });

        L.marker(coords[0], {icon: startIcon}).bindPopup(createPopupContent('Partenza', coords[0][0], coords[0][1])).addTo(allLayers);
        L.marker(coords[coords.length-1], {icon: endIcon}).bindPopup(createPopupContent('Arrivo', coords[coords.length-1][0], coords[coords.length-1][1])).addTo(allLayers);

        hasData = true;
    }

    const routeGeoJSONData = {{ route_geojson_data|safe if route_geojson_data else 'null' }};
    if(routeGeoJSONData){
        const routeLayer = L.geoJSON(routeGeoJSONData, {style:{color:'#FF7800', weight:4, opacity:0.8, dashArray:'5,10'}});
        allLayers.addLayer(routeLayer);
        hasData = true;
    }

    if(hasData){
        allLayers.addTo(activityMap);
        activityMap.flyToBounds(allLayers.getBounds().pad(0.1), {duration:2});
    } else {
        document.getElementById('activityMap').innerHTML = `
        <div class="d-flex justify-content-center align-items-center h-100 text-center text-muted">
            <div><i class="bi bi-geo-alt-fill" style="font-size:3rem"></i>
            <p class="mt-2">Nessun tracciato GPS disponibile per questa attività.</p></div>
        </div>`;
    }
});

</script>
{% endblock %}