{% extends "index.html" %}

{% block title %}Dettaglio Attivit√†{% endblock %}

{% block content %}
<div class="container my-5">
    <a href="{{ url_for('main.all_activities') }}" class="btn btn-secondary mb-4">&larr; Torna a Tutte le Attivit√†</a>

    <div class="row">
        <!-- COLONNA SINISTRA: Dati e Statistiche -->
        <div class="col-lg-4">
            
            <!-- Card Dettagli Principali (NUOVO STILE) -->
            <div class="card detail-card shadow-sm mb-4">
                <div class="card-body">
                    <h4 class="card-title-icon"><i class="bi bi-info-circle-fill me-2"></i>Dettagli Attivit√†</h4>
                    <hr>
                    <div class="list-group list-group-flush">
                        <div class="list-group-item d-flex align-items-center px-0">
                            <i class="bi bi-person-circle fs-4 me-3 text-muted"></i>
                            <div>
                                <small class="text-muted">Atleta</small>
                                <p class="mb-0 fw-bold">
                                    <a href="{{ url_for('main.user_profile', user_id=user.id) }}" class="user-link text-primary">{{ user.username }}</a>
                                </p>
                            </div>
                        </div>
                        <div class="list-group-item d-flex align-items-center px-0">
                            <i class="bi bi-signpost-2-fill fs-4 me-3 text-muted"></i>
                            <div>
                                <small class="text-muted">Percorso</small>
                                <p class="mb-0 fw-bold">
                                    {% if route %}
                                        <a href="{{ url_for('main.route_detail', route_id=route.id) }}" class="user-link text-success">{{ route.name }}</a>
                                    {% else %}
                                        <span class="text-muted">Percorso Libero</span>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        {% if challenge %}
                        <div class="list-group-item d-flex align-items-center px-0">
                            <i class="bi bi-trophy-fill fs-4 me-3 text-muted"></i>
                            <div>
                                <small class="text-muted">Sfida</small>
                                <p class="mb-0 fw-bold">
                                    <a href="{{ url_for('main.leaderboard', challenge_id=challenge.id) }}" class="user-link text-info">{{ challenge.name }}</a>
                                </p>
                            </div>
                        </div>
                        {% endif %}
                        <div class="list-group-item d-flex align-items-center px-0">
                            <i class="bi bi-calendar-event-fill fs-4 me-3 text-muted"></i>
                            <div>
                                <small class="text-muted">Data</small>
                                <p class="mb-0 fw-bold">{{ activity.created_at.strftime('%d/%m/%Y %H:%M') }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card Statistiche (NUOVO STILE) -->
            <div class="card detail-card shadow-sm">
                <div class="card-body">
                    <h4 class="card-title-icon"><i class="bi bi-bar-chart-line-fill me-2"></i>Statistiche</h4>
                    <hr>
                    <div class="row text-center">
                        <div class="col-12 stat-highlight mb-3">
                            <i class="bi bi-geo-alt-fill text-primary"></i>
                            <div class="stat-value">{{ "%.2f"|format(activity.distance) }}</div>
                            <div class="stat-label">Distanza (km)</div>
                        </div>
                        <div class="col-6">
                            <i class="bi bi-clock-fill text-primary"></i>
                            {% set hours = activity.duration // 3600 %}
                            {% set minutes = (activity.duration % 3600) // 60 %}
                            {% set seconds = activity.duration % 60 %}
                            <div class="stat-value-small">{{ "%02d:%02d:%02d"|format(hours, minutes, seconds) }}</div>
                            <div class="stat-label">Tempo</div>
                        </div>
                        <div class="col-6">
                            <i class="bi bi-speedometer2 text-primary"></i>
                            <div class="stat-value-small">{{ "%.2f"|format(activity.avg_speed) }}</div>
                            <div class="stat-label">Vel. Media (km/h)</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- COLONNA DESTRA: Mappa -->
        <div class="col-lg-8 mt-4 mt-lg-0">
            <div class="card shadow-sm map-card-custom">
                <div class="card-header bg-white"> <!-- Header pi√π leggero -->
                    <h5 class="mb-0 text-dark"><i class="bi bi-map-fill me-2"></i>Tracciato GPS</h5>
                </div>
                <div class="map-container" id="activityMap"></div>
                <div class="card-footer map-legend">
                    <div class="d-flex flex-wrap justify-content-center gap-3">
                        <div class="legend-item"><span class="legend-color-box activity-track"></span>Tracciato Attivit√†</div>
                        {% if route %}
                        <div class="legend-item"><span class="legend-color-box route-track"></span>Percorso di Riferimento</div>
                        {% endif %}
                        <div class="legend-item"><span class="legend-marker start-marker"></span>Partenza</div>
                        <div class="legend-item"><span class="legend-marker end-marker"></span>Arrivo</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <!-- Il blocco script rimane invariato, non c'√® bisogno di copiarlo di nuovo se √® lo stesso della risposta precedente -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var activityMap = L.map('activityMap').setView([41.9028, 12.4964], 6);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            }).addTo(activityMap);

            var allLayers = L.featureGroup();
            var hasAnyData = false;
            
            var startIcon = L.divIcon({
                className: 'map-marker-icon start-marker',
                iconSize: [20, 20], 
                iconAnchor: [10, 10]
            });
            var endIcon = L.divIcon({
                className: 'map-marker-icon end-marker',
                iconSize: [20, 20], 
                iconAnchor: [10, 10]
            });

            function createPopupContent(title, lat, lon) {
                return `<div class="map-popup"><strong>${title}</strong><hr><small>Lat: ${lat.toFixed(6)}<br>Lon: ${lon.toFixed(6)}</small></div>`;
            }

            var activityGeoJSONData = {{ activity_geojson_data | safe if activity_geojson_data else 'null' }};
            if (activityGeoJSONData) {
                var activityLayer = L.geoJSON(activityGeoJSONData, {
                    style: { color: 'var(--bs-primary)', weight: 5, opacity: 0.9 }
                });
                allLayers.addLayer(activityLayer);
                hasAnyData = true;

                var coordinates = activityGeoJSONData.coordinates;
                if (coordinates && coordinates.length > 0) {
                    var startPoint = coordinates[0];
                    L.marker([startPoint[1], startPoint[0]], {icon: startIcon})
                        .bindPopup(createPopupContent('üèÅ Partenza', startPoint[1], startPoint[0]))
                        .addTo(allLayers);
                    
                    var endPoint = coordinates[coordinates.length - 1];
                    L.marker([endPoint[1], endPoint[0]], {icon: endIcon})
                        .bindPopup(createPopupContent('üéØ Arrivo', endPoint[1], endPoint[0]))
                        .addTo(allLayers);
                }
            }

            var routeGeoJSONData = {{ route_geojson_data | safe if route_geojson_data else 'null' }};
            if (routeGeoJSONData) {
                var routeLayer = L.geoJSON(routeGeoJSONData, {
                    style: { color: '#FF7800', weight: 4, opacity: 0.8, dashArray: '5, 10' }
                });
                allLayers.addLayer(routeLayer);
                hasAnyData = true;
            }

            if (hasAnyData) {
                allLayers.addTo(activityMap);
                activityMap.fitBounds(allLayers.getBounds().pad(0.1));
            } else {
                activityMap.setView([45.4642, 9.1900], 13);
                L.popup().setLatLng([45.4642, 9.1900]).setContent("Nessun tracciato GPS per questa attivit√†.").openOn(activityMap);
            }
        });
    </script>
{% endblock %}