{% extends "base.html" %}

{% block title %}Sfide Terminate - Archivio Storico{% endblock %}

{% block content %}
<div class="container-fluid px-md-4 py-5 mt-4">
    <!-- Header Hero -->
    <div class="row align-items-center mb-4">
        <div class="col-md-8">
            <div class="d-flex align-items-center mb-2">
                <div>
                    <h1 class="h2 fw-bold text-dark mb-1">üèÜ Archivio Sfide</h1>
                    <p class="text-muted mb-0">Rivivi le competizioni concluse e scopri i vincitori.</p>
                </div>
            </div>
        </div>
        <div class="col-md-4 text-md-end mt-3 mt-md-0">
            <a href="{{ url_for('main.challenges_list') }}" class="btn btn-primary">
                <i class="bi bi-lightning-fill me-1"></i>Vedi Sfide Attive
            </a>
        </div>
    </div>

    <!-- Filtri e Statistiche -->
    <div class="card bg-light border-0 rounded-3 mb-4">
        <div class="card-body py-3">
            <div class="row align-items-center">
                <div class="col-md-8 mb-2 mb-md-0">
                    <div class="input-group">
                        <span class="input-group-text bg-white border-0"><i class="bi bi-search text-muted"></i></span>
                        <input type="text" id="search-challenges" class="form-control border-0" placeholder="Cerca una sfida per nome...">
                    </div>
                </div>
                <div class="col-md-4 text-md-end">
                    <small class="text-muted">Mostrando <span id="challenges-count">{{ challenges_with_winners|length }}</span> sfide</small>
                </div>
            </div>
        </div>
    </div>

    {% if challenges_with_winners %}
        <!-- Grid Sfide -->
        <div class="row" id="challenges-grid">
            {% for item in challenges_with_winners %}
            {% set challenge = item.challenge %}
            {% set winner = item.winner %}

            <div class="col-xl-4 col-lg-6 mb-4 challenge-card" data-challenge-name="{{ challenge.name|lower }}">
                <div class="card h-100 shadow-sm border-0 rounded-4">
                    <!-- Header -->
                    <div class="card-header position-relative overflow-hidden border-0 rounded-top-4 py-3 bg-dark text-white">
                        <h5 class="card-title fw-bold mb-1 text-truncate">{{ challenge.name }}</h5>
                        <small class="text-white-50"><i class="bi bi-calendar-check me-1"></i>Conclusa il {{ challenge.end_date.strftime('%d %b %Y') }}</small>
                    </div>

                    <div class="card-body d-flex flex-column">
                        <!-- Info percorso -->
                        <p class="text-muted small mb-3">
                            Su percorso: <a href="{{ url_for('main.route_detail', route_id=challenge.route_info.id) }}">{{ challenge.route_info.name }}</a>
                        </p>

                        <!-- VINCITORE -->
                        <div class="winner-section mb-auto">
                            <div class="bg-warning bg-opacity-25 rounded-3 p-3 text-center">
                                <h6 class="fw-bold text-dark mb-2">üèÜ Vincitore</h6>
                                {% if winner %}
                                    <div class="d-flex align-items-center justify-content-center">
                                        <img src="{{ url_for('main.uploaded_file', filename='profile_pics/' + winner.profile_image) }}" 
                                             class="rounded-circle me-2" width="40" height="40" alt="{{ winner.username }}">
                                        <div class="text-start">
                                            <div class="fw-bold text-dark">{{ winner.username }}</div>
                                            {% set winner_activity = challenge.activities.filter_by(user_id=winner.id).order_by(Activity.duration.asc()).first() %}
                                            {% if winner_activity %}
                                            <small class="text-muted">Tempo: <strong>{{ (winner_activity.duration // 60)|int }}:{{ "%02d"|format(winner_activity.duration % 60) }} min</strong></small>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% else %}
                                    <small class="text-muted">Nessun vincitore</small>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Footer Azioni -->
                    <div class="card-footer bg-light border-0 rounded-bottom-4">
                        <div class="d-grid">
                            <a href="{{ url_for('main.leaderboard', challenge_id=challenge.id) }}" class="btn btn-outline-secondary w-100">
                                <i class="bi bi-bar-chart-line-fill me-1"></i>Vedi Classifica
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Paginazione -->
        {% if pagination and pagination.pages > 1 %}
        <nav class="mt-4" aria-label="Navigazione sfide terminate">
            <ul class="pagination justify-content-center">
                <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('main.finished_challenges', page=pagination.prev_num) }}">&laquo;</a>
                </li>
                {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                    {% if page_num %}
                        <li class="page-item {% if pagination.page == page_num %}active{% endif %}">
                            <a class="page-link" href="{{ url_for('main.finished_challenges', page=page_num) }}">{{ page_num }}</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled"><span class="page-link">...</span></li>
                    {% endif %}
                {% endfor %}
                <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('main.finished_challenges', page=pagination.next_num) }}">&raquo;</a>
                </li>
            </ul>
        </nav>
        {% endif %}

    {% else %}
        <!-- Stato Vuoto -->
        <div class="text-center py-5">
            <h3 class="text-dark mb-3">Archivio Vuoto</h3>
            <p class="text-muted">Le sfide che hai completato o che sono scadute appariranno qui.</p>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('search-challenges');
        const challengeCards = document.querySelectorAll('.challenge-card');
        const countSpan = document.getElementById('challenges-count');

        if (searchInput) {
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase().trim();
                let visibleCount = 0;
                
                challengeCards.forEach(card => {
                    const challengeName = card.dataset.challengeName;
                    const isVisible = searchTerm === '' || challengeName.includes(searchTerm);
                    card.style.display = isVisible ? 'block' : 'none';
                    if (isVisible) {
                        visibleCount++;
                    }
                });
                countSpan.textContent = visibleCount;
            });
        }
    });
    </script>
{% endblock %}